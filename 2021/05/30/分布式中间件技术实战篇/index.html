<!DOCTYPE html>
<html lang="zh-CH">





<head>
  <meta charset="UTF-8">
  <link rel="apple-touch-icon" sizes="76x76" href="/img/favicon.png">
  <link rel="icon" type="image/png" href="/img/favicon.png">
  <meta name="viewport"
        content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, shrink-to-fit=no">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  
  <meta name="theme-color" content="#2f4154">
  <meta name="description" content="光说不做假把式">
  <meta name="author" content="杨玉杰">
  <meta name="keywords" content="">
  <title>分布式中间件技术实战篇 - 杨玉杰|个人博客</title>

  <link  rel="stylesheet" href="https://cdn.staticfile.org/twitter-bootstrap/4.4.1/css/bootstrap.min.css" />


  <link  rel="stylesheet" href="https://cdn.staticfile.org/github-markdown-css/4.0.0/github-markdown.min.css" />
  <link  rel="stylesheet" href="/lib/hint/hint.min.css" />

  
    <link  rel="stylesheet" href="https://cdn.staticfile.org/highlight.js/10.0.0/styles/agate.min.css" />
  

  


<!-- 主题依赖的图标库，不要自行修改 -->

<link rel="stylesheet" href="//at.alicdn.com/t/font_1749284_yg9cfy8wd6.css">



<link rel="stylesheet" href="//at.alicdn.com/t/font_1736178_pjno9b9zyxs.css">


<link  rel="stylesheet" href="/css/main.css" />

<!-- 自定义样式保持在最底部 -->


<meta name="generator" content="Hexo 4.2.1"></head>


<body>
  <header style="height: 70vh;">
    <nav id="navbar" class="navbar fixed-top  navbar-expand-lg navbar-dark scrolling-navbar">
  <div class="container">
    <a class="navbar-brand"
       href="/">&nbsp;<strong>杨玉杰|个人博客</strong>&nbsp;</a>

    <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse"
            data-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <div class="animated-icon"><span></span><span></span><span></span></div>
    </button>

    <!-- Collapsible content -->
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav ml-auto text-center">
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/">
                <i class="iconfont icon-home-fill"></i>
                主页
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/archives/">
                <i class="iconfont icon-archive-fill"></i>
                归档
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/categories/">
                <i class="iconfont icon-category-fill"></i>
                分类
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/tags/">
                <i class="iconfont icon-tags-fill"></i>
                标签
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/about/">
                <i class="iconfont icon-user-fill"></i>
                关于
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/links/">
                <i class="iconfont icon-link-fill"></i>
                友情链接
              </a>
            </li>
          
        
        
          <li class="nav-item" id="search-btn">
            <a class="nav-link" data-toggle="modal" data-target="#modalSearch">&nbsp;&nbsp;<i
                class="iconfont icon-search"></i>&nbsp;&nbsp;</a>
          </li>
        
      </ul>
    </div>
  </div>
</nav>

    <div class="view intro-2" id="background" parallax=true
         style="background: url('/img/bgi.png') no-repeat center center;
           background-size: cover;">
      <div class="full-bg-img">
        <div class="mask flex-center" style="background-color: rgba(0, 0, 0, 0.3)">
          <div class="container text-center white-text fadeInUp">
            <span class="h2" id="subtitle">
              
            </span>

            
              
  <div class="mt-3 post-meta">
    <i class="iconfont icon-date-fill" aria-hidden="true"></i>
    <time datetime="2021-05-30 10:08">
      May 30, 2021 am
    </time>
  </div>


<div class="mt-1">
  
    
    <span class="post-meta mr-2">
      <i class="iconfont icon-chart"></i>
      33.3k 字
    </span>
  

  
    
    <span class="post-meta mr-2">
      <i class="iconfont icon-clock-fill"></i>
      
      
      490
       分钟
    </span>
  

  
  
</div>

            
          </div>

          
        </div>
      </div>
    </div>
  </header>

  <main>
    
      

<div class="container-fluid">
  <div class="row">
    <div class="d-none d-lg-block col-lg-2"></div>
    <div class="col-lg-8 nopadding-md">
      <div class="container nopadding-md" id="board-ctn">
        <div class="py-5" id="board">
          <div class="post-content mx-auto" id="post">
            
            <article class="markdown-body">
              <h1 id="第1章：走进分布式中间件"><a href="#第1章：走进分布式中间件" class="headerlink" title="第1章：走进分布式中间件"></a>第1章：走进分布式中间件</h1><p>分布式概念：多个程序运行在不同的机器上，共同完成一个功能，而用户感知不到集群的存在。</p>
<p> 发展历程：</p>
<p>1、单点集中式Web应用–数据库、War包以及文件等都在同一个机器上</p>
<p>2、应用与文件服务及数据库单独拆分</p>
<p>3、引入缓存与集群–Redis、Nginx+Lvs，多台应用服务器构成负载均衡</p>
<p>4、数据库读写分离，并提供反向代理及CDN加速访问服务–抢票高峰，静态资源放到CDN中，加入反向代理的配置，减少访问网站时直接去服务器读取静态数据</p>
<p>5、分布式文件系统与分布式数据库–减少DB的压力，进行分库分表，根据业务来拆分数据库</p>
<h1 id="第2章：搭建微服务项目"><a href="#第2章：搭建微服务项目" class="headerlink" title="第2章：搭建微服务项目"></a>第2章：搭建微服务项目</h1><p>Spring Boot项目搭建规范：</p>
<p><img src="https://gitee.com/yang_yu_jie/blog-img/raw/master/img/20210530100950.png" srcset="/img/loading.gif" alt="在这里插入图片描述"></p>
<p>依赖层级关系：server依赖model，model依赖api</p>
<p>Spring Boot项目搭建流程：</p>
<ol>
<li><p>File-New Project</p>
</li>
<li><p>Maven-选择SDK-Next</p>
</li>
<li><p>GroupId为包名，ArtifactId为项目名称</p>
</li>
<li><p>选择路径，不要出现中文或特殊符号路径</p>
</li>
<li><p>pom.xml文件：父模块的依赖配置文件，指定项目资源的编码以及JDK版本</p>
<div class="hljs"><pre><code class="hljs xml"><span class="hljs-meta">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">project</span> <span class="hljs-attr">xmlns</span>=<span class="hljs-string">"http://maven.apache.org/POM/4.0.0"</span></span>
<span class="hljs-tag">         <span class="hljs-attr">xmlns:xsi</span>=<span class="hljs-string">"http://www.w3.org/2001/XMLSchema-instance"</span></span>
<span class="hljs-tag">         <span class="hljs-attr">xsi:schemaLocation</span>=<span class="hljs-string">"http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">modelVersion</span>&gt;</span>4.0.0<span class="hljs-tag">&lt;/<span class="hljs-name">modelVersion</span>&gt;</span>

    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.debug.middleware<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>middleware<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">packaging</span>&gt;</span>pom<span class="hljs-tag">&lt;/<span class="hljs-name">packaging</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>1.0.1<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">modules</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">module</span>&gt;</span>api<span class="hljs-tag">&lt;/<span class="hljs-name">module</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">module</span>&gt;</span>model<span class="hljs-tag">&lt;/<span class="hljs-name">module</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">module</span>&gt;</span>server<span class="hljs-tag">&lt;/<span class="hljs-name">module</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">modules</span>&gt;</span>

    <span class="hljs-tag">&lt;<span class="hljs-name">properties</span>&gt;</span>
        <span class="hljs-comment">&lt;!--定义项目整体资源的编码为UTF-8，JDK的版本为1.8--&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">project.build.sourceEncoding</span>&gt;</span>UTF-8<span class="hljs-tag">&lt;/<span class="hljs-name">project.build.sourceEncoding</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">java.version</span>&gt;</span>1.8<span class="hljs-tag">&lt;/<span class="hljs-name">java.version</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">maven.compiler.source</span>&gt;</span>$&#123;java.version&#125;<span class="hljs-tag">&lt;/<span class="hljs-name">maven.compiler.source</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">maven.compiler.target</span>&gt;</span>$&#123;java.version&#125;<span class="hljs-tag">&lt;/<span class="hljs-name">maven.compiler.target</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">properties</span>&gt;</span>

<span class="hljs-tag">&lt;/<span class="hljs-name">project</span>&gt;</span></code></pre></div>
</li>
<li><p>创建子模块api以及相关依赖配置（整个项目都共用的依赖配置）</p>
<div class="hljs"><pre><code class="hljs xml"><span class="hljs-meta">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">project</span> <span class="hljs-attr">xmlns</span>=<span class="hljs-string">"http://maven.apache.org/POM/4.0.0"</span></span>
<span class="hljs-tag">         <span class="hljs-attr">xmlns:xsi</span>=<span class="hljs-string">"http://www.w3.org/2001/XMLSchema-instance"</span></span>
<span class="hljs-tag">         <span class="hljs-attr">xsi:schemaLocation</span>=<span class="hljs-string">"http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">parent</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>middleware<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.debug.middleware<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>1.0.1<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">parent</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">modelVersion</span>&gt;</span>4.0.0<span class="hljs-tag">&lt;/<span class="hljs-name">modelVersion</span>&gt;</span>

    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>api<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>

    <span class="hljs-tag">&lt;<span class="hljs-name">properties</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">lombok.version</span>&gt;</span>1.16.10<span class="hljs-tag">&lt;/<span class="hljs-name">lombok.version</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">jackson-annotations-version</span>&gt;</span>2.6.5<span class="hljs-tag">&lt;/<span class="hljs-name">jackson-annotations-version</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">properties</span>&gt;</span>

    <span class="hljs-tag">&lt;<span class="hljs-name">dependencies</span>&gt;</span>
        <span class="hljs-comment">&lt;!--Lombok--&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.projectlombok<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>lombok<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>$&#123;lombok.version&#125;<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>

        <span class="hljs-comment">&lt;!--jackson--&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.fasterxml.jackson.core<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>jackson-annotations<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>$&#123;jackson-annotations-version&#125;<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">scope</span>&gt;</span>compile<span class="hljs-tag">&lt;/<span class="hljs-name">scope</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">dependencies</span>&gt;</span>

<span class="hljs-tag">&lt;/<span class="hljs-name">project</span>&gt;</span></code></pre></div>
</li>
<li><p>创建子模块model，添加api子模块以及Spring-MyBatis依赖</p>
<div class="hljs"><pre><code class="hljs xml"><span class="hljs-meta">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">project</span> <span class="hljs-attr">xmlns</span>=<span class="hljs-string">"http://maven.apache.org/POM/4.0.0"</span></span>
<span class="hljs-tag">         <span class="hljs-attr">xmlns:xsi</span>=<span class="hljs-string">"http://www.w3.org/2001/XMLSchema-instance"</span></span>
<span class="hljs-tag">         <span class="hljs-attr">xsi:schemaLocation</span>=<span class="hljs-string">"http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">parent</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>middleware<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.debug.middleware<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>1.0.1<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">parent</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">modelVersion</span>&gt;</span>4.0.0<span class="hljs-tag">&lt;/<span class="hljs-name">modelVersion</span>&gt;</span>

    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>model<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>

    <span class="hljs-tag">&lt;<span class="hljs-name">properties</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">mybatis-spring-boot.version</span>&gt;</span>1.1.1<span class="hljs-tag">&lt;/<span class="hljs-name">mybatis-spring-boot.version</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">mybatis-pagehelper.version</span>&gt;</span>4.1.2<span class="hljs-tag">&lt;/<span class="hljs-name">mybatis-pagehelper.version</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">properties</span>&gt;</span>

    <span class="hljs-tag">&lt;<span class="hljs-name">dependencies</span>&gt;</span>
        <span class="hljs-comment">&lt;!--api--&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.debug.middleware<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>api<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>$&#123;project.parent.version&#125;<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>

        <span class="hljs-comment">&lt;!--spring-mybatis--&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.mybatis.spring.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>mybatis-spring-boot-starter<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>$&#123;mybatis-spring-boot.version&#125;<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">dependencies</span>&gt;</span>

<span class="hljs-tag">&lt;/<span class="hljs-name">project</span>&gt;</span></code></pre></div>
</li>
<li><p>创建子模块server，添加Spring Boot依赖，日志log4j及MySQL，Druid等依赖</p>
<div class="hljs"><pre><code class="hljs xml"><span class="hljs-meta">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">project</span> <span class="hljs-attr">xmlns</span>=<span class="hljs-string">"http://maven.apache.org/POM/4.0.0"</span></span>
<span class="hljs-tag">         <span class="hljs-attr">xmlns:xsi</span>=<span class="hljs-string">"http://www.w3.org/2001/XMLSchema-instance"</span></span>
<span class="hljs-tag">         <span class="hljs-attr">xsi:schemaLocation</span>=<span class="hljs-string">"http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">parent</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>middleware<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.debug.middleware<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>1.0.1<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">parent</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">modelVersion</span>&gt;</span>4.0.0<span class="hljs-tag">&lt;/<span class="hljs-name">modelVersion</span>&gt;</span>

    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>server<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>

    <span class="hljs-tag">&lt;<span class="hljs-name">packaging</span>&gt;</span>jar<span class="hljs-tag">&lt;/<span class="hljs-name">packaging</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">properties</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">start-class</span>&gt;</span>com.debug.middleware.server.MainApplication<span class="hljs-tag">&lt;/<span class="hljs-name">start-class</span>&gt;</span>

        <span class="hljs-tag">&lt;<span class="hljs-name">spring-boot.version</span>&gt;</span>1.5.6.RELEASE<span class="hljs-tag">&lt;/<span class="hljs-name">spring-boot.version</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">spring-session.version</span>&gt;</span>1.2.0.RELEASE<span class="hljs-tag">&lt;/<span class="hljs-name">spring-session.version</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">mysql.version</span>&gt;</span>5.1.37<span class="hljs-tag">&lt;/<span class="hljs-name">mysql.version</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">druid.version</span>&gt;</span>1.0.16<span class="hljs-tag">&lt;/<span class="hljs-name">druid.version</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">guava.version</span>&gt;</span>19.0<span class="hljs-tag">&lt;/<span class="hljs-name">guava.version</span>&gt;</span>

        <span class="hljs-tag">&lt;<span class="hljs-name">skipTests</span>&gt;</span>true<span class="hljs-tag">&lt;/<span class="hljs-name">skipTests</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">properties</span>&gt;</span>

    <span class="hljs-comment">&lt;!-- 依赖管理 --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">dependencyManagement</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">dependencies</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-dependencies<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>$&#123;spring-boot.version&#125;<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">type</span>&gt;</span>pom<span class="hljs-tag">&lt;/<span class="hljs-name">type</span>&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">scope</span>&gt;</span>import<span class="hljs-tag">&lt;/<span class="hljs-name">scope</span>&gt;</span>
            <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">dependencies</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">dependencyManagement</span>&gt;</span>


    <span class="hljs-tag">&lt;<span class="hljs-name">dependencies</span>&gt;</span>
        <span class="hljs-comment">&lt;!--日志--&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-starter-log4j<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>1.3.3.RELEASE<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>

        <span class="hljs-comment">&lt;!--model--&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.debug.middleware<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>model<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>$&#123;project.parent.version&#125;<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>

        <span class="hljs-comment">&lt;!--guava--&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.google.guava<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>guava<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>$&#123;guava.version&#125;<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>

        <span class="hljs-comment">&lt;!--mysql--&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>mysql<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>mysql-connector-java<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>$&#123;mysql.version&#125;<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>

        <span class="hljs-comment">&lt;!--druid--&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.alibaba<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>druid<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>$&#123;druid.version&#125;<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>

        <span class="hljs-comment">&lt;!--spring--&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>$&#123;spring-boot.version&#125;<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">exclusions</span>&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">exclusion</span>&gt;</span>
                    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>ch.qos.logback<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
                    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>logback-classic<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
                <span class="hljs-tag">&lt;/<span class="hljs-name">exclusion</span>&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">exclusion</span>&gt;</span>
                    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.slf4j<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
                    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>log4j-over-slf4j<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
                <span class="hljs-tag">&lt;/<span class="hljs-name">exclusion</span>&gt;</span>
            <span class="hljs-tag">&lt;/<span class="hljs-name">exclusions</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>

        <span class="hljs-comment">&lt;!-- redis --&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-starter-redis<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>1.3.3.RELEASE<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>

        <span class="hljs-comment">&lt;!--rabbitmq--&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-starter-amqp<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>1.3.3.RELEASE<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>

        <span class="hljs-comment">&lt;!--zookeeper--&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.apache.zookeeper<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>zookeeper<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>3.4.6<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">exclusions</span>&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">exclusion</span>&gt;</span>
                    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>slf4j-log4j12<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
                    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.slf4j<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
                <span class="hljs-tag">&lt;/<span class="hljs-name">exclusion</span>&gt;</span>
            <span class="hljs-tag">&lt;/<span class="hljs-name">exclusions</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.apache.curator<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>curator-framework<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>2.10.0<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.apache.curator<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>curator-recipes<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>2.10.0<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>


        <span class="hljs-comment">&lt;!--redisson--&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.redisson<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>redisson<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>3.10.6<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>

        <span class="hljs-comment">&lt;!--由于redisson底层是采用基于nio的netty框架进行通信，故而需要加入依赖--&gt;</span>
        <span class="hljs-comment">&lt;!--&lt;dependency&gt;</span>
<span class="hljs-comment">            &lt;groupId&gt;io.netty&lt;/groupId&gt;</span>
<span class="hljs-comment">            &lt;artifactId&gt;netty-all&lt;/artifactId&gt;</span>
<span class="hljs-comment">            &lt;version&gt;4.1.32.Final&lt;/version&gt;</span>
<span class="hljs-comment">        &lt;/dependency&gt;--&gt;</span>

        <span class="hljs-comment">&lt;!--for test--&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-starter-test<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
            <span class="hljs-comment">&lt;!--&lt;scope&gt;test&lt;/scope&gt;--&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">dependencies</span>&gt;</span>

    <span class="hljs-tag">&lt;<span class="hljs-name">build</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">finalName</span>&gt;</span>book_middleware_$&#123;project.parent.version&#125;<span class="hljs-tag">&lt;/<span class="hljs-name">finalName</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">plugins</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">plugin</span>&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-maven-plugin<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>$&#123;spring-boot.version&#125;<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">executions</span>&gt;</span>
                    <span class="hljs-tag">&lt;<span class="hljs-name">execution</span>&gt;</span>
                        <span class="hljs-tag">&lt;<span class="hljs-name">goals</span>&gt;</span>
                            <span class="hljs-tag">&lt;<span class="hljs-name">goal</span>&gt;</span>repackage<span class="hljs-tag">&lt;/<span class="hljs-name">goal</span>&gt;</span>
                        <span class="hljs-tag">&lt;/<span class="hljs-name">goals</span>&gt;</span>
                    <span class="hljs-tag">&lt;/<span class="hljs-name">execution</span>&gt;</span>
                <span class="hljs-tag">&lt;/<span class="hljs-name">executions</span>&gt;</span>
            <span class="hljs-tag">&lt;/<span class="hljs-name">plugin</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">plugin</span>&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.apache.maven.plugins<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>maven-war-plugin<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>2.4<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">configuration</span>&gt;</span>
                    <span class="hljs-tag">&lt;<span class="hljs-name">failOnMissingWebXml</span>&gt;</span>false<span class="hljs-tag">&lt;/<span class="hljs-name">failOnMissingWebXml</span>&gt;</span>
                <span class="hljs-tag">&lt;/<span class="hljs-name">configuration</span>&gt;</span>
            <span class="hljs-tag">&lt;/<span class="hljs-name">plugin</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">plugins</span>&gt;</span>

        <span class="hljs-tag">&lt;<span class="hljs-name">resources</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">resource</span>&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">directory</span>&gt;</span>src/main/resources<span class="hljs-tag">&lt;/<span class="hljs-name">directory</span>&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">filtering</span>&gt;</span>true<span class="hljs-tag">&lt;/<span class="hljs-name">filtering</span>&gt;</span>
            <span class="hljs-tag">&lt;/<span class="hljs-name">resource</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">resources</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">build</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">project</span>&gt;</span></code></pre></div>
</li>
<li><p>对MainApplication进行修改</p>
<div class="hljs"><pre><code class="hljs java"><span class="hljs-meta">@SpringBootApplication</span>
<span class="hljs-meta">@MapperScan</span>(basePackages = <span class="hljs-string">"com.debug.middleware.model"</span>)
<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MainApplication</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">SpringBootServletInitializer</span> </span>&#123;

    <span class="hljs-meta">@Override</span>
    <span class="hljs-function"><span class="hljs-keyword">protected</span> SpringApplicationBuilder <span class="hljs-title">configure</span><span class="hljs-params">(SpringApplicationBuilder builder)</span> </span>&#123;
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">super</span>.configure(builder);
    &#125;

    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> </span>&#123;
        SpringApplication.run(MainApplication<span class="hljs-class">.<span class="hljs-keyword">class</span>,<span class="hljs-title">args</span>)</span>;
    &#125;
&#125;</code></pre></div>
</li>
<li><p>application.properties配置文件</p>
<div class="hljs"><pre><code class="hljs properties"><span class="hljs-comment">#profile</span>
<span class="hljs-comment">#spring.profiles.active=productions</span>
<span class="hljs-comment">#spring.profiles.active=local</span>
<span class="hljs-comment">#指定应用访问的上下文及端口</span>
<span class="hljs-meta">server.context-path</span>=<span class="hljs-string">/middleware</span>
<span class="hljs-meta">server.port</span>=<span class="hljs-string">8087</span>
<span class="hljs-comment">#logging日志配置</span>
<span class="hljs-meta">logging.path</span>=<span class="hljs-string">/srv/dubbo/middleware/logs</span>
<span class="hljs-meta">logging.file</span>=<span class="hljs-string">middleware</span>
<span class="hljs-meta">logging.level.org.springframework</span>=<span class="hljs-string">info</span>
<span class="hljs-meta">logging.level.com.fasterxml.jackson</span>=<span class="hljs-string">info</span>
<span class="hljs-meta">logging.level.debug.middleware</span>=<span class="hljs-string">debug</span>
<span class="hljs-comment">#json日期格式化</span>
<span class="hljs-meta">spring.jackson.date-format</span>=<span class="hljs-string">yyyy-mm-dd HH:mm:ss</span>
<span class="hljs-meta">spring.jackson.time-zone</span>=<span class="hljs-string">GMT+8;</span>
<span class="hljs-meta">spring.datasource.initialize</span>=<span class="hljs-string">false</span>
<span class="hljs-meta">spring.jmx.enabled</span>=<span class="hljs-string">false</span>
<span class="hljs-comment">#数据库访问配置</span>
<span class="hljs-meta">spring.datasource.url</span>=<span class="hljs-string">jdbc:mysql://localhost:3306/db_middleware?useUnicode=true&amp;amp;characterEncoding=utf-8</span>
<span class="hljs-meta">spring.datasource.username</span>=<span class="hljs-string">root</span>
<span class="hljs-meta">spring.datasource.password</span>=<span class="hljs-string">root</span>
<span class="hljs-comment">#MyBatis配置</span>
<span class="hljs-meta">mybatis.config-location</span>=<span class="hljs-string">classpath:mybatis-config.xml</span>
<span class="hljs-meta">mybatis.check-config-location</span>=<span class="hljs-string">true</span>
<span class="hljs-meta">mybatis.mapper-locations</span>=<span class="hljs-string">classpath:mappers/*.xml</span>
<span class="hljs-comment">#Redis连接配置</span>
<span class="hljs-meta">spring.redis.host</span>=<span class="hljs-string">127.0.0.1</span>
<span class="hljs-meta">spring.redis.port</span>=<span class="hljs-string">6379</span></code></pre></div>
</li>
<li><p>mybatis配置文件mybatis-config.xml</p>
<div class="hljs"><pre><code class="hljs xml"><span class="hljs-meta">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span>
<span class="hljs-meta">&lt;!DOCTYPE <span class="hljs-meta-keyword">configuration</span> <span class="hljs-meta-keyword">PUBLIC</span> <span class="hljs-meta-string">"-//mybatis.org//DTD Config 3.0//EN"</span></span>
<span class="hljs-meta">        <span class="hljs-meta-string">"http://mybatis.org/dtd/mybatis-3-config.dtd"</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">configuration</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">settings</span>&gt;</span>
        <span class="hljs-comment">&lt;!--允许使用缓存配置--&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">setting</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"cacheEnabled"</span> <span class="hljs-attr">value</span>=<span class="hljs-string">"true"</span>/&gt;</span>
        <span class="hljs-comment">&lt;!--SQL执行语句的默认响应超时时间--&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">setting</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"defaultStatementTimeout"</span> <span class="hljs-attr">value</span>=<span class="hljs-string">"3000"</span>/&gt;</span>
        <span class="hljs-comment">&lt;!--允许驼峰命令的配置--&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">setting</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"mapUnderscoreToCamelCase"</span> <span class="hljs-attr">value</span>=<span class="hljs-string">"true"</span>/&gt;</span>
        <span class="hljs-comment">&lt;!--允许执行完SQL插入语句后返回主键配置--&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">setting</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"useGeneratedKeys"</span> <span class="hljs-attr">value</span>=<span class="hljs-string">"true"</span>/&gt;</span>
        <span class="hljs-comment">&lt;!--设置控制台打印SQL--&gt;</span>
        <span class="hljs-comment">&lt;!--&lt;setting name="logImpl" value="stdout_logging"/&gt;--&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">settings</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">configuration</span>&gt;</span></code></pre></div>
</li>
<li><p>日志配置文件log4j.properties</p>
<div class="hljs"><pre><code class="hljs properties"><span class="hljs-comment">#Console Log</span>
<span class="hljs-meta">log4j.rootLogger</span>=<span class="hljs-string">INFO,console,debug.info,warn,error</span>
<span class="hljs-attr">LOG_PATTERN</span>=<span class="hljs-string">[%d&#123;yyyy-MM-dd HH:mm:ss.sss&#125;] boot%X&#123;context&#125; - %5p [%t] ---%c&#123;1&#125;: %m%n</span>
<span class="hljs-comment">#打印日志到Console</span>
<span class="hljs-meta">log4j.appender.console</span>=<span class="hljs-string">org.apache.log4j.ConsoleAppender</span>
<span class="hljs-meta">log4j.appender.console.Threshold</span>=<span class="hljs-string">DEBUG</span>
<span class="hljs-meta">log4j.appender.console.layout</span>=<span class="hljs-string">org.apache.log4j.PatternLayout</span>
<span class="hljs-meta">log4j.appender.console.layout.ConversionPattern</span>=<span class="hljs-string">$&#123;LOG_PATTERN&#125;</span>

<span class="hljs-meta">log4j.appender.info</span>=<span class="hljs-string">org.apache.log4jDailyRollingFileAppender</span>
<span class="hljs-meta">log4j.appender.info.Threshold</span>=<span class="hljs-string">INFO</span>
<span class="hljs-meta">log4j.appender.info.File</span>=<span class="hljs-string">$&#123;LOG_PATH&#125;/$&#123;LOG_FILE&#125;_info.log</span>
<span class="hljs-meta">log4j.appender.info.DatePattern</span>=<span class="hljs-string">'.'yyyy-MM-dd</span>
<span class="hljs-meta">log4j.appender.info.layout</span>=<span class="hljs-string">org.apache.lgo4j.PatternLayout</span>
<span class="hljs-meta">log4j.appender.info.layout.ConversionPattern</span>=<span class="hljs-string">$&#123;LOG_PATTERN&#125;</span>

<span class="hljs-meta">log4j.appender.error</span>=<span class="hljs-string">org.apache.log4j.DailyRollingFileAppender</span>
<span class="hljs-meta">log4j.appender.error.Threshold</span>=<span class="hljs-string">ERROR</span>
<span class="hljs-meta">log4j.appender.error.File</span>=<span class="hljs-string">$&#123;LOG_PATH&#125;/$&#123;LOG_FILE&#125;error.log</span>
<span class="hljs-meta">log4j.appender.error.DatePattern</span>=<span class="hljs-string">'.'yyyy-MM-dd</span>
<span class="hljs-meta">log4j.appender.error.layout</span>=<span class="hljs-string">org.apache.log4j.PatternLayout</span>
<span class="hljs-meta">log4j.appender.error.layout.ConversionPattern</span>=<span class="hljs-string">$&#123;LOG_PATTERN&#125;</span>

<span class="hljs-meta">log4j.appender.debug</span>=<span class="hljs-string">org.apache.log4j.DailyRollingFileAppender</span>
<span class="hljs-meta">log4j.appender.debug.Threshold</span>=<span class="hljs-string">DEBUG</span>
<span class="hljs-meta">log4j.appender.debug.File</span>=<span class="hljs-string">$&#123;LOG_PATH&#125;/$&#123;LOG_FILE&#125;debug.log</span>
<span class="hljs-meta">log4j.appender.debug.DatePattern</span>=<span class="hljs-string">'.'yyyy-MM-dd</span>
<span class="hljs-meta">log4j.appender.debug.layout</span>=<span class="hljs-string">org.apache.log4j.PatternLayout</span>
<span class="hljs-meta">log4j.appender.debug.layout.ConversionPattern</span>=<span class="hljs-string">$&#123;LOG_PATTERN&#125;</span>

<span class="hljs-meta">log4j.appender.warn</span>=<span class="hljs-string">org.apache.log4j.DailyRollingFileAppender</span>
<span class="hljs-meta">log4j.appender.warn.Threshold</span>=<span class="hljs-string">WARN</span>
<span class="hljs-meta">log4j.appender.warn.File</span>=<span class="hljs-string">$&#123;LOG_PATH&#125;/$&#123;LOG_FILE&#125;warn.log</span>
<span class="hljs-meta">log4j.appender.warn.DatePattern</span>=<span class="hljs-string">'.'yyyy-MM-dd</span>
<span class="hljs-meta">log4j.appender.warn.layout</span>=<span class="hljs-string">org.apache.log4j.PatternLayout</span>
<span class="hljs-meta">log4j.appender.warn.layout.ConversionPattern</span>=<span class="hljs-string">$&#123;LOG_PATTERN&#125;</span></code></pre></div>



</li>
</ol>
<ol start="13">
<li>最终结构</li>
</ol>
<p><img src="https://gitee.com/yang_yu_jie/blog-img/raw/master/img/20210530101042.png" srcset="/img/loading.gif" alt="在这里插入图片描述"></p>
<p>Hello World小试牛刀</p>
<p>在server模块创建controller包和entity包</p>
<p>controller包下新建一个BookController类，用于处理请求，entity包下新建Book类，封装书的字段信息</p>
<div class="hljs"><pre><code class="hljs java"><span class="hljs-meta">@Data</span>
<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Book</span> </span>&#123;
    <span class="hljs-keyword">private</span> Integer bookNo;
    <span class="hljs-keyword">private</span> String name;
&#125;</code></pre></div>

<div class="hljs"><pre><code class="hljs java"><span class="hljs-meta">@RestController</span>
<span class="hljs-meta">@RequestMapping</span>(<span class="hljs-string">"/book"</span>)
<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">BookController</span> </span>&#123;
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> Logger log = LoggerFactory.getLogger(BookController<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
    <span class="hljs-comment">/***获取书籍对象信息*/</span>
    <span class="hljs-meta">@RequestMapping</span>(value=<span class="hljs-string">"info"</span>,method = RequestMethod.GET)
    <span class="hljs-function"><span class="hljs-keyword">public</span> Book <span class="hljs-title">info</span><span class="hljs-params">(Integer bookNo,String bookName)</span></span>&#123;
        Book book = <span class="hljs-keyword">new</span> Book();
        book.setBookNo(bookNo);
        book.setName(bookName);
        <span class="hljs-keyword">return</span> book;
    &#125;
&#125;</code></pre></div>

<p>运行程序</p>
<p><img src="https://gitee.com/yang_yu_jie/blog-img/raw/master/img/20210530101153.png" srcset="/img/loading.gif" alt="在这里插入图片描述"></p>
<h1 id="第3章：缓存中间件Redis"><a href="#第3章：缓存中间件Redis" class="headerlink" title="第3章：缓存中间件Redis"></a>第3章：缓存中间件Redis</h1><p>Windows下启动Redis：双击redis-server.exe</p>
<p>Windows下运行Redis命令行窗口：双击redis-cli.exe</p>
<p>常用命令：</p>
<ul>
<li>查看Redis缓存中存储的所有Key：key *</li>
<li>缓存中创建一个名为redis:order:no:10011，值为10011的key：set redis:order:no:10011 10011</li>
<li>查看缓存中指定key的值：get redis:order:no:10011</li>
<li>删除缓存中指定的key：del redis:order:no:10011</li>
</ul>
<h2 id="Spring-Boot整合Redis"><a href="#Spring-Boot整合Redis" class="headerlink" title="Spring Boot整合Redis"></a>Spring Boot整合Redis</h2><p>1、加入Redis的依赖jar</p>
<div class="hljs"><pre><code class="hljs xml"><span class="hljs-comment">&lt;!-- redis --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-starter-redis<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>1.3.3.RELEASE<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span></code></pre></div>

<p>2、在配置文件application.properties中加入Redis的连接配置</p>
<div class="hljs"><pre><code class="hljs properties"><span class="hljs-comment">#Redis连接配置</span>
<span class="hljs-meta">spring.redis.host</span>=<span class="hljs-string">127.0.0.1</span>
<span class="hljs-meta">spring.redis.port</span>=<span class="hljs-string">6379</span></code></pre></div>

<p>Redis自定义注入Bean组件配置</p>
<div class="hljs"><pre><code class="hljs java"><span class="hljs-comment">//com.coding.fight.server.config.CommonConfig</span>
<span class="hljs-meta">@Configuration</span>
<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">CommonConfig</span> </span>&#123;
    <span class="hljs-comment">/**redis链接工厂*/</span>
    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> RedisConnectionFactory redisConnectionFactory;
    <span class="hljs-comment">/**缓存操作组件RedisTemplate的自定义配置*/</span>
    <span class="hljs-meta">@Bean</span>
    <span class="hljs-keyword">public</span> RedisTemplate&lt;String,Object&gt;redisTemplate()&#123;
        <span class="hljs-comment">//定义RedisTemplate实例</span>
        RedisTemplate&lt;String,Object&gt;redisTemplate = <span class="hljs-keyword">new</span> RedisTemplate&lt;&gt;();
        <span class="hljs-comment">//设置Redis的链接工厂</span>
        redisTemplate.setConnectionFactory(redisConnectionFactory);
        <span class="hljs-comment">//<span class="hljs-doctag">TODO:</span>指定大key序列化策略为String序列化，value为JDK自带的序列化策略</span>
        redisTemplate.setKeySerializer(<span class="hljs-keyword">new</span> StringRedisSerializer());
        redisTemplate.setValueSerializer(<span class="hljs-keyword">new</span> JdkSerializationRedisSerializer());
        <span class="hljs-comment">//TODO：指定hashKey序列化策略为String序列化-针对hash散列存储</span>
        redisTemplate.setHashKeySerializer(<span class="hljs-keyword">new</span> StringRedisSerializer());
        <span class="hljs-keyword">return</span> redisTemplate;
    &#125;
    <span class="hljs-comment">/**缓存操作组件StringRedisTemplate*/</span>
    <span class="hljs-meta">@Bean</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> StringRedisTemplate <span class="hljs-title">stringRedisTemplate</span><span class="hljs-params">()</span></span>&#123;
        <span class="hljs-comment">//采用默认配置即可，后续有自定义配置时则在此处添加即可</span>
        StringRedisTemplate stringRedisTemplate = <span class="hljs-keyword">new</span> StringRedisTemplate();
        stringRedisTemplate.setConnectionFactory(redisConnectionFactory);
        <span class="hljs-keyword">return</span> stringRedisTemplate;
    &#125;
&#125;</code></pre></div>

<h2 id="RedisTemplate实战"><a href="#RedisTemplate实战" class="headerlink" title="RedisTemplate实战"></a>RedisTemplate实战</h2><p>目标一：采用RedisTemplate将字符串写入缓存中，并读取出来展示到控制台上</p>
<div class="hljs"><pre><code class="hljs java"><span class="hljs-meta">@RunWith</span>(SpringJUnit4ClassRunner<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>
<span class="hljs-class">@<span class="hljs-title">SpringBootTest</span></span>
<span class="hljs-class"><span class="hljs-title">public</span> <span class="hljs-title">class</span> <span class="hljs-title">RedisTest</span> </span>&#123;
    <span class="hljs-comment">//定义日志</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> Logger log = LoggerFactory.getLogger(RedisTest<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
    <span class="hljs-comment">//定义RedisTemplate操作组件</span>
    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> RedisTemplate redisTemplate;
    <span class="hljs-comment">//定义JSON序列化和反序列化框架类</span>
    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> ObjectMapper objectMapper;

    <span class="hljs-meta">@Test</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">one</span><span class="hljs-params">()</span> </span>&#123;
        log.info(<span class="hljs-string">"---开始RedisTemplate操作组件实战---"</span>);
        <span class="hljs-comment">//定义字符串内容及存入缓存的key</span>
        <span class="hljs-keyword">final</span> String content = <span class="hljs-string">"RedisTemplate实战字符串信息"</span>;
        <span class="hljs-keyword">final</span> String key = <span class="hljs-string">"redis:template:one:string"</span>;
        <span class="hljs-comment">//Redis通用的操作组件</span>
        ValueOperations valueOperations = redisTemplate.opsForValue();
        <span class="hljs-comment">//将字符串信息写入缓存中</span>
        log.info(<span class="hljs-string">"写入缓存中的内容：&#123;&#125;"</span>, content);
        valueOperations.set(key, content);
        <span class="hljs-comment">//从缓存中读取内容</span>
        Object result = valueOperations.get(key);
        log.info(<span class="hljs-string">"读取出来的内容：&#123;&#125;"</span>, result);
    &#125;
&#125;</code></pre></div>

<p>效果：</p>
<div class="hljs"><pre><code class="hljs angelscript">[<span class="hljs-number">2020</span><span class="hljs-number">-12</span><span class="hljs-number">-30</span> <span class="hljs-number">23</span>:<span class="hljs-number">38</span>:<span class="hljs-number">29.029</span>] boot -  INFO [main] ---RedisTest: ---开始RedisTemplate操作组件实战---
[<span class="hljs-number">2020</span><span class="hljs-number">-12</span><span class="hljs-number">-30</span> <span class="hljs-number">23</span>:<span class="hljs-number">38</span>:<span class="hljs-number">29.029</span>] boot -  INFO [main] ---RedisTest: 写入缓存中的内容：RedisTemplate实战字符串信息
[<span class="hljs-number">2020</span><span class="hljs-number">-12</span><span class="hljs-number">-30</span> <span class="hljs-number">23</span>:<span class="hljs-number">38</span>:<span class="hljs-number">29.029</span>] boot -  INFO [main] ---RedisTest: 读取出来的内容：RedisTemplate实战字符串信息</code></pre></div>

<p>目标二：采用RedisTemplate将对象信息序列化为JSON格式的字符串后写入缓存中，然后将其读取出来，最后反序列化解析其中的内容并展示在控制台</p>
<div class="hljs"><pre><code class="hljs java"><span class="hljs-meta">@Test</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">two</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> IOException </span>&#123;
        log.info(<span class="hljs-string">"-----开始RedisTemplate操作组件实战----"</span>);
        <span class="hljs-comment">//构造对象信息</span>
        User user = <span class="hljs-keyword">new</span> User(<span class="hljs-number">1</span>, <span class="hljs-string">"debug"</span>, <span class="hljs-string">"阿修罗"</span>);
        <span class="hljs-comment">//Redis通用的操作组件</span>
        ValueOperations valueOperations = redisTemplate.opsForValue();
        <span class="hljs-comment">//将序列化后的信息写入缓存中</span>
        <span class="hljs-keyword">final</span> String key = <span class="hljs-string">"redis:template:two:object"</span>;
        <span class="hljs-keyword">final</span> String content = objectMapper.writeValueAsString(user);
        valueOperations.set(key, content);
        log.info(<span class="hljs-string">"写入缓存对象的信息：&#123;&#125;"</span>, user);
        <span class="hljs-comment">//从缓存中读取内容</span>
        Object result = valueOperations.get(key);
        <span class="hljs-keyword">if</span> (result != <span class="hljs-keyword">null</span>) &#123;
            User resultUser = objectMapper.readValue(result.toString(),User<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
            log.info(<span class="hljs-string">"读取缓存内容并反序列化后的结果：&#123;&#125;"</span>,resultUser);
        &#125;
    &#125;</code></pre></div>

<p>效果：</p>
<div class="hljs"><pre><code class="hljs angelscript">[<span class="hljs-number">2021</span><span class="hljs-number">-01</span><span class="hljs-number">-03</span> <span class="hljs-number">15</span>:<span class="hljs-number">05</span>:<span class="hljs-number">14.014</span>] boot -  INFO [main] ---RedisTest: -----开始RedisTemplate操作组件实战----
[<span class="hljs-number">2021</span><span class="hljs-number">-01</span><span class="hljs-number">-03</span> <span class="hljs-number">15</span>:<span class="hljs-number">05</span>:<span class="hljs-number">15.015</span>] boot -  INFO [main] ---RedisTest: 写入缓存对象的信息：User(id=<span class="hljs-number">1</span>, userName=debug, name=阿修罗)
[<span class="hljs-number">2021</span><span class="hljs-number">-01</span><span class="hljs-number">-03</span> <span class="hljs-number">15</span>:<span class="hljs-number">05</span>:<span class="hljs-number">15.015</span>] boot -  INFO [main] ---RedisTest: 读取缓存内容并反序列化后的结果：User(id=<span class="hljs-number">1</span>, userName=debug, name=阿修罗)</code></pre></div>

<h2 id="Redis常见数据结构实战"><a href="#Redis常见数据结构实战" class="headerlink" title="Redis常见数据结构实战"></a>Redis常见数据结构实战</h2><h3 id="字符串"><a href="#字符串" class="headerlink" title="字符串"></a>字符串</h3><p>业务场景：将用户个人信息存储至缓存中，实现每次前端请求获取用户个人详情时直接从缓存中读取</p>
<p>Person类：</p>
<div class="hljs"><pre><code class="hljs java"><span class="hljs-meta">@Data</span>
<span class="hljs-meta">@ToString</span>
<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Person</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">Serializable</span> </span>&#123;
    <span class="hljs-keyword">private</span> Integer id;
    <span class="hljs-keyword">private</span> Integer age;
    <span class="hljs-keyword">private</span> String name;
    <span class="hljs-keyword">private</span> String userName;
    <span class="hljs-keyword">private</span> String location;

    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">Person</span><span class="hljs-params">()</span> </span>&#123;
    &#125;

    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">Person</span><span class="hljs-params">(Integer id, Integer age, String name, String userName, String location)</span> </span>&#123;
        <span class="hljs-keyword">this</span>.id = id;
        <span class="hljs-keyword">this</span>.age = age;
        <span class="hljs-keyword">this</span>.name = name;
        <span class="hljs-keyword">this</span>.userName = userName;
        <span class="hljs-keyword">this</span>.location = location;
    &#125;
&#125;</code></pre></div>

<p>测试类</p>
<div class="hljs"><pre><code class="hljs java"><span class="hljs-meta">@RunWith</span>(SpringJUnit4ClassRunner<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>
<span class="hljs-class">@<span class="hljs-title">SpringBootTest</span></span>
<span class="hljs-class"><span class="hljs-title">public</span> <span class="hljs-title">class</span> <span class="hljs-title">RedisTest2</span> </span>&#123;
    <span class="hljs-comment">//定义日志</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> Logger log = LoggerFactory.getLogger(RedisTest2<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
    <span class="hljs-comment">//定义RedisTemplate操作组件</span>
    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> RedisTemplate redisTemplate;
    <span class="hljs-comment">//JSON序列化与反序列化框架类</span>
    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> ObjectMapper objectMapper;

    <span class="hljs-comment">//单元测试方法</span>
    <span class="hljs-meta">@Test</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">one</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> IOException </span>&#123;
        <span class="hljs-comment">//构造用户个人实体对象</span>
        Person p = <span class="hljs-keyword">new</span> Person(<span class="hljs-number">10013</span>, <span class="hljs-number">23</span>, <span class="hljs-string">"修罗"</span>, <span class="hljs-string">"debug"</span>, <span class="hljs-string">"火星"</span>);
        <span class="hljs-comment">//定义key与即将存入缓存中的value</span>
        <span class="hljs-keyword">final</span> String key = <span class="hljs-string">"redis:test:1"</span>;
        String value = objectMapper.writeValueAsString(p);
        <span class="hljs-comment">//写入缓存中</span>
        log.info(<span class="hljs-string">"存入缓存中的用户实体对象信息为：&#123;&#125;"</span>, p);
        redisTemplate.opsForValue().set(key, value);
        <span class="hljs-comment">//从缓存中获取用户实体信息</span>
        Object res = redisTemplate.opsForValue().get(key);
        <span class="hljs-keyword">if</span> (res != <span class="hljs-keyword">null</span>) &#123;
            Person resP = objectMapper.readValue(res.toString(), Person<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
            log.info(<span class="hljs-string">"从缓存中读取信息：&#123;&#125;"</span>, resP);
        &#125;
    &#125;
&#125;</code></pre></div>

<p>效果</p>
<div class="hljs"><pre><code class="hljs routeros">[2021-01-03 17:59:55.055] boot -  <span class="hljs-builtin-name">INFO</span> [main] ---RedisTest2: 存入缓存中的用户实体对象信息为：Person(<span class="hljs-attribute">id</span>=10013, <span class="hljs-attribute">age</span>=23, <span class="hljs-attribute">name</span>=修罗, <span class="hljs-attribute">userName</span>=debug, <span class="hljs-attribute">location</span>=火星)
[2021-01-03 17:59:55.055] boot -  <span class="hljs-builtin-name">INFO</span> [main] ---RedisTest2: 从缓存中读取信息：Person(<span class="hljs-attribute">id</span>=10013, <span class="hljs-attribute">age</span>=23, <span class="hljs-attribute">name</span>=修罗, <span class="hljs-attribute">userName</span>=debug, <span class="hljs-attribute">location</span>=火星)</code></pre></div>

<h3 id="列表"><a href="#列表" class="headerlink" title="列表"></a>列表</h3><p>案例：将一组已经排好序的用户对象列表存储在缓存中，按照排名的先后顺序获取出来并输出打印到控制台</p>
<div class="hljs"><pre><code class="hljs java"><span class="hljs-meta">@Test</span>
<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">two</span><span class="hljs-params">()</span> </span>&#123;
    <span class="hljs-comment">//构造已经排好序的用户对象列表</span>
    List&lt;Person&gt; list = <span class="hljs-keyword">new</span> ArrayList&lt;&gt;();
    list.add(<span class="hljs-keyword">new</span> Person(<span class="hljs-number">1</span>, <span class="hljs-number">21</span>, <span class="hljs-string">"修罗"</span>, <span class="hljs-string">"debug"</span>, <span class="hljs-string">"火星"</span>));
    list.add(<span class="hljs-keyword">new</span> Person(<span class="hljs-number">2</span>, <span class="hljs-number">22</span>, <span class="hljs-string">"大圣"</span>, <span class="hljs-string">"jack"</span>, <span class="hljs-string">"水帘洞"</span>));
    list.add(<span class="hljs-keyword">new</span> Person(<span class="hljs-number">3</span>, <span class="hljs-number">23</span>, <span class="hljs-string">"盘古"</span>, <span class="hljs-string">"Lee"</span>, <span class="hljs-string">"上古"</span>));
    log.info(<span class="hljs-string">"构造已经排好序的用户对象列表：&#123;&#125;"</span>, list);
    <span class="hljs-comment">//将列表数据存储至Redis的List中</span>
    <span class="hljs-keyword">final</span> String key = <span class="hljs-string">"redis:test:2"</span>;
    ListOperations listOperations = redisTemplate.opsForList();
    <span class="hljs-keyword">for</span> (Person p : list) &#123;
        <span class="hljs-comment">//往列表中添加数据-从队尾中添加</span>
        listOperations.leftPush(key, p);
    &#125;
    <span class="hljs-comment">//获取Redis中List的数据-从队头中遍历获取，直到没有元素为止</span>
    log.info(<span class="hljs-string">"--获取Redis中List的数据-从队头中获取---"</span>);
    Object res = listOperations.rightPop(key);
    Person resP;
    <span class="hljs-keyword">while</span> (res != <span class="hljs-keyword">null</span>) &#123;
        resP = (Person) res;
        log.info(<span class="hljs-string">"当前数据：&#123;&#125;"</span>, resP);
        res = listOperations.rightPop(key);
    &#125;
&#125;</code></pre></div>

<p>效果</p>
<div class="hljs"><pre><code class="hljs routeros">[2021-01-03 18:23:53.053] boot -  <span class="hljs-builtin-name">INFO</span> [main] ---RedisTest2: 构造已经排好序的用户对象列表：[Person(<span class="hljs-attribute">id</span>=1, <span class="hljs-attribute">age</span>=21, <span class="hljs-attribute">name</span>=修罗, <span class="hljs-attribute">userName</span>=debug, <span class="hljs-attribute">location</span>=火星), Person(<span class="hljs-attribute">id</span>=2, <span class="hljs-attribute">age</span>=22, <span class="hljs-attribute">name</span>=大圣, <span class="hljs-attribute">userName</span>=jack, <span class="hljs-attribute">location</span>=水帘洞), Person(<span class="hljs-attribute">id</span>=3, <span class="hljs-attribute">age</span>=23, <span class="hljs-attribute">name</span>=盘古, <span class="hljs-attribute">userName</span>=Lee, <span class="hljs-attribute">location</span>=上古)]
[2021-01-03 18:23:53.053] boot -  <span class="hljs-builtin-name">INFO</span> [main] ---RedisTest2: --获取Redis中List的数据-从队头中获取---
[2021-01-03 18:23:53.053] boot -  <span class="hljs-builtin-name">INFO</span> [main] ---RedisTest2: 当前数据：Person(<span class="hljs-attribute">id</span>=1, <span class="hljs-attribute">age</span>=21, <span class="hljs-attribute">name</span>=修罗, <span class="hljs-attribute">userName</span>=debug, <span class="hljs-attribute">location</span>=火星)
[2021-01-03 18:23:53.053] boot -  <span class="hljs-builtin-name">INFO</span> [main] ---RedisTest2: 当前数据：Person(<span class="hljs-attribute">id</span>=2, <span class="hljs-attribute">age</span>=22, <span class="hljs-attribute">name</span>=大圣, <span class="hljs-attribute">userName</span>=jack, <span class="hljs-attribute">location</span>=水帘洞)
[2021-01-03 18:23:53.053] boot -  <span class="hljs-builtin-name">INFO</span> [main] ---RedisTest2: 当前数据：Person(<span class="hljs-attribute">id</span>=3, <span class="hljs-attribute">age</span>=23, <span class="hljs-attribute">name</span>=盘古, <span class="hljs-attribute">userName</span>=Lee, <span class="hljs-attribute">location</span>=上古)</code></pre></div>

<h3 id="集合"><a href="#集合" class="headerlink" title="集合"></a>集合</h3><p>用于存储具有相同类型或特征的不重复的数据</p>
<p>需求：给定一组用户姓名列表，要求剔除具有相同姓名的人员并组成新的集合，存放至缓存中并用于前端访问</p>
<p>核心代码：</p>
<div class="hljs"><pre><code class="hljs java"><span class="hljs-meta">@Test</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">three</span><span class="hljs-params">()</span> </span>&#123;
        <span class="hljs-comment">//构造一组用户姓名列表</span>
        List&lt;String&gt; userList = <span class="hljs-keyword">new</span> ArrayList&lt;&gt;();
        userList.add(<span class="hljs-string">"debug"</span>);
        userList.add(<span class="hljs-string">"jack"</span>);
        userList.add(<span class="hljs-string">"修罗"</span>);
        userList.add(<span class="hljs-string">"大圣"</span>);
        userList.add(<span class="hljs-string">"debug"</span>);
        userList.add(<span class="hljs-string">"jack"</span>);
        userList.add(<span class="hljs-string">"steadyheart"</span>);
        userList.add(<span class="hljs-string">"修罗"</span>);
        userList.add(<span class="hljs-string">"大圣"</span>);
        log.info(<span class="hljs-string">"待处理的用户姓名列表：&#123;&#125;"</span>, userList);
        <span class="hljs-comment">//遍历访问，剔除相同姓名的用户并塞入集合中，最终存入缓存中</span>
        <span class="hljs-keyword">final</span> String key = <span class="hljs-string">"redis:test:3"</span>;
        SetOperations setOperations = redisTemplate.opsForSet();
        <span class="hljs-keyword">for</span> (String s : userList) &#123;
            setOperations.add(key,s);
        &#125;
        <span class="hljs-comment">//从缓存中获取用户对象集合</span>
        Object res = setOperations.pop(key);
        <span class="hljs-keyword">while</span> (res != <span class="hljs-keyword">null</span>) &#123;
            log.info(<span class="hljs-string">"从缓存中获取的用户集合-当前用户：&#123;&#125;"</span>, res);
            res = setOperations.pop(key);
        &#125;
    &#125;</code></pre></div>

<p>效果：</p>
<div class="hljs"><pre><code class="hljs angelscript">[<span class="hljs-number">2021</span><span class="hljs-number">-01</span><span class="hljs-number">-04</span> <span class="hljs-number">13</span>:<span class="hljs-number">02</span>:<span class="hljs-number">05.005</span>] boot -  INFO [main] ---RedisTest2: 待处理的用户姓名列表：[debug, jack, 修罗, 大圣, debug, jack, steadyheart, 修罗, 大圣]
[<span class="hljs-number">2021</span><span class="hljs-number">-01</span><span class="hljs-number">-04</span> <span class="hljs-number">13</span>:<span class="hljs-number">02</span>:<span class="hljs-number">05.005</span>] boot -  INFO [main] ---RedisTest2: 从缓存中获取的用户集合-当前用户：大圣
[<span class="hljs-number">2021</span><span class="hljs-number">-01</span><span class="hljs-number">-04</span> <span class="hljs-number">13</span>:<span class="hljs-number">02</span>:<span class="hljs-number">05.005</span>] boot -  INFO [main] ---RedisTest2: 从缓存中获取的用户集合-当前用户：steadyheart
[<span class="hljs-number">2021</span><span class="hljs-number">-01</span><span class="hljs-number">-04</span> <span class="hljs-number">13</span>:<span class="hljs-number">02</span>:<span class="hljs-number">05.005</span>] boot -  INFO [main] ---RedisTest2: 从缓存中获取的用户集合-当前用户：debug
[<span class="hljs-number">2021</span><span class="hljs-number">-01</span><span class="hljs-number">-04</span> <span class="hljs-number">13</span>:<span class="hljs-number">02</span>:<span class="hljs-number">05.005</span>] boot -  INFO [main] ---RedisTest2: 从缓存中获取的用户集合-当前用户：jack
[<span class="hljs-number">2021</span><span class="hljs-number">-01</span><span class="hljs-number">-04</span> <span class="hljs-number">13</span>:<span class="hljs-number">02</span>:<span class="hljs-number">05.005</span>] boot -  INFO [main] ---RedisTest2: 从缓存中获取的用户集合-当前用户：修罗</code></pre></div>

<h3 id="有序集合"><a href="#有序集合" class="headerlink" title="有序集合"></a>有序集合</h3><p>与sort 的不同之处在于可以通过底层的Score值对数据进行排序</p>
<p>需求：找出一个星期内手机话费单次金额前6名的用户列表，并要求按照金额从大到小进行排序</p>
<p>代码：</p>
<div class="hljs"><pre><code class="hljs java"><span class="hljs-meta">@Data</span>
<span class="hljs-meta">@ToString</span>
<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">PhoneUser</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">Serializable</span> </span>&#123;
    <span class="hljs-keyword">private</span> String phone;
    <span class="hljs-keyword">private</span> Double fare;

    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">PhoneUser</span><span class="hljs-params">()</span> </span>&#123;
    &#125;

    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">PhoneUser</span><span class="hljs-params">(String phone, Double fare)</span> </span>&#123;
        <span class="hljs-keyword">this</span>.phone = phone;
        <span class="hljs-keyword">this</span>.fare = fare;
    &#125;

    <span class="hljs-comment">/**</span>
<span class="hljs-comment">     * 手机号相同，代表充值记录重复，所以需要重写equals和hashCode方法</span>
<span class="hljs-comment">     */</span>
    <span class="hljs-meta">@Override</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">boolean</span> <span class="hljs-title">equals</span><span class="hljs-params">(Object o)</span> </span>&#123;
        <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span> == o) <span class="hljs-keyword">return</span> <span class="hljs-keyword">true</span>;
        <span class="hljs-keyword">if</span> (o == <span class="hljs-keyword">null</span> || getClass() != o.getClass()) <span class="hljs-keyword">return</span> <span class="hljs-keyword">false</span>;
        PhoneUser phoneUser = (PhoneUser) o;
        <span class="hljs-keyword">return</span> phone != <span class="hljs-keyword">null</span> ? phone.equals(phoneUser.phone) : phoneUser.phone == <span class="hljs-keyword">null</span>;
    &#125;

    <span class="hljs-meta">@Override</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">int</span> <span class="hljs-title">hashCode</span><span class="hljs-params">()</span> </span>&#123;
        <span class="hljs-keyword">return</span> phone != <span class="hljs-keyword">null</span> ? phone.hashCode() : <span class="hljs-number">0</span>;
    &#125;
&#125;</code></pre></div>

<div class="hljs"><pre><code class="hljs java"><span class="hljs-meta">@Test</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">four</span><span class="hljs-params">()</span> </span>&#123;
        <span class="hljs-comment">//构造一组无序的用户手机充值对象列表</span>
        List&lt;PhoneUser&gt; list = <span class="hljs-keyword">new</span> ArrayList&lt;&gt;();
        list.add(<span class="hljs-keyword">new</span> PhoneUser(<span class="hljs-string">"103"</span>, <span class="hljs-number">130.0</span>));
        list.add(<span class="hljs-keyword">new</span> PhoneUser(<span class="hljs-string">"101"</span>, <span class="hljs-number">120.0</span>));
        list.add(<span class="hljs-keyword">new</span> PhoneUser(<span class="hljs-string">"105"</span>, <span class="hljs-number">110.0</span>));
        list.add(<span class="hljs-keyword">new</span> PhoneUser(<span class="hljs-string">"104"</span>, <span class="hljs-number">100.0</span>));
        list.add(<span class="hljs-keyword">new</span> PhoneUser(<span class="hljs-string">"106"</span>, <span class="hljs-number">150.0</span>));
        list.add(<span class="hljs-keyword">new</span> PhoneUser(<span class="hljs-string">"102"</span>, <span class="hljs-number">160.0</span>));
        log.info(<span class="hljs-string">"构造一组无序的用户手机充值对象列表：&#123;&#125;"</span>, list);
        <span class="hljs-comment">//遍历访问充值对象雷暴，将信息塞入Redis的有序集合中</span>
        <span class="hljs-keyword">final</span> String key = <span class="hljs-string">"redis:test:4"</span>;
        <span class="hljs-comment">//因为zSet在add元素进入缓存后，下次就不能进行更新了，因而为了测试方便，进入操作之前先清空该缓存</span>
        redisTemplate.delete(key);
        <span class="hljs-comment">//获取有序集合SortedSet操作组件zSetOperations</span>
        ZSetOperations zSetOperations = redisTemplate.opsForZSet();
        <span class="hljs-keyword">for</span> (PhoneUser user : list) &#123;
            zSetOperations.add(key, user, user.getFare());
        &#125;
        <span class="hljs-comment">//前端获取访问充值排名靠前的用户列表</span>
        Long size = zSetOperations.size(key);
        <span class="hljs-comment">//从小到大排序</span>
        <span class="hljs-comment">//Set&lt;PhoneUser&gt; resSet = zSetOperations.range(key,0L,size);</span>
        <span class="hljs-comment">//从大到小排序</span>
        Set&lt;PhoneUser&gt; resSet = zSetOperations.reverseRange(key, <span class="hljs-number">0L</span>, size);
        <span class="hljs-comment">//遍历获取有序集合中的元素</span>
        <span class="hljs-keyword">for</span> (PhoneUser u : resSet) &#123;
            log.info(<span class="hljs-string">"从缓存中读取手机充值记录排序列表，当前记录：&#123;&#125;"</span>, u);
        &#125;
    &#125;</code></pre></div>

<p>效果：</p>
<div class="hljs"><pre><code class="hljs angelscript">[<span class="hljs-number">2021</span><span class="hljs-number">-01</span><span class="hljs-number">-04</span> <span class="hljs-number">13</span>:<span class="hljs-number">24</span>:<span class="hljs-number">38.038</span>] boot -  INFO [main] ---RedisTest2: 构造一组无序的用户手机充值对象列表：[PhoneUser(phone=<span class="hljs-number">103</span>, fare=<span class="hljs-number">130.0</span>), PhoneUser(phone=<span class="hljs-number">101</span>, fare=<span class="hljs-number">120.0</span>), PhoneUser(phone=<span class="hljs-number">105</span>, fare=<span class="hljs-number">110.0</span>), PhoneUser(phone=<span class="hljs-number">104</span>, fare=<span class="hljs-number">100.0</span>), PhoneUser(phone=<span class="hljs-number">106</span>, fare=<span class="hljs-number">150.0</span>), PhoneUser(phone=<span class="hljs-number">102</span>, fare=<span class="hljs-number">160.0</span>)]
[<span class="hljs-number">2021</span><span class="hljs-number">-01</span><span class="hljs-number">-04</span> <span class="hljs-number">13</span>:<span class="hljs-number">24</span>:<span class="hljs-number">38.038</span>] boot -  INFO [main] ---RedisTest2: 从缓存中读取手机充值记录排序列表，当前记录：PhoneUser(phone=<span class="hljs-number">102</span>, fare=<span class="hljs-number">160.0</span>)
[<span class="hljs-number">2021</span><span class="hljs-number">-01</span><span class="hljs-number">-04</span> <span class="hljs-number">13</span>:<span class="hljs-number">24</span>:<span class="hljs-number">38.038</span>] boot -  INFO [main] ---RedisTest2: 从缓存中读取手机充值记录排序列表，当前记录：PhoneUser(phone=<span class="hljs-number">106</span>, fare=<span class="hljs-number">150.0</span>)
[<span class="hljs-number">2021</span><span class="hljs-number">-01</span><span class="hljs-number">-04</span> <span class="hljs-number">13</span>:<span class="hljs-number">24</span>:<span class="hljs-number">38.038</span>] boot -  INFO [main] ---RedisTest2: 从缓存中读取手机充值记录排序列表，当前记录：PhoneUser(phone=<span class="hljs-number">103</span>, fare=<span class="hljs-number">130.0</span>)
[<span class="hljs-number">2021</span><span class="hljs-number">-01</span><span class="hljs-number">-04</span> <span class="hljs-number">13</span>:<span class="hljs-number">24</span>:<span class="hljs-number">38.038</span>] boot -  INFO [main] ---RedisTest2: 从缓存中读取手机充值记录排序列表，当前记录：PhoneUser(phone=<span class="hljs-number">101</span>, fare=<span class="hljs-number">120.0</span>)
[<span class="hljs-number">2021</span><span class="hljs-number">-01</span><span class="hljs-number">-04</span> <span class="hljs-number">13</span>:<span class="hljs-number">24</span>:<span class="hljs-number">38.038</span>] boot -  INFO [main] ---RedisTest2: 从缓存中读取手机充值记录排序列表，当前记录：PhoneUser(phone=<span class="hljs-number">105</span>, fare=<span class="hljs-number">110.0</span>)
[<span class="hljs-number">2021</span><span class="hljs-number">-01</span><span class="hljs-number">-04</span> <span class="hljs-number">13</span>:<span class="hljs-number">24</span>:<span class="hljs-number">38.038</span>] boot -  INFO [main] ---RedisTest2: 从缓存中读取手机充值记录排序列表，当前记录：PhoneUser(phone=<span class="hljs-number">104</span>, fare=<span class="hljs-number">100.0</span>)</code></pre></div>

<h3 id="哈希Hash存储"><a href="#哈希Hash存储" class="headerlink" title="哈希Hash存储"></a>哈希Hash存储</h3><p>Redis的哈希存储底层数据结构是由Key-value组成的映射表，value由Filed-Value对构成</p>
<p>需求：对学生对象列表和水果对象列表进行存储</p>
<p>核心代码：</p>
<div class="hljs"><pre><code class="hljs java"><span class="hljs-meta">@Data</span>
<span class="hljs-meta">@ToString</span>
<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Student</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">Serializable</span> </span>&#123;
    <span class="hljs-keyword">private</span> String id;
    <span class="hljs-keyword">private</span> String userName;
    <span class="hljs-keyword">private</span> String name;

    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">Student</span><span class="hljs-params">()</span> </span>&#123;
    &#125;

    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">Student</span><span class="hljs-params">(String id, String userName, String name)</span> </span>&#123;
        <span class="hljs-keyword">this</span>.id = id;
        <span class="hljs-keyword">this</span>.userName = userName;
        <span class="hljs-keyword">this</span>.name = name;
    &#125;
&#125;

<span class="hljs-meta">@Data</span>
<span class="hljs-meta">@ToString</span>
<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Fruit</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">Serializable</span> </span>&#123;
    <span class="hljs-keyword">private</span> String name;
    <span class="hljs-keyword">private</span> String color;

    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">Fruit</span><span class="hljs-params">()</span> </span>&#123;
    &#125;

    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">Fruit</span><span class="hljs-params">(String name, String color)</span> </span>&#123;
        <span class="hljs-keyword">this</span>.name = name;
        <span class="hljs-keyword">this</span>.color = color;
    &#125;
&#125;</code></pre></div>

<div class="hljs"><pre><code class="hljs java"><span class="hljs-meta">@Test</span>
<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">five</span><span class="hljs-params">()</span> </span>&#123;
    <span class="hljs-comment">//构造学生对象和水果对象列表</span>
    List&lt;Student&gt; students = <span class="hljs-keyword">new</span> ArrayList&lt;&gt;();
    List&lt;Fruit&gt; fruits = <span class="hljs-keyword">new</span> ArrayList&lt;&gt;();
    <span class="hljs-comment">//往学生集合中添加学生对象</span>
    students.add(<span class="hljs-keyword">new</span> Student(<span class="hljs-string">"10010"</span>, <span class="hljs-string">"debug"</span>, <span class="hljs-string">"大圣"</span>));
    students.add(<span class="hljs-keyword">new</span> Student(<span class="hljs-string">"10011"</span>, <span class="hljs-string">"jack"</span>, <span class="hljs-string">"修罗"</span>));
    students.add(<span class="hljs-keyword">new</span> Student(<span class="hljs-string">"10012"</span>, <span class="hljs-string">"sam"</span>, <span class="hljs-string">"上古"</span>));
    <span class="hljs-comment">//往水果集合中添加水果对象</span>
    fruits.add(<span class="hljs-keyword">new</span> Fruit(<span class="hljs-string">"apple"</span>, <span class="hljs-string">"红色"</span>));
    fruits.add(<span class="hljs-keyword">new</span> Fruit(<span class="hljs-string">"orange"</span>, <span class="hljs-string">"橙色"</span>));
    fruits.add(<span class="hljs-keyword">new</span> Fruit(<span class="hljs-string">"banana"</span>, <span class="hljs-string">"黄色"</span>));
    <span class="hljs-comment">//分别遍历不同的对象列表，并采用Hash存储至缓存中</span>
    <span class="hljs-keyword">final</span> String sKey = <span class="hljs-string">"redis:test:5"</span>;
    <span class="hljs-keyword">final</span> String fKey = <span class="hljs-string">"redis:test:6"</span>;
    <span class="hljs-comment">//获取Hash存储操作组件HashOperations，遍历获取集合中的对象并添加进缓存中</span>
    HashOperations hashOperations = redisTemplate.opsForHash();
    <span class="hljs-keyword">for</span> (Student student : students) &#123;
        hashOperations.put(sKey, student.getId(), student);
    &#125;
    <span class="hljs-keyword">for</span> (Fruit fruit : fruits) &#123;
        hashOperations.put(fKey, fruit.getName(), fruit);
    &#125;
    <span class="hljs-comment">//获取学生对象列表与水果对象列表</span>
    Map&lt;String, Student&gt; sMap = hashOperations.entries(sKey);
    log.info(<span class="hljs-string">"获取学生对象列表：&#123;&#125;"</span>, sMap);
    Map&lt;String, Fruit&gt; fMap = hashOperations.entries(fKey);
    log.info(<span class="hljs-string">"获取水果对象列表：&#123;&#125;"</span>, fMap);
    <span class="hljs-comment">//获取指定的学生对象</span>
    String SField = <span class="hljs-string">"10012"</span>;
    Student s = (Student) hashOperations.get(sKey, SField);
    log.info(<span class="hljs-string">"获取指定的学生对象：&#123;&#125; -&gt; &#123;&#125;"</span>, SField, s);

    <span class="hljs-comment">//获取指定的水果对象</span>
    String fField = <span class="hljs-string">"orange"</span>;
    Fruit f = (Fruit) hashOperations.get(fKey, fField);
    log.info(<span class="hljs-string">"获取指定的水果对象：&#123;&#125; -&gt; &#123;&#125;"</span>, fField, f);
&#125;</code></pre></div>

<p>效果</p>
<div class="hljs"><pre><code class="hljs routeros">[2021-01-04 13:50:14.014] boot -  <span class="hljs-builtin-name">INFO</span> [main] ---RedisTest2: 获取学生对象列表：&#123;<span class="hljs-attribute">10010</span>=Student(id=10010, <span class="hljs-attribute">userName</span>=debug, <span class="hljs-attribute">name</span>=大圣), <span class="hljs-attribute">10011</span>=Student(id=10011, <span class="hljs-attribute">userName</span>=jack, <span class="hljs-attribute">name</span>=修罗), <span class="hljs-attribute">10012</span>=Student(id=10012, <span class="hljs-attribute">userName</span>=sam, <span class="hljs-attribute">name</span>=上古)&#125;
[2021-01-04 13:50:14.014] boot -  <span class="hljs-builtin-name">INFO</span> [main] ---RedisTest2: 获取水果对象列表：&#123;<span class="hljs-attribute">apple</span>=Fruit(name=apple, <span class="hljs-attribute">color</span>=红色), <span class="hljs-attribute">banana</span>=Fruit(name=banana, <span class="hljs-attribute">color</span>=黄色), <span class="hljs-attribute">orange</span>=Fruit(name=orange, <span class="hljs-attribute">color</span>=橙色)&#125;
[2021-01-04 13:50:14.014] boot -  <span class="hljs-builtin-name">INFO</span> [main] ---RedisTest2: 获取指定的学生对象：10012 -&gt; Student(<span class="hljs-attribute">id</span>=10012, <span class="hljs-attribute">userName</span>=sam, <span class="hljs-attribute">name</span>=上古)
[2021-01-04 13:50:14.014] boot -  <span class="hljs-builtin-name">INFO</span> [main] ---RedisTest2: 获取指定的水果对象：orange -&gt; Fruit(<span class="hljs-attribute">name</span>=orange, <span class="hljs-attribute">color</span>=橙色)</code></pre></div>

<h3 id="Key失效与判断是否存在"><a href="#Key失效与判断是否存在" class="headerlink" title="Key失效与判断是否存在"></a>Key失效与判断是否存在</h3><p>在Redis缓存体系中，Delete与Expire操作都可以用于清理缓存中的Key，Delete需要手动触发，Expire只需提供一个TTL（过期时间），就能实现Key的自动失效。</p>
<p>下面代码演示如何使缓存中的Key失效：</p>
<p>方法一：调用SETEX方法中指定Key的过期时间</p>
<div class="hljs"><pre><code class="hljs java"><span class="hljs-meta">@Test</span>
 <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">six</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> InterruptedException </span>&#123;
     <span class="hljs-comment">//构造key与Redis操作组件ValueOperations</span>
     <span class="hljs-keyword">final</span> String key1 = <span class="hljs-string">"redis:test:6"</span>;
     ValueOperations valueOperations = redisTemplate.opsForValue();
     <span class="hljs-comment">//第一种方法：在往缓存中set数据时，提供一个TTL，表示ttl时间一到，缓存中的key将自动失效，即被清理</span>
     valueOperations.set(key1, <span class="hljs-string">"expire操作"</span>, <span class="hljs-number">10L</span>, TimeUnit.SECONDS);
     <span class="hljs-comment">//等待5秒-判断key是否还存在</span>
     Thread.sleep(<span class="hljs-number">5000</span>);
     Boolean expireKey1 = redisTemplate.hasKey(key1);
     Object value = valueOperations.get(key1);
     log.info(<span class="hljs-string">"等待5秒-判断key是否还存在：&#123;&#125;对应的值：&#123;&#125;"</span>, expireKey1, value);
     <span class="hljs-comment">//再等待5秒，判断key是否还存在</span>
     Thread.sleep(<span class="hljs-number">5000</span>);
     expireKey1 = redisTemplate.hasKey(key1);
     value = valueOperations.get(key1);
     log.info(<span class="hljs-string">"再等待5秒-再判断key是否还存在：&#123;&#125;对应的值：&#123;&#125;"</span>, expireKey1, value);
 &#125;</code></pre></div>

<p>效果</p>
<div class="hljs"><pre><code class="hljs angelscript">[<span class="hljs-number">2021</span><span class="hljs-number">-01</span><span class="hljs-number">-04</span> <span class="hljs-number">14</span>:<span class="hljs-number">02</span>:<span class="hljs-number">16.016</span>] boot -  INFO [main] ---RedisTest2: 等待<span class="hljs-number">5</span>秒-判断key是否还存在：<span class="hljs-literal">true</span>对应的值：expire操作
[<span class="hljs-number">2021</span><span class="hljs-number">-01</span><span class="hljs-number">-04</span> <span class="hljs-number">14</span>:<span class="hljs-number">02</span>:<span class="hljs-number">21.021</span>] boot -  INFO [main] ---RedisTest2: 再等待<span class="hljs-number">5</span>秒-再判断key是否还存在：<span class="hljs-literal">false</span>对应的值：<span class="hljs-literal">null</span></code></pre></div>

<p>方法二：采用RedisTemplate操作组件的Expire()方法指定失效的Key</p>
<div class="hljs"><pre><code class="hljs java"><span class="hljs-meta">@Test</span>
  <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">seven</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> InterruptedException </span>&#123;
      <span class="hljs-comment">//构造key和redis操作组件</span>
      <span class="hljs-keyword">final</span> String key2 = <span class="hljs-string">"redis:test：7"</span>;
      ValueOperations valueOperations = redisTemplate.opsForValue();
      <span class="hljs-comment">//第二种方法：在往缓存中set数据后，采用redisTemplate的expire方法使该key失效</span>
      valueOperations.set(key2,<span class="hljs-string">"expire操作-2"</span>);
      redisTemplate.expire(key2,<span class="hljs-number">10L</span>,TimeUnit.SECONDS);
      <span class="hljs-comment">//等待5秒-判断key是否还存在</span>
      Thread.sleep(<span class="hljs-number">5000</span>);
      Boolean expireKey = redisTemplate.hasKey(key2);
      Object value = valueOperations.get(key2);
      log.info(<span class="hljs-string">"等待5秒-判断key是否还存在：&#123;&#125;对应的值：&#123;&#125;"</span>, expireKey, value);
      <span class="hljs-comment">//再等待5秒，判断key是否还存在</span>
      Thread.sleep(<span class="hljs-number">5000</span>);
      expireKey = redisTemplate.hasKey(key2);
      value = valueOperations.get(key2);
      log.info(<span class="hljs-string">"再等待5秒-再判断key是否还存在：&#123;&#125;对应的值：&#123;&#125;"</span>, expireKey, value);
  &#125;</code></pre></div>

<p>通过RedisTemplate.hasKey()方法来判断缓存中的Key是否存在。</p>
<h2 id="Redis实战场景之缓存穿透"><a href="#Redis实战场景之缓存穿透" class="headerlink" title="Redis实战场景之缓存穿透"></a>Redis实战场景之缓存穿透</h2><p>缓存穿透：前端频繁请求数据库中不存在的数据</p>
<p>解决方案：当查询数据库时如果没有查询到数据，则将Null返回给前端用户，同时将该Null 数据塞入缓存中，并对对应的Key设置一定的过期时间。</p>
<p>实战：以”商城用户访问某个热销的商品“为案例</p>
<ol>
<li><p>在数据库中建立数据库表，命令为item</p>
<div class="hljs"><pre><code class="hljs sql"><span class="hljs-keyword">DROP</span> <span class="hljs-keyword">TABLE</span> <span class="hljs-keyword">IF</span> <span class="hljs-keyword">EXISTS</span> <span class="hljs-string">`item`</span>;
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> <span class="hljs-string">`item`</span> (
  <span class="hljs-string">`id`</span> <span class="hljs-built_in">int</span>(<span class="hljs-number">11</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span> AUTO_INCREMENT,
  <span class="hljs-string">`code`</span> <span class="hljs-built_in">varchar</span>(<span class="hljs-number">255</span>) <span class="hljs-keyword">DEFAULT</span> <span class="hljs-literal">NULL</span> <span class="hljs-keyword">COMMENT</span> <span class="hljs-string">'商品编号'</span>,
  <span class="hljs-string">`name`</span> <span class="hljs-built_in">varchar</span>(<span class="hljs-number">255</span>) <span class="hljs-built_in">CHARACTER</span> <span class="hljs-keyword">SET</span> utf8mb4 <span class="hljs-keyword">DEFAULT</span> <span class="hljs-literal">NULL</span> <span class="hljs-keyword">COMMENT</span> <span class="hljs-string">'商品名称'</span>,
  <span class="hljs-string">`create_time`</span> datetime <span class="hljs-keyword">DEFAULT</span> <span class="hljs-literal">NULL</span>,
  PRIMARY <span class="hljs-keyword">KEY</span> (<span class="hljs-string">`id`</span>)
) <span class="hljs-keyword">ENGINE</span>=<span class="hljs-keyword">InnoDB</span> AUTO_INCREMENT=<span class="hljs-number">2</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">CHARSET</span>=utf8 <span class="hljs-keyword">COMMENT</span>=<span class="hljs-string">'商品信息表'</span>;</code></pre></div>

<p>在数据库表创建一条记录，code取值为“book_10010”，name取值为”分布式中间件实战“，create_time取值为当前时间。</p>
</li>
<li><p>采用MyBatis的逆向工程生成该实体类对应的Model，Mapper和Mapper.xml，并将这三个文件存放至model模块下不同的目录中</p>
<div class="hljs"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Item</span> </span>&#123;
    <span class="hljs-keyword">private</span> Integer id;
    <span class="hljs-keyword">private</span> String code;
    <span class="hljs-keyword">private</span> String name;
    <span class="hljs-meta">@JsonFormat</span>(pattern = <span class="hljs-string">"yyyy-MM-dd HH:mm:ss"</span>,timezone = <span class="hljs-string">"GMT+8"</span>)
    <span class="hljs-keyword">private</span> Date createTime;

    <span class="hljs-function"><span class="hljs-keyword">public</span> Integer <span class="hljs-title">getId</span><span class="hljs-params">()</span> </span>&#123;
        <span class="hljs-keyword">return</span> id;
    &#125;

    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setId</span><span class="hljs-params">(Integer id)</span> </span>&#123;
        <span class="hljs-keyword">this</span>.id = id;
    &#125;

    <span class="hljs-function"><span class="hljs-keyword">public</span> String <span class="hljs-title">getCode</span><span class="hljs-params">()</span> </span>&#123;
        <span class="hljs-keyword">return</span> code;
    &#125;

    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setCode</span><span class="hljs-params">(String code)</span> </span>&#123;
        <span class="hljs-keyword">this</span>.code = code;
    &#125;

    <span class="hljs-function"><span class="hljs-keyword">public</span> String <span class="hljs-title">getName</span><span class="hljs-params">()</span> </span>&#123;
        <span class="hljs-keyword">return</span> name;
    &#125;

    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setName</span><span class="hljs-params">(String name)</span> </span>&#123;
        <span class="hljs-keyword">this</span>.name = name;
    &#125;

    <span class="hljs-function"><span class="hljs-keyword">public</span> Date <span class="hljs-title">getCreateTime</span><span class="hljs-params">()</span> </span>&#123;
        <span class="hljs-keyword">return</span> createTime;
    &#125;

    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setCreateTime</span><span class="hljs-params">(Date createTime)</span> </span>&#123;
        <span class="hljs-keyword">this</span>.createTime = createTime;
    &#125;
&#125;</code></pre></div>

<div class="hljs"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">interface</span> <span class="hljs-title">ItemMapper</span> </span>&#123;
    <span class="hljs-comment">/**</span>
<span class="hljs-comment">     * 此为MyBatis逆向工程自动生成的方法-增、删、改、查</span>
<span class="hljs-comment">     */</span>
    <span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">deleteByPrimaryKey</span><span class="hljs-params">(Integer id)</span></span>;

    <span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">insert</span><span class="hljs-params">(Item record)</span></span>;

    <span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">insertSelective</span><span class="hljs-params">(Item record)</span></span>;

    <span class="hljs-function">Item <span class="hljs-title">selectByPrimaryKey</span><span class="hljs-params">(Integer id)</span></span>;

    <span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">updateByPrimaryKeySelective</span><span class="hljs-params">(Item record)</span></span>;

    <span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">updateByPrimaryKey</span><span class="hljs-params">(Item record)</span></span>;

    <span class="hljs-comment">/**</span>
<span class="hljs-comment">     * 根据商品编码，查询商品详情</span>
<span class="hljs-comment">     */</span>
    <span class="hljs-function">Item <span class="hljs-title">selectByCode</span><span class="hljs-params">(@Param(<span class="hljs-string">"code"</span>)</span> String code)</span>;

&#125;</code></pre></div>

<div class="hljs"><pre><code class="hljs xml"><span class="hljs-meta">&lt;?xml version="1.0" encoding="UTF-8" ?&gt;</span>
<span class="hljs-meta">&lt;!DOCTYPE <span class="hljs-meta-keyword">mapper</span> <span class="hljs-meta-keyword">PUBLIC</span> <span class="hljs-meta-string">"-//mybatis.org//DTD Mapper 3.0//EN"</span> <span class="hljs-meta-string">"http://mybatis.org/dtd/mybatis-3-mapper.dtd"</span> &gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">mapper</span> <span class="hljs-attr">namespace</span>=<span class="hljs-string">"com.debug.middleware.model.mapper.ItemMapper"</span> &gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">resultMap</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"BaseResultMap"</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"com.debug.middleware.model.entity.Item"</span> &gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">id</span> <span class="hljs-attr">column</span>=<span class="hljs-string">"id"</span> <span class="hljs-attr">property</span>=<span class="hljs-string">"id"</span> <span class="hljs-attr">jdbcType</span>=<span class="hljs-string">"INTEGER"</span> /&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">result</span> <span class="hljs-attr">column</span>=<span class="hljs-string">"code"</span> <span class="hljs-attr">property</span>=<span class="hljs-string">"code"</span> <span class="hljs-attr">jdbcType</span>=<span class="hljs-string">"VARCHAR"</span> /&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">result</span> <span class="hljs-attr">column</span>=<span class="hljs-string">"name"</span> <span class="hljs-attr">property</span>=<span class="hljs-string">"name"</span> <span class="hljs-attr">jdbcType</span>=<span class="hljs-string">"VARCHAR"</span> /&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">result</span> <span class="hljs-attr">column</span>=<span class="hljs-string">"create_time"</span> <span class="hljs-attr">property</span>=<span class="hljs-string">"createTime"</span> <span class="hljs-attr">jdbcType</span>=<span class="hljs-string">"TIMESTAMP"</span> /&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">resultMap</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">sql</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"Base_Column_List"</span> &gt;</span>
        id, code, name, create_time
    <span class="hljs-tag">&lt;/<span class="hljs-name">sql</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">select</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"selectByPrimaryKey"</span> <span class="hljs-attr">resultMap</span>=<span class="hljs-string">"BaseResultMap"</span> <span class="hljs-attr">parameterType</span>=<span class="hljs-string">"java.lang.Integer"</span> &gt;</span>
        select
        <span class="hljs-tag">&lt;<span class="hljs-name">include</span> <span class="hljs-attr">refid</span>=<span class="hljs-string">"Base_Column_List"</span> /&gt;</span>
        from item
        where id = #&#123;id,jdbcType=INTEGER&#125;
    <span class="hljs-tag">&lt;/<span class="hljs-name">select</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">delete</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"deleteByPrimaryKey"</span> <span class="hljs-attr">parameterType</span>=<span class="hljs-string">"java.lang.Integer"</span> &gt;</span>
        delete from item
        where id = #&#123;id,jdbcType=INTEGER&#125;
    <span class="hljs-tag">&lt;/<span class="hljs-name">delete</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">insert</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"insert"</span> <span class="hljs-attr">parameterType</span>=<span class="hljs-string">"com.debug.middleware.model.entity.Item"</span> &gt;</span>
        insert into item (id, code, name,
                          create_time)
        values (#&#123;id,jdbcType=INTEGER&#125;, #&#123;code,jdbcType=VARCHAR&#125;, #&#123;name,jdbcType=VARCHAR&#125;,
                #&#123;createTime,jdbcType=TIMESTAMP&#125;)
    <span class="hljs-tag">&lt;/<span class="hljs-name">insert</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">insert</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"insertSelective"</span> <span class="hljs-attr">parameterType</span>=<span class="hljs-string">"com.debug.middleware.model.entity.Item"</span> &gt;</span>
        insert into item
        <span class="hljs-tag">&lt;<span class="hljs-name">trim</span> <span class="hljs-attr">prefix</span>=<span class="hljs-string">"("</span> <span class="hljs-attr">suffix</span>=<span class="hljs-string">")"</span> <span class="hljs-attr">suffixOverrides</span>=<span class="hljs-string">","</span> &gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">if</span> <span class="hljs-attr">test</span>=<span class="hljs-string">"id != null"</span> &gt;</span>
                id,
            <span class="hljs-tag">&lt;/<span class="hljs-name">if</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">if</span> <span class="hljs-attr">test</span>=<span class="hljs-string">"code != null"</span> &gt;</span>
                code,
            <span class="hljs-tag">&lt;/<span class="hljs-name">if</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">if</span> <span class="hljs-attr">test</span>=<span class="hljs-string">"name != null"</span> &gt;</span>
                name,
            <span class="hljs-tag">&lt;/<span class="hljs-name">if</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">if</span> <span class="hljs-attr">test</span>=<span class="hljs-string">"createTime != null"</span> &gt;</span>
                create_time,
            <span class="hljs-tag">&lt;/<span class="hljs-name">if</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">trim</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">trim</span> <span class="hljs-attr">prefix</span>=<span class="hljs-string">"values ("</span> <span class="hljs-attr">suffix</span>=<span class="hljs-string">")"</span> <span class="hljs-attr">suffixOverrides</span>=<span class="hljs-string">","</span> &gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">if</span> <span class="hljs-attr">test</span>=<span class="hljs-string">"id != null"</span> &gt;</span>
                #&#123;id,jdbcType=INTEGER&#125;,
            <span class="hljs-tag">&lt;/<span class="hljs-name">if</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">if</span> <span class="hljs-attr">test</span>=<span class="hljs-string">"code != null"</span> &gt;</span>
                #&#123;code,jdbcType=VARCHAR&#125;,
            <span class="hljs-tag">&lt;/<span class="hljs-name">if</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">if</span> <span class="hljs-attr">test</span>=<span class="hljs-string">"name != null"</span> &gt;</span>
                #&#123;name,jdbcType=VARCHAR&#125;,
            <span class="hljs-tag">&lt;/<span class="hljs-name">if</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">if</span> <span class="hljs-attr">test</span>=<span class="hljs-string">"createTime != null"</span> &gt;</span>
                #&#123;createTime,jdbcType=TIMESTAMP&#125;,
            <span class="hljs-tag">&lt;/<span class="hljs-name">if</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">trim</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">insert</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">update</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"updateByPrimaryKeySelective"</span> <span class="hljs-attr">parameterType</span>=<span class="hljs-string">"com.debug.middleware.model.entity.Item"</span> &gt;</span>
        update item
        <span class="hljs-tag">&lt;<span class="hljs-name">set</span> &gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">if</span> <span class="hljs-attr">test</span>=<span class="hljs-string">"code != null"</span> &gt;</span>
                code = #&#123;code,jdbcType=VARCHAR&#125;,
            <span class="hljs-tag">&lt;/<span class="hljs-name">if</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">if</span> <span class="hljs-attr">test</span>=<span class="hljs-string">"name != null"</span> &gt;</span>
                name = #&#123;name,jdbcType=VARCHAR&#125;,
            <span class="hljs-tag">&lt;/<span class="hljs-name">if</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">if</span> <span class="hljs-attr">test</span>=<span class="hljs-string">"createTime != null"</span> &gt;</span>
                create_time = #&#123;createTime,jdbcType=TIMESTAMP&#125;,
            <span class="hljs-tag">&lt;/<span class="hljs-name">if</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">set</span>&gt;</span>
        where id = #&#123;id,jdbcType=INTEGER&#125;
    <span class="hljs-tag">&lt;/<span class="hljs-name">update</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">update</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"updateByPrimaryKey"</span> <span class="hljs-attr">parameterType</span>=<span class="hljs-string">"com.debug.middleware.model.entity.Item"</span> &gt;</span>
        update item
        set code = #&#123;code,jdbcType=VARCHAR&#125;,
            name = #&#123;name,jdbcType=VARCHAR&#125;,
            create_time = #&#123;createTime,jdbcType=TIMESTAMP&#125;
        where id = #&#123;id,jdbcType=INTEGER&#125;
    <span class="hljs-tag">&lt;/<span class="hljs-name">update</span>&gt;</span>

    <span class="hljs-comment">&lt;!--根据商品编码查询--&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">select</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"selectByCode"</span> <span class="hljs-attr">resultType</span>=<span class="hljs-string">"com.debug.middleware.model.entity.Item"</span>&gt;</span>
        select
        <span class="hljs-tag">&lt;<span class="hljs-name">include</span> <span class="hljs-attr">refid</span>=<span class="hljs-string">"Base_Column_List"</span> /&gt;</span>
        from item
        where code = #&#123;code&#125;
    <span class="hljs-tag">&lt;/<span class="hljs-name">select</span>&gt;</span>

<span class="hljs-tag">&lt;/<span class="hljs-name">mapper</span>&gt;</span></code></pre></div>
</li>
<li><p>在启动类MainApplication加上@MapperScan注解，用于扫描MyBatis动态SQL对应的Mapper接口所在的包。</p>
<div class="hljs"><pre><code class="hljs java"><span class="hljs-meta">@MapperScan</span>(basePackages = <span class="hljs-string">"com.debug.middleware.model"</span>)</code></pre></div>
</li>
<li><p>建立对应的控制层Controller与实际业务逻辑处理层Service</p>
<div class="hljs"><pre><code class="hljs java"><span class="hljs-meta">@RestController</span>
<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">CachePassController</span> </span>&#123;
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> Logger log = LoggerFactory.getLogger(CachePassController<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> String prefix = <span class="hljs-string">"cache/pass"</span>;
    <span class="hljs-comment">/**</span>
<span class="hljs-comment">     * 定义缓存穿透处理服务类</span>
<span class="hljs-comment">     */</span>
    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> CachePassService cachePassService;

    <span class="hljs-comment">/**</span>
<span class="hljs-comment">     * 获取热销商品信息</span>
<span class="hljs-comment">     */</span>
    <span class="hljs-meta">@RequestMapping</span>(value = prefix + <span class="hljs-string">"/item/info"</span>, method = RequestMethod.GET)
    <span class="hljs-function"><span class="hljs-keyword">public</span> Map&lt;String, Object&gt; <span class="hljs-title">getItem</span><span class="hljs-params">(@RequestParam String itemCode)</span> </span>&#123;
        <span class="hljs-comment">//定义接口返回的格式，主要包括code，msg和data</span>
        Map&lt;String, Object&gt; resMap = <span class="hljs-keyword">new</span> HashMap&lt;&gt;();
        resMap.put(<span class="hljs-string">"code"</span>, <span class="hljs-number">0</span>);
        resMap.put(<span class="hljs-string">"msg"</span>, <span class="hljs-string">"成功"</span>);
        <span class="hljs-keyword">try</span> &#123;
            <span class="hljs-comment">//调用缓存穿透处理服务类得到返回结果，并将其添加进结果Map中</span>
            resMap.put(<span class="hljs-string">"data"</span>, cachePassService.getItemInfo(itemCode));
        &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;
            resMap.put(<span class="hljs-string">"code"</span>, -<span class="hljs-number">1</span>);
            resMap.put(<span class="hljs-string">"msg"</span>, <span class="hljs-string">"失败"</span> + e.getMessage());
        &#125;
        <span class="hljs-keyword">return</span> resMap;
    &#125;
&#125;</code></pre></div>

<div class="hljs"><pre><code class="hljs java"><span class="hljs-meta">@Service</span>
<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">CachePassService</span> </span>&#123;
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> Logger log = LoggerFactory.getLogger(CachePassService<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
    <span class="hljs-comment">/**</span>
<span class="hljs-comment">     * 定义Mapper</span>
<span class="hljs-comment">     */</span>
    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> ItemMapper itemMapper;
    <span class="hljs-comment">/**</span>
<span class="hljs-comment">     * 定义Redis操作组件RedisTemplate</span>
<span class="hljs-comment">     */</span>
    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> RedisTemplate redisTemplate;

    <span class="hljs-comment">/**</span>
<span class="hljs-comment">     * 定义JSON序列化与反序列化框架</span>
<span class="hljs-comment">     */</span>
    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> ObjectMapper objectMapper;
    <span class="hljs-comment">/**</span>
<span class="hljs-comment">     * 定义缓存中key命名的前缀</span>
<span class="hljs-comment">     */</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> String keyPrefix = <span class="hljs-string">"item:"</span>;

    <span class="hljs-comment">/**</span>
<span class="hljs-comment">     * 获取商品详情，如果缓存有，则从缓存中取，如果没有，则从数据库中查询，并将查询结果塞入缓存中</span>
<span class="hljs-comment">     */</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> Item <span class="hljs-title">getItemInfo</span><span class="hljs-params">(String itemCode)</span> <span class="hljs-keyword">throws</span> IOException </span>&#123;
        <span class="hljs-comment">//定义商品对象</span>
        Item item = <span class="hljs-keyword">null</span>;
        <span class="hljs-comment">//定义缓存中真正的key：由前缀和商品编码组成</span>
        <span class="hljs-keyword">final</span> String key = keyPrefix + itemCode;
        <span class="hljs-comment">//定义Redis的操作组件ValueOperations</span>
        ValueOperations valueOperations = redisTemplate.opsForValue();
        <span class="hljs-keyword">if</span> (redisTemplate.hasKey(key)) &#123;
            log.info(<span class="hljs-string">"---获取商品详情-缓存中存在该商品---商品编号为：&#123;&#125;"</span>, itemCode);
            <span class="hljs-comment">//从缓存中查询该商品详情</span>
            Object res = valueOperations.get(key);
            <span class="hljs-keyword">if</span> (res != <span class="hljs-keyword">null</span> &amp;&amp; !Strings.isNullOrEmpty(res.toString())) &#123;
                <span class="hljs-comment">//如果可以找到该商品，则进行JSON反序列化解析</span>
                item = objectMapper.readValue(res.toString(), Item<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
            &#125;
        &#125;<span class="hljs-keyword">else</span> &#123;
            <span class="hljs-comment">//如果缓存中没有找到该商品</span>
            log.info(<span class="hljs-string">"---获取商品详情-缓存中不存在该商品-从数据库中查询---商品编号为“&#123;&#125;"</span>, itemCode);
            <span class="hljs-comment">//从数据库中获取该商品详情</span>
            item = itemMapper.selectByCode(itemCode);
            <span class="hljs-keyword">if</span> (item != <span class="hljs-keyword">null</span>) &#123;
                <span class="hljs-comment">//如果数据库中查得到该商品，则将其序列化后写入缓存中</span>
                valueOperations.set(key, objectMapper.writeValueAsString(item));
            &#125; <span class="hljs-keyword">else</span> &#123;
                <span class="hljs-comment">//过期失效时间TTL设置为30分钟，“ ”很关键</span>
                valueOperations.set(key, <span class="hljs-string">" "</span>, <span class="hljs-number">30L</span>, TimeUnit.MINUTES);
            &#125;
        &#125;
        <span class="hljs-keyword">return</span> item;
    &#125;
&#125;</code></pre></div>
</li>
<li><p>运行</p>
<p>这里出现异常，原因是数据库依赖版本与实际数据库不一致，这里进行如下修改：</p>
<div class="hljs"><pre><code class="hljs properties"><span class="hljs-comment">#数据库访问配置</span>
<span class="hljs-comment">#spring.datasource.url=jdbc:mysql://localhost:3306/db_middleware?useUnicode=true&amp;amp;characterEncoding=utf-8</span>
<span class="hljs-meta">spring.datasource.driver-class-name</span>=<span class="hljs-string">com.mysql.cj.jdbc.Driver</span>
<span class="hljs-meta">spring.datasource.url</span>=<span class="hljs-string">jdbc:mysql://127.0.0.1:3306/db_middleware?useUnicode=true&amp;characterEncoding=utf-8&amp;useJDBCCompliantTimezoneShift=true&amp;useLegacyDatetimeCode=false&amp;serverTimezone=UTC</span></code></pre></div>

<div class="hljs"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">mysql.version</span>&gt;</span>8.0.19<span class="hljs-tag">&lt;/<span class="hljs-name">mysql.version</span>&gt;</span></code></pre></div>

<p>最终效果：在浏览器中输入<a href="http://localhost:8087/middleware/cache/pass/item/info?itemCode=book_10010，运行窗口第一次打印数据是从数据库中查询得到，第二次是从缓存中获取。" target="_blank" rel="noopener">http://localhost:8087/middleware/cache/pass/item/info?itemCode=book_10010，运行窗口第一次打印数据是从数据库中查询得到，第二次是从缓存中获取。</a></p>
<div class="hljs"><pre><code class="hljs angelscript">[<span class="hljs-number">2021</span><span class="hljs-number">-01</span><span class="hljs-number">-05</span> <span class="hljs-number">11</span>:<span class="hljs-number">19</span>:<span class="hljs-number">15.015</span>] boot -  INFO [http-nio<span class="hljs-number">-8087</span>-exec<span class="hljs-number">-1</span>] ---CachePassService: ---获取商品详情-缓存中不存在该商品-从数据库中查询---商品编号为“book_10010
[<span class="hljs-number">2021</span><span class="hljs-number">-01</span><span class="hljs-number">-05</span> <span class="hljs-number">11</span>:<span class="hljs-number">19</span>:<span class="hljs-number">23.023</span>] boot -  INFO [http-nio<span class="hljs-number">-8087</span>-exec<span class="hljs-number">-2</span>] ---CachePassService: ---获取商品详情-缓存中存在该商品---商品编号为：book_10010</code></pre></div>

<p>如果查找一个不存在的商品，第一次会从数据库中查询，后面都是从缓存中查询</p>
<div class="hljs"><pre><code class="hljs angelscript">[<span class="hljs-number">2021</span><span class="hljs-number">-01</span><span class="hljs-number">-05</span> <span class="hljs-number">11</span>:<span class="hljs-number">29</span>:<span class="hljs-number">50.050</span>] boot -  INFO [http-nio<span class="hljs-number">-8087</span>-exec<span class="hljs-number">-1</span>] ---CachePassService: ---获取商品详情-缓存中不存在该商品-从数据库中查询---商品编号为“book_10012
[<span class="hljs-number">2021</span><span class="hljs-number">-01</span><span class="hljs-number">-05</span> <span class="hljs-number">11</span>:<span class="hljs-number">29</span>:<span class="hljs-number">56.056</span>] boot -  INFO [http-nio<span class="hljs-number">-8087</span>-exec<span class="hljs-number">-2</span>] ---CachePassService: ---获取商品详情-缓存中存在该商品---商品编号为：book_10012
[<span class="hljs-number">2021</span><span class="hljs-number">-01</span><span class="hljs-number">-05</span> <span class="hljs-number">11</span>:<span class="hljs-number">30</span>:<span class="hljs-number">00.000</span>] boot -  INFO [http-nio<span class="hljs-number">-8087</span>-exec<span class="hljs-number">-3</span>] ---CachePassService: ---获取商品详情-缓存中存在该商品---商品编号为：book_10012</code></pre></div>

</li>
</ol>
<h3 id="其他典型问题介绍"><a href="#其他典型问题介绍" class="headerlink" title="其他典型问题介绍"></a>其他典型问题介绍</h3><p>缓存雪崩：缓存中的Key集体失效，解决办法：为这些Key设置不同的，随机的过期时间</p>
<p>缓存击穿：热点事件，解决办法：让这个Key永不失效</p>
<h1 id="第4章：Redis典型应用场景实战之抢红包系统"><a href="#第4章：Redis典型应用场景实战之抢红包系统" class="headerlink" title="第4章：Redis典型应用场景实战之抢红包系统"></a>第4章：Redis典型应用场景实战之抢红包系统</h1><h2 id="4-1-整体业务流程介绍"><a href="#4-1-整体业务流程介绍" class="headerlink" title="4.1 整体业务流程介绍"></a>4.1 整体业务流程介绍</h2><p>系统整体业务流程主要由两大业务组成：发红包和抢红包，其中抢红包可以分为用户点红包和用户拆红包。</p>
<p>抢红包系统整体业务模块划分：</p>
<ul>
<li>发红包模块：主要包括接受并处理用户发红包请求的逻辑处理</li>
<li>抢红包模块：主要包括用户点红包和拆红包请求的逻辑处理</li>
<li>数据操作DB模块：主要包括系统整体业务逻辑处理过程中的数据记录</li>
<li>缓存中间件Redis模块：主要用于缓存红包个数以及红包随机金额</li>
</ul>
<h2 id="4-2-数据库表设计与环境搭建"><a href="#4-2-数据库表设计与环境搭建" class="headerlink" title="4.2 数据库表设计与环境搭建"></a>4.2 数据库表设计与环境搭建</h2><h3 id="4-2-1-数据库表设计"><a href="#4-2-1-数据库表设计" class="headerlink" title="4.2.1 数据库表设计"></a>4.2.1 数据库表设计</h3><p>发红包记录表</p>
<div class="hljs"><pre><code class="hljs sql"><span class="hljs-keyword">DROP</span> <span class="hljs-keyword">TABLE</span> <span class="hljs-keyword">IF</span> <span class="hljs-keyword">EXISTS</span> <span class="hljs-string">`red_record`</span>;
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> <span class="hljs-string">`red_record`</span> (
  <span class="hljs-string">`id`</span> <span class="hljs-built_in">int</span>(<span class="hljs-number">11</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span> AUTO_INCREMENT,
  <span class="hljs-string">`user_id`</span> <span class="hljs-built_in">int</span>(<span class="hljs-number">11</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span> <span class="hljs-keyword">COMMENT</span> <span class="hljs-string">'用户id'</span>,
  <span class="hljs-string">`red_packet`</span> <span class="hljs-built_in">varchar</span>(<span class="hljs-number">255</span>) <span class="hljs-built_in">CHARACTER</span> <span class="hljs-keyword">SET</span> utf8mb4 <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span> <span class="hljs-keyword">COMMENT</span> <span class="hljs-string">'红包全局唯一标识串'</span>,
  <span class="hljs-string">`total`</span> <span class="hljs-built_in">int</span>(<span class="hljs-number">11</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span> <span class="hljs-keyword">COMMENT</span> <span class="hljs-string">'人数'</span>,
  <span class="hljs-string">`amount`</span> <span class="hljs-built_in">decimal</span>(<span class="hljs-number">10</span>,<span class="hljs-number">2</span>) <span class="hljs-keyword">DEFAULT</span> <span class="hljs-literal">NULL</span> <span class="hljs-keyword">COMMENT</span> <span class="hljs-string">'总金额（单位为分）'</span>,
  <span class="hljs-string">`is_active`</span> <span class="hljs-built_in">tinyint</span>(<span class="hljs-number">4</span>) <span class="hljs-keyword">DEFAULT</span> <span class="hljs-string">'1'</span>,
  <span class="hljs-string">`create_time`</span> datetime <span class="hljs-keyword">DEFAULT</span> <span class="hljs-literal">NULL</span>,
  PRIMARY <span class="hljs-keyword">KEY</span> (<span class="hljs-string">`id`</span>)
) <span class="hljs-keyword">ENGINE</span>=<span class="hljs-keyword">InnoDB</span> AUTO_INCREMENT=<span class="hljs-number">16</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">CHARSET</span>=utf8 <span class="hljs-keyword">COMMENT</span>=<span class="hljs-string">'发红包记录'</span>;</code></pre></div>

<p>红包随机金额明细表</p>
<div class="hljs"><pre><code class="hljs sql"><span class="hljs-keyword">DROP</span> <span class="hljs-keyword">TABLE</span> <span class="hljs-keyword">IF</span> <span class="hljs-keyword">EXISTS</span> <span class="hljs-string">`red_detail`</span>;
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> <span class="hljs-string">`red_detail`</span> (
  <span class="hljs-string">`id`</span> <span class="hljs-built_in">int</span>(<span class="hljs-number">11</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span> AUTO_INCREMENT,
  <span class="hljs-string">`record_id`</span> <span class="hljs-built_in">int</span>(<span class="hljs-number">11</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span> <span class="hljs-keyword">COMMENT</span> <span class="hljs-string">'红包记录id'</span>,
  <span class="hljs-string">`amount`</span> <span class="hljs-built_in">decimal</span>(<span class="hljs-number">8</span>,<span class="hljs-number">2</span>) <span class="hljs-keyword">DEFAULT</span> <span class="hljs-literal">NULL</span> <span class="hljs-keyword">COMMENT</span> <span class="hljs-string">'金额（单位为分）'</span>,
  <span class="hljs-string">`is_active`</span> <span class="hljs-built_in">tinyint</span>(<span class="hljs-number">4</span>) <span class="hljs-keyword">DEFAULT</span> <span class="hljs-string">'1'</span>,
  <span class="hljs-string">`create_time`</span> datetime <span class="hljs-keyword">DEFAULT</span> <span class="hljs-literal">NULL</span>,
  PRIMARY <span class="hljs-keyword">KEY</span> (<span class="hljs-string">`id`</span>)
) <span class="hljs-keyword">ENGINE</span>=<span class="hljs-keyword">InnoDB</span> AUTO_INCREMENT=<span class="hljs-number">133</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">CHARSET</span>=utf8 <span class="hljs-keyword">COMMENT</span>=<span class="hljs-string">'红包明细金额'</span>;</code></pre></div>

<p>抢红包记录表</p>
<div class="hljs"><pre><code class="hljs sql"><span class="hljs-keyword">DROP</span> <span class="hljs-keyword">TABLE</span> <span class="hljs-keyword">IF</span> <span class="hljs-keyword">EXISTS</span> <span class="hljs-string">`red_rob_record`</span>;
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> <span class="hljs-string">`red_rob_record`</span> (
  <span class="hljs-string">`id`</span> <span class="hljs-built_in">int</span>(<span class="hljs-number">11</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span> AUTO_INCREMENT,
  <span class="hljs-string">`user_id`</span> <span class="hljs-built_in">int</span>(<span class="hljs-number">11</span>) <span class="hljs-keyword">DEFAULT</span> <span class="hljs-literal">NULL</span> <span class="hljs-keyword">COMMENT</span> <span class="hljs-string">'用户账号'</span>,
  <span class="hljs-string">`red_packet`</span> <span class="hljs-built_in">varchar</span>(<span class="hljs-number">255</span>) <span class="hljs-built_in">CHARACTER</span> <span class="hljs-keyword">SET</span> utf8mb4 <span class="hljs-keyword">DEFAULT</span> <span class="hljs-literal">NULL</span> <span class="hljs-keyword">COMMENT</span> <span class="hljs-string">'红包标识串'</span>,
  <span class="hljs-string">`amount`</span> <span class="hljs-built_in">decimal</span>(<span class="hljs-number">8</span>,<span class="hljs-number">2</span>) <span class="hljs-keyword">DEFAULT</span> <span class="hljs-literal">NULL</span> <span class="hljs-keyword">COMMENT</span> <span class="hljs-string">'红包金额（单位为分）'</span>,
  <span class="hljs-string">`rob_time`</span> datetime <span class="hljs-keyword">DEFAULT</span> <span class="hljs-literal">NULL</span> <span class="hljs-keyword">COMMENT</span> <span class="hljs-string">'时间'</span>,
  <span class="hljs-string">`is_active`</span> <span class="hljs-built_in">tinyint</span>(<span class="hljs-number">4</span>) <span class="hljs-keyword">DEFAULT</span> <span class="hljs-string">'1'</span>,
  PRIMARY <span class="hljs-keyword">KEY</span> (<span class="hljs-string">`id`</span>)
) <span class="hljs-keyword">ENGINE</span>=<span class="hljs-keyword">InnoDB</span> AUTO_INCREMENT=<span class="hljs-number">118</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">CHARSET</span>=utf8 <span class="hljs-keyword">COMMENT</span>=<span class="hljs-string">'抢红包记录'</span>;</code></pre></div>

<h3 id="4-2-2-开发环境搭建"><a href="#4-2-2-开发环境搭建" class="headerlink" title="4.2.2 开发环境搭建"></a>4.2.2 开发环境搭建</h3><p>1、开发三个实体类</p>
<p>发红包记录实体类</p>
<div class="hljs"><pre><code class="hljs java"><span class="hljs-meta">@Data</span>
<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">RedRecord</span> </span>&#123;
    <span class="hljs-keyword">private</span> Integer id;
    <span class="hljs-keyword">private</span> Integer userId;
    <span class="hljs-keyword">private</span> String redPacket;
    <span class="hljs-keyword">private</span> Integer total;
    <span class="hljs-keyword">private</span> BigDecimal amount;
    <span class="hljs-keyword">private</span> Byte isActive;
    <span class="hljs-keyword">private</span> Date createTime;
&#125;</code></pre></div>

<p>红包金额明细实体类</p>
<div class="hljs"><pre><code class="hljs java"><span class="hljs-meta">@Data</span>
<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">RedDetail</span> </span>&#123;
    <span class="hljs-keyword">private</span> Integer id;
    <span class="hljs-keyword">private</span> Integer recordId;
    <span class="hljs-keyword">private</span> BigDecimal amount;
    <span class="hljs-keyword">private</span> Byte isActive;
    <span class="hljs-keyword">private</span> Date createTime;
&#125;</code></pre></div>

<p>抢到红包时金额等相关信息记录表</p>
<div class="hljs"><pre><code class="hljs java"><span class="hljs-meta">@Data</span>
<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">RedRobRecord</span> </span>&#123;
    <span class="hljs-keyword">private</span> Integer id;
    <span class="hljs-keyword">private</span> Integer userId;
    <span class="hljs-keyword">private</span> String redPacket;
    <span class="hljs-keyword">private</span> BigDecimal amount;
    <span class="hljs-keyword">private</span> Date robTime;
    <span class="hljs-keyword">private</span> Byte isActive;
&#125;</code></pre></div>

<p>2、开发3个Mapper接口</p>
<div class="hljs"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">interface</span> <span class="hljs-title">RedRecordMapper</span> </span>&#123;
    <span class="hljs-comment">/**</span>
<span class="hljs-comment">     * 根据主键id删除</span>
<span class="hljs-comment">     */</span>
    <span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">deleteByPrimaryKey</span><span class="hljs-params">(Integer id)</span></span>;

    <span class="hljs-comment">/**</span>
<span class="hljs-comment">     * 插入数据记录</span>
<span class="hljs-comment">     */</span>
    <span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">insert</span><span class="hljs-params">(RedRecord record)</span></span>;

    <span class="hljs-comment">/**</span>
<span class="hljs-comment">     * 插入数据记录</span>
<span class="hljs-comment">     */</span>
    <span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">insertSelective</span><span class="hljs-params">(RedRecord record)</span></span>;

    <span class="hljs-comment">/**</span>
<span class="hljs-comment">     * 根据主键id查询记录</span>
<span class="hljs-comment">     */</span>
    <span class="hljs-function">RedRecord <span class="hljs-title">selectByPrimaryKey</span><span class="hljs-params">(Integer id)</span></span>;

    <span class="hljs-comment">/**</span>
<span class="hljs-comment">     * 更新数据记录</span>
<span class="hljs-comment">     */</span>
    <span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">updateByPrimaryKeySelective</span><span class="hljs-params">(RedRecord record)</span></span>;

    <span class="hljs-comment">/**</span>
<span class="hljs-comment">     * 更新数据记录</span>
<span class="hljs-comment">     */</span>
    <span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">updateByPrimaryKey</span><span class="hljs-params">(RedRecord record)</span></span>;
&#125;</code></pre></div>

<div class="hljs"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">interface</span> <span class="hljs-title">RedDetailMapper</span> </span>&#123;
    <span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">deleteByPrimaryKey</span><span class="hljs-params">(Integer id)</span></span>;
    <span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">insert</span><span class="hljs-params">(RedDetail record)</span></span>;
    <span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">insertSelective</span><span class="hljs-params">(RedDetail record)</span></span>;
    <span class="hljs-function">RedDetail <span class="hljs-title">selectByPrimaryKey</span><span class="hljs-params">(Integer id)</span></span>;
    <span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">updateByPrimaryKeySelective</span><span class="hljs-params">(RedDetail record)</span></span>;
    <span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">updateByPrimaryKey</span><span class="hljs-params">(RedDetail record)</span></span>;
&#125;</code></pre></div>

<h3 id="4-2-3-开发流程介绍"><a href="#4-2-3-开发流程介绍" class="headerlink" title="4.2.3 开发流程介绍"></a>4.2.3 开发流程介绍</h3><p>发红包：系统后端根据用户输入金额和个数生成对应的红包随机金额列表，并将红包的总个数以及对应的随机金额列表缓存至Redis中，同时将红包的总金额、随机金额列表和红包全局唯一标识串等信息异步记录到相应的数据库中。</p>
<p>抢红包：先对用户身份进行验证，然后处理用户“点红包”的逻辑，主要是从缓存中获取当前剩余红包个数，如果剩余红包个数大于0，则执行拆红包的逻辑。</p>
<p>为了保证系统开发了流程的规范性、可扩展性以及接口的健壮性，这里约定了处理用户请求信息后将返回统一的响应格式。</p>
<div class="hljs"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">enum</span>  StatusCode &#123;
    Success(<span class="hljs-number">0</span>,<span class="hljs-string">"成功"</span>),
    Fail(-<span class="hljs-number">1</span>,<span class="hljs-string">"失败"</span>),
    InvalidParams(<span class="hljs-number">201</span>,<span class="hljs-string">"非法的参数！"</span>),
    InvalidGrantType(<span class="hljs-number">202</span>,<span class="hljs-string">"非法的授权类型"</span>);
    
    <span class="hljs-keyword">private</span> Integer code;
    <span class="hljs-keyword">private</span> String msg;
    StatusCode(Integer code,String msg)&#123;
        <span class="hljs-keyword">this</span>.code = code;
        <span class="hljs-keyword">this</span>.msg = msg;
    &#125;

    <span class="hljs-function"><span class="hljs-keyword">public</span> Integer <span class="hljs-title">getCode</span><span class="hljs-params">()</span> </span>&#123;
        <span class="hljs-keyword">return</span> code;
    &#125;

    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setCode</span><span class="hljs-params">(Integer code)</span> </span>&#123;
        <span class="hljs-keyword">this</span>.code = code;
    &#125;

    <span class="hljs-function"><span class="hljs-keyword">public</span> String <span class="hljs-title">getMsg</span><span class="hljs-params">()</span> </span>&#123;
        <span class="hljs-keyword">return</span> msg;
    &#125;

    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setMsg</span><span class="hljs-params">(String msg)</span> </span>&#123;
        <span class="hljs-keyword">this</span>.msg = msg;
    &#125;
&#125;</code></pre></div>

<div class="hljs"><pre><code class="hljs JAVA"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">BaseResponse</span>&lt;<span class="hljs-title">T</span>&gt; </span>&#123;
    <span class="hljs-keyword">private</span> Integer code;
    <span class="hljs-keyword">private</span> String msg;
    <span class="hljs-keyword">private</span> T data;

    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">BaseResponse</span><span class="hljs-params">(Integer code, String msg)</span> </span>&#123;
        <span class="hljs-keyword">this</span>.code = code;
        <span class="hljs-keyword">this</span>.msg = msg;
    &#125;
    
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">BaseResponse</span><span class="hljs-params">(StatusCode statusCode)</span></span>&#123;
        <span class="hljs-keyword">this</span>.code = statusCode.getCode();
        <span class="hljs-keyword">this</span>.msg = statusCode.getMsg();
    &#125;

    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">BaseResponse</span><span class="hljs-params">(Integer code, String msg, T data)</span> </span>&#123;
        <span class="hljs-keyword">this</span>.code = code;
        <span class="hljs-keyword">this</span>.msg = msg;
        <span class="hljs-keyword">this</span>.data = data;
    &#125;

    <span class="hljs-function"><span class="hljs-keyword">public</span> Integer <span class="hljs-title">getCode</span><span class="hljs-params">()</span> </span>&#123;
        <span class="hljs-keyword">return</span> code;
    &#125;

    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setCode</span><span class="hljs-params">(Integer code)</span> </span>&#123;
        <span class="hljs-keyword">this</span>.code = code;
    &#125;

    <span class="hljs-function"><span class="hljs-keyword">public</span> String <span class="hljs-title">getMsg</span><span class="hljs-params">()</span> </span>&#123;
        <span class="hljs-keyword">return</span> msg;
    &#125;

    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setMsg</span><span class="hljs-params">(String msg)</span> </span>&#123;
        <span class="hljs-keyword">this</span>.msg = msg;
    &#125;

    <span class="hljs-function"><span class="hljs-keyword">public</span> T <span class="hljs-title">getData</span><span class="hljs-params">()</span> </span>&#123;
        <span class="hljs-keyword">return</span> data;
    &#125;

    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setData</span><span class="hljs-params">(T data)</span> </span>&#123;
        <span class="hljs-keyword">this</span>.data = data;
    &#125;
&#125;</code></pre></div>

<h2 id="4-3-“红包金额”随机生成算法实战"><a href="#4-3-“红包金额”随机生成算法实战" class="headerlink" title="4.3 “红包金额”随机生成算法实战"></a>4.3 “红包金额”随机生成算法实战</h2><p>执行逻辑在于不断地更新总金额M和剩余人数N，并根据M和N组成一个随机区间，并在这个区间内产生一个随机金额，如此不断的进行循环迭代，直至N-1为0，此时剩余的金额即为最后一个随机金额。</p>
<p>源代码：</p>
<div class="hljs"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.debug.middleware.server.utils;

<span class="hljs-keyword">import</span> java.util.ArrayList;
<span class="hljs-keyword">import</span> java.util.List;
<span class="hljs-keyword">import</span> java.util.Random;

<span class="hljs-comment">/**</span>
<span class="hljs-comment"> * <span class="hljs-doctag">@Author</span>: gavin</span>
<span class="hljs-comment"> * <span class="hljs-doctag">@GitHub</span>: https://github.com/gavin-yyj</span>
<span class="hljs-comment"> * <span class="hljs-doctag">@Date</span>: Created in 14:04 2021/1/6</span>
<span class="hljs-comment"> * <span class="hljs-doctag">@Description</span>: 二倍均值法的代码实战-封装成工具类</span>
<span class="hljs-comment"> */</span>

<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">RedPacketUtil</span> </span>&#123;
    <span class="hljs-comment">/**</span>
<span class="hljs-comment">     * 发红包算法，金额参数以分为单位</span>
<span class="hljs-comment">     *</span>
<span class="hljs-comment">     * <span class="hljs-doctag">@param</span> totalAmount    红包总金额-单位为分</span>
<span class="hljs-comment">     * <span class="hljs-doctag">@param</span> totalPeopleNum 总人数</span>
<span class="hljs-comment">     * <span class="hljs-doctag">@return</span></span>
<span class="hljs-comment">     */</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> List&lt;Integer&gt; <span class="hljs-title">divideRedPackage</span><span class="hljs-params">(Integer totalAmount, Integer totalPeopleNum)</span> </span>&#123;
        <span class="hljs-comment">//用于存储每次产生的小红包随机金额List -金额单位为分</span>
        List&lt;Integer&gt; amountList = <span class="hljs-keyword">new</span> ArrayList&lt;&gt;();
        <span class="hljs-comment">//判断总金额和总个数参数的合法性</span>
        <span class="hljs-keyword">if</span> (totalAmount &gt; <span class="hljs-number">0</span> &amp;&amp; totalPeopleNum &gt; <span class="hljs-number">0</span>) &#123;
            <span class="hljs-comment">//记录剩余的总金额-初始化时即为红包的总金额</span>
            Integer restAmount = totalAmount;
            <span class="hljs-comment">//记录剩余的总人数-初始化即为指定的总人数</span>
            Integer restPeopleNum = totalPeopleNum;
            <span class="hljs-comment">//定义产生随机数的实例对象</span>
            Random random = <span class="hljs-keyword">new</span> Random();
            <span class="hljs-comment">//不断循环遍历，迭代更新地产生随机金额，直到N-1&gt;0</span>
            <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; totalPeopleNum-<span class="hljs-number">1</span>; i++) &#123;
                <span class="hljs-comment">//随机范围：[1，剩余人均金额的两倍),左闭右开-amount即为产生的随机金额R-单位为分</span>
                <span class="hljs-keyword">int</span> amount = random.nextInt(restAmount / restPeopleNum * <span class="hljs-number">2</span> - <span class="hljs-number">1</span>) + <span class="hljs-number">1</span>;
                <span class="hljs-comment">//更新剩余的总金额M=M-R</span>
                restAmount -= amount;
                <span class="hljs-comment">//更新剩余的总人数N=N-1</span>
                restPeopleNum--;
                <span class="hljs-comment">//将产生的随机金额添加进列表List中</span>
                amountList.add(amount);
            &#125;
            <span class="hljs-comment">//循环完毕，剩余的金额即为最后一个随机金额，也需要将其添加进列表中</span>
            amountList.add(restAmount);
        &#125;
        <span class="hljs-comment">//将最终产生的随机金额列表返回</span>
        <span class="hljs-keyword">return</span> amountList;
    &#125;
&#125;</code></pre></div>

<p>测试：</p>
<div class="hljs"><pre><code class="hljs java"><span class="hljs-meta">@SpringBootTest</span>
<span class="hljs-meta">@RunWith</span>(SpringJUnit4ClassRunner<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>
<span class="hljs-class"><span class="hljs-title">public</span> <span class="hljs-title">class</span> <span class="hljs-title">RedPacketTest</span> </span>&#123;
    <span class="hljs-comment">//定义日志</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> Logger log = LoggerFactory.getLogger(RedPacketTest<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    <span class="hljs-comment">//二倍均值法自测方法</span>
    <span class="hljs-meta">@Test</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">one</span><span class="hljs-params">()</span> </span>&#123;
        <span class="hljs-comment">//总金额单位为分，在这里假设总金额为1000分，即10元</span>
        Integer amout = <span class="hljs-number">1000</span>;
        <span class="hljs-comment">//总人数即红包总个数，在这里假设为10个</span>
        Integer total = <span class="hljs-number">10</span>;
        <span class="hljs-comment">//调用二倍均值法工具类产生随机金额列表的方法得到小红包随机金额列表</span>
        List&lt;Integer&gt; list = RedPacketUtil.divideRedPackage(amout, total);
        log.info(<span class="hljs-string">"总金额=&#123;&#125;分，总人数=&#123;&#125;个"</span>, amout, total);
        <span class="hljs-comment">//用于统计生成的随机金额之和是否等于总金额</span>
        Integer sum = <span class="hljs-number">0</span>;
        <span class="hljs-comment">//遍历输出每个随机金额</span>
        <span class="hljs-keyword">for</span> (Integer i : list) &#123;
            <span class="hljs-comment">//输出随机金额时包括单位为分和单位为元的信息</span>
            log.info(<span class="hljs-string">"随机金额为：&#123;&#125;分，即&#123;&#125;元"</span>, i,<span class="hljs-keyword">new</span> BigDecimal(i.toString()).divide(<span class="hljs-keyword">new</span> BigDecimal(<span class="hljs-number">100</span>)));
            sum += i;
        &#125;
        log.info(<span class="hljs-string">"所有随机金额叠加之和=&#123;&#125;分"</span>, sum);
    &#125;
&#125;</code></pre></div>

<p>效果：（代码有误，因此这里有11份红包，已更正）</p>
<div class="hljs"><pre><code class="hljs angelscript">[<span class="hljs-number">2021</span><span class="hljs-number">-01</span><span class="hljs-number">-25</span> <span class="hljs-number">10</span>:<span class="hljs-number">17</span>:<span class="hljs-number">24.024</span>] boot -  INFO [main] ---RedPacketTest: 总金额=<span class="hljs-number">1000</span>分，总人数=<span class="hljs-number">10</span>个
[<span class="hljs-number">2021</span><span class="hljs-number">-01</span><span class="hljs-number">-25</span> <span class="hljs-number">10</span>:<span class="hljs-number">17</span>:<span class="hljs-number">24.024</span>] boot -  INFO [main] ---RedPacketTest: 随机金额为：<span class="hljs-number">164</span>分，即<span class="hljs-number">1.64</span>元
[<span class="hljs-number">2021</span><span class="hljs-number">-01</span><span class="hljs-number">-25</span> <span class="hljs-number">10</span>:<span class="hljs-number">17</span>:<span class="hljs-number">24.024</span>] boot -  INFO [main] ---RedPacketTest: 随机金额为：<span class="hljs-number">23</span>分，即<span class="hljs-number">0.23</span>元
[<span class="hljs-number">2021</span><span class="hljs-number">-01</span><span class="hljs-number">-25</span> <span class="hljs-number">10</span>:<span class="hljs-number">17</span>:<span class="hljs-number">24.024</span>] boot -  INFO [main] ---RedPacketTest: 随机金额为：<span class="hljs-number">196</span>分，即<span class="hljs-number">1.96</span>元
[<span class="hljs-number">2021</span><span class="hljs-number">-01</span><span class="hljs-number">-25</span> <span class="hljs-number">10</span>:<span class="hljs-number">17</span>:<span class="hljs-number">24.024</span>] boot -  INFO [main] ---RedPacketTest: 随机金额为：<span class="hljs-number">119</span>分，即<span class="hljs-number">1.19</span>元
[<span class="hljs-number">2021</span><span class="hljs-number">-01</span><span class="hljs-number">-25</span> <span class="hljs-number">10</span>:<span class="hljs-number">17</span>:<span class="hljs-number">24.024</span>] boot -  INFO [main] ---RedPacketTest: 随机金额为：<span class="hljs-number">49</span>分，即<span class="hljs-number">0.49</span>元
[<span class="hljs-number">2021</span><span class="hljs-number">-01</span><span class="hljs-number">-25</span> <span class="hljs-number">10</span>:<span class="hljs-number">17</span>:<span class="hljs-number">24.024</span>] boot -  INFO [main] ---RedPacketTest: 随机金额为：<span class="hljs-number">94</span>分，即<span class="hljs-number">0.94</span>元
[<span class="hljs-number">2021</span><span class="hljs-number">-01</span><span class="hljs-number">-25</span> <span class="hljs-number">10</span>:<span class="hljs-number">17</span>:<span class="hljs-number">24.024</span>] boot -  INFO [main] ---RedPacketTest: 随机金额为：<span class="hljs-number">18</span>分，即<span class="hljs-number">0.18</span>元
[<span class="hljs-number">2021</span><span class="hljs-number">-01</span><span class="hljs-number">-25</span> <span class="hljs-number">10</span>:<span class="hljs-number">17</span>:<span class="hljs-number">24.024</span>] boot -  INFO [main] ---RedPacketTest: 随机金额为：<span class="hljs-number">186</span>分，即<span class="hljs-number">1.86</span>元
[<span class="hljs-number">2021</span><span class="hljs-number">-01</span><span class="hljs-number">-25</span> <span class="hljs-number">10</span>:<span class="hljs-number">17</span>:<span class="hljs-number">24.024</span>] boot -  INFO [main] ---RedPacketTest: 随机金额为：<span class="hljs-number">105</span>分，即<span class="hljs-number">1.05</span>元
[<span class="hljs-number">2021</span><span class="hljs-number">-01</span><span class="hljs-number">-25</span> <span class="hljs-number">10</span>:<span class="hljs-number">17</span>:<span class="hljs-number">24.024</span>] boot -  INFO [main] ---RedPacketTest: 随机金额为：<span class="hljs-number">35</span>分，即<span class="hljs-number">0.35</span>元
[<span class="hljs-number">2021</span><span class="hljs-number">-01</span><span class="hljs-number">-25</span> <span class="hljs-number">10</span>:<span class="hljs-number">17</span>:<span class="hljs-number">24.024</span>] boot -  INFO [main] ---RedPacketTest: 随机金额为：<span class="hljs-number">11</span>分，即<span class="hljs-number">0.11</span>元
[<span class="hljs-number">2021</span><span class="hljs-number">-01</span><span class="hljs-number">-25</span> <span class="hljs-number">10</span>:<span class="hljs-number">17</span>:<span class="hljs-number">24.024</span>] boot -  INFO [main] ---RedPacketTest: 所有随机金额叠加之和=<span class="hljs-number">1000</span>分</code></pre></div>

<h2 id="4-4-“发红包”模块实战"><a href="#4-4-“发红包”模块实战" class="headerlink" title="4.4 “发红包”模块实战"></a>4.4 “发红包”模块实战</h2><p>系统后端接口需要根据红包个数N和总金额M采用二倍均值法拆分成多个随机金额，并生成红包的全局唯一标识串返回给前端，前端用户发起抢红包请求时将带上这个标识串参数，从而实现后续的“点红包”“拆红包”流程。</p>
<h3 id="4-4-1-业务模块分析"><a href="#4-4-1-业务模块分析" class="headerlink" title="4.4.1 业务模块分析"></a>4.4.1 业务模块分析</h3><p>后端接口在接收到前端用户发红包的请求时，将采用当前的时间戳（纳秒级别）作为红包全局唯一标识串，并将这一标识串返回给前端，后续用户发起“抢红包”的请求时，将会带上这一参数，目的是为了给发出的红包打标记，并根据这一标记去缓存中查询红包个数和随机金额列表等数据。</p>
<p>在处理“发红包”的请求时，后端接口需要接收红包总金额和总个数等参数，因而将其封装成实体对象RedPacketDto，源代码如下：</p>
<div class="hljs"><pre><code class="hljs java"><span class="hljs-meta">@Data</span>
<span class="hljs-meta">@ToString</span>
<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">RedPacketDto</span> </span>&#123;
    <span class="hljs-keyword">private</span> Integer userId;
    <span class="hljs-meta">@NotNull</span>
    <span class="hljs-keyword">private</span> Integer total;
    <span class="hljs-meta">@NotNull</span>
    <span class="hljs-keyword">private</span> Integer amount;
&#125;</code></pre></div>

<p>本系统采用MVCM模式进行开发，最后的M指Middleware（中间件层，即采用中间件辅助处理业务逻辑的服务类）</p>
<h3 id="4-4-2-整体流程实战"><a href="#4-4-2-整体流程实战" class="headerlink" title="4.4.2 整体流程实战"></a>4.4.2 整体流程实战</h3><p>1、处理发红包请求的RedPacketController，主要用于接收前端用户请求的参数并执行响应的判断处理逻辑，源代码：</p>
<div class="hljs"><pre><code class="hljs java"><span class="hljs-meta">@RestController</span>
<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">RedPacketController</span> </span>&#123;
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> Logger log = LoggerFactory.getLogger(RedPacketController<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
    <span class="hljs-comment">/**</span>
<span class="hljs-comment">     * 定义请求路径的前缀</span>
<span class="hljs-comment">     */</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> String prefix = <span class="hljs-string">"red/packet"</span>;
    <span class="hljs-comment">/**</span>
<span class="hljs-comment">     * 注入红包业务逻辑处理接口服务</span>
<span class="hljs-comment">     */</span>
    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> IRedPacketService redPacketService;

    <span class="hljs-comment">/**</span>
<span class="hljs-comment">     * 发红包请求-请求方法为post，请求参数采用JSON格式进行交互</span>
<span class="hljs-comment">     */</span>
    <span class="hljs-meta">@RequestMapping</span>(value = prefix + <span class="hljs-string">"/hand/out"</span>, method = RequestMethod.POST,
            consumes = MediaType.APPLICATION_JSON_UTF8_VALUE)
    <span class="hljs-function"><span class="hljs-keyword">public</span> BaseResponse <span class="hljs-title">handOut</span><span class="hljs-params">(@Validated @RequestBody RedPacketDto dto, BindingResult result)</span> </span>&#123;
        <span class="hljs-comment">//参数校验</span>
        <span class="hljs-keyword">if</span> (result.hasErrors()) &#123;
            <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> BaseResponse(StatusCode.InvalidParams);
        &#125;
        BaseResponse response = <span class="hljs-keyword">new</span> BaseResponse(StatusCode.Success);
        <span class="hljs-keyword">try</span> &#123;
            <span class="hljs-comment">//核心业务逻辑处理服务-最终返回红包全局唯一标识串</span>
            String redId = redPacketService.handOut(dto);
            <span class="hljs-comment">//将红包全局唯一标识串返回给前端</span>
            response.setData(redId);
        &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;
            <span class="hljs-comment">//如果报异常则打印日志并返回相应的错误信息</span>
            log.error(<span class="hljs-string">"发红包发生异常：dto=&#123;&#125;"</span>, dto, e.fillInStackTrace());
            response = <span class="hljs-keyword">new</span> BaseResponse(StatusCode.Fail.getCode(), e.getMessage());
        &#125;
        <span class="hljs-keyword">return</span> response;
    &#125;
&#125;</code></pre></div>

<p>2、IRedPacketService为红包业务逻辑处理接口，主要包括对“发红包”与“抢红包”逻辑的处理，代码如下：</p>
<div class="hljs"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">interface</span> <span class="hljs-title">IRedPacketService</span> </span>&#123;
    <span class="hljs-comment">/**发红包核心业务逻辑的实现*/</span>
    <span class="hljs-function">String <span class="hljs-title">handOut</span><span class="hljs-params">(RedPacketDto dto)</span></span>;
    <span class="hljs-comment">/**抢红包*/</span>
    <span class="hljs-function">BigDecimal <span class="hljs-title">rob</span><span class="hljs-params">(Integer userId,String redId)</span></span>;
&#125;</code></pre></div>

<p>IRedPacketService的实现类RedPacketService主要用于处理真正的业务逻辑，源代码如下：</p>
<div class="hljs"><pre><code class="hljs java"><span class="hljs-meta">@Service</span>
<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">RedPacketService</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">IRedPacketService</span> </span>&#123;
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> Logger log = LoggerFactory.getLogger(RedPacketService<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
    <span class="hljs-comment">/**</span>
<span class="hljs-comment">     * 存储至缓存系统Redis时定义的Key前缀</span>
<span class="hljs-comment">     */</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> String keyPrefix = <span class="hljs-string">"redis:red:packet:"</span>;
    <span class="hljs-comment">/**</span>
<span class="hljs-comment">     * 定义Redis操作Bean组件</span>
<span class="hljs-comment">     */</span>
    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> RedisTemplate redisTemplate;
    <span class="hljs-comment">/**</span>
<span class="hljs-comment">     * 自动注入红包业务逻辑处理过程数据记录接口服务</span>
<span class="hljs-comment">     */</span>
    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> IRedService redService;

    <span class="hljs-comment">/**</span>
<span class="hljs-comment">     * 发红包</span>
<span class="hljs-comment">     */</span>
    <span class="hljs-meta">@Override</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> String <span class="hljs-title">handOut</span><span class="hljs-params">(RedPacketDto dto)</span> <span class="hljs-keyword">throws</span> Exception </span>&#123;
        <span class="hljs-comment">//判断参数的合法性</span>
        <span class="hljs-keyword">if</span> (dto.getTotal() &gt; <span class="hljs-number">0</span> &amp;&amp; dto.getAmount() &gt; <span class="hljs-number">0</span>) &#123;
            <span class="hljs-comment">//采用二倍均值法生成随机金额列表，在上一节已经采用代码实现了二倍均值法</span>
            List&lt;Integer&gt; list = RedPacketUtil.divideRedPackage(dto.getAmount(), dto.getTotal());
            <span class="hljs-comment">//生成红包全局唯一标识串</span>
            String timestamp = String.valueOf(System.nanoTime());
            <span class="hljs-comment">//根据缓存key的前缀与其他信息拼接成一个新的用于存储随机金额列表的Key</span>
            String redId = <span class="hljs-keyword">new</span> StringBuffer(keyPrefix).append(dto.getUserId()).append(<span class="hljs-string">":"</span>).append(timestamp).toString();
            <span class="hljs-comment">//将随机金额列表存入缓存List中</span>
            redisTemplate.opsForList().leftPushAll(redId, list);
            <span class="hljs-comment">//根据缓存Key的前缀与其他信息拼接成一个新的用于存储红包总数的Key</span>
            String redTotalKey = redId + <span class="hljs-string">":total"</span>;
            <span class="hljs-comment">//将红包总数存入缓存中</span>
            redisTemplate.opsForValue().set(redTotalKey, dto.getTotal());
            <span class="hljs-comment">//异步记录红包的全局唯一标识串，红包个数与随机金额列表信息至数据库中</span>
            redService.recordRedPacket(dto, redId, list);
            <span class="hljs-comment">//将红包的全局唯一标识串返回给前端</span>
            <span class="hljs-keyword">return</span> redId;
        &#125; <span class="hljs-keyword">else</span> &#123;
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> Exception(<span class="hljs-string">"系统异常-分发红包-参数不合法！"</span>);
        &#125;
    &#125;

    <span class="hljs-comment">/**</span>
<span class="hljs-comment">     * 抢红包处理逻辑</span>
<span class="hljs-comment">     */</span>
    <span class="hljs-meta">@Override</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> BigDecimal <span class="hljs-title">rob</span><span class="hljs-params">(Integer userId, String redId)</span> </span>&#123;
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">null</span>;
    &#125;
&#125;</code></pre></div>

<p>3、“红包业务逻辑处理过程数据记录接口”服务IRedService，主要用于将发红包时红包的相关信息与抢红包时用户抢到的红包金额等信息记入数据库中，源代码如下：</p>
<div class="hljs"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">interface</span> <span class="hljs-title">IRedService</span> </span>&#123;
    <span class="hljs-comment">/**记录发红包时的全局唯一标识串，随机金额列表和个数等信息入数据库*/</span>
    <span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">recordRedPacket</span><span class="hljs-params">(RedPacketDto dto, String redId, List&lt;Integer&gt; list)</span></span>;
    
    <span class="hljs-comment">/**记录抢红包时用户抢到的红包金额等信息入数据库*/</span>
    <span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">recordRobRedPacket</span><span class="hljs-params">(Integer userId, String redId, BigDecimal amount)</span></span>;
&#125;</code></pre></div>

<p>实现类RedService源代码如下：</p>
<div class="hljs"><pre><code class="hljs java"><span class="hljs-meta">@Service</span>
<span class="hljs-meta">@EnableAsync</span>
<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">RedService</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">IRedService</span> </span>&#123;
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> Logger log = LoggerFactory.getLogger(RedService<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
    <span class="hljs-comment">/**发红包时红包全局唯一标识串等信息操作接口Mapper*/</span>
    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> RedRecordMapper redRecordMapper;
    <span class="hljs-comment">/**发红包时随机数算法生成的随机金额列表等信息操作接口Mapper*/</span>
    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> RedDetailMapper redDetailMapper;
    <span class="hljs-comment">/**抢红包时相关数据信息操作接口Mapper*/</span>
    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> RedRobRecordMapper redRobRecordMapper;

    <span class="hljs-comment">/**</span>
<span class="hljs-comment">     * 发红包记录-异步方式</span>
<span class="hljs-comment">     * <span class="hljs-doctag">@param</span> dto 红包总金额+个数</span>
<span class="hljs-comment">     * <span class="hljs-doctag">@param</span> redId 红包全局唯一标识串</span>
<span class="hljs-comment">     * <span class="hljs-doctag">@param</span> list 红包随机金额列表</span>
<span class="hljs-comment">     */</span>
    <span class="hljs-meta">@Override</span>
    <span class="hljs-meta">@Async</span>
    <span class="hljs-meta">@Transactional</span>(rollbackFor = Exception<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>
<span class="hljs-class">    <span class="hljs-title">public</span> <span class="hljs-title">void</span> <span class="hljs-title">recordRedPacket</span>(<span class="hljs-title">RedPacketDto</span> <span class="hljs-title">dto</span>, <span class="hljs-title">String</span> <span class="hljs-title">redId</span>, <span class="hljs-title">List</span>&lt;<span class="hljs-title">Integer</span>&gt; <span class="hljs-title">list</span>) </span>&#123;
        <span class="hljs-comment">//定义实体类对象</span>
        RedRecord redRecord = <span class="hljs-keyword">new</span> RedRecord();
        <span class="hljs-comment">//设置字段的取值信息</span>
        redRecord.setUserId(dto.getUserId());
        redRecord.setRedPacket(redId);
        redRecord.setTotal(dto.getTotal());
        redRecord.setAmount(BigDecimal.valueOf(dto.getAmount()));
        redRecord.setCreateTime(<span class="hljs-keyword">new</span> Date());
        <span class="hljs-comment">//将对象信息插入数据库</span>
        redRecordMapper.insertSelective(redRecord);
        <span class="hljs-comment">//定义红包随机金额明细实体类对象</span>
        RedDetail detail;
        <span class="hljs-comment">//遍历随机金额列表，将金额等信息设置到相应的字段中</span>
        <span class="hljs-keyword">for</span> (Integer i : list) &#123;
            detail = <span class="hljs-keyword">new</span> RedDetail();
            detail.setRecordId(redRecord.getId());
            detail.setAmount(BigDecimal.valueOf(i));
            detail.setCreateTime(<span class="hljs-keyword">new</span> Date());
            <span class="hljs-comment">//将对象信息插入数据库</span>
            redDetailMapper.insertSelective(detail);
        &#125;
    &#125;

    <span class="hljs-comment">/**</span>
<span class="hljs-comment">     * 抢红包记录</span>
<span class="hljs-comment">     * <span class="hljs-doctag">@param</span> userId</span>
<span class="hljs-comment">     * <span class="hljs-doctag">@param</span> redId</span>
<span class="hljs-comment">     * <span class="hljs-doctag">@param</span> amount</span>
<span class="hljs-comment">     */</span>
    <span class="hljs-meta">@Override</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">recordRobRedPacket</span><span class="hljs-params">(Integer userId, String redId, BigDecimal amount)</span> </span>&#123;
    
    &#125;
&#125;</code></pre></div>

<h3 id="4-4-3-业务模块自测"><a href="#4-4-3-业务模块自测" class="headerlink" title="4.4.3 业务模块自测"></a>4.4.3 业务模块自测</h3><p>使用Postman工具测试抢红包系统发红包业务的整体流程，打开Postman，在地址栏中输入“发红包”请求对应的链接，即<a href="http://127.0.0.1:8087/middleware/red/packet/hand/out，选择请求方式Post，并在请求体中输入请求参数，如下：" target="_blank" rel="noopener">http://127.0.0.1:8087/middleware/red/packet/hand/out，选择请求方式Post，并在请求体中输入请求参数，如下：</a></p>
<div class="hljs"><pre><code class="hljs json">&#123;
    <span class="hljs-attr">"userId"</span>:<span class="hljs-number">10010</span>,
    <span class="hljs-attr">"total"</span>:<span class="hljs-number">10</span>,
    <span class="hljs-attr">"amount"</span>:<span class="hljs-number">1000</span>
&#125;</code></pre></div>

<h2 id="4-5-“抢红包”模块实战"><a href="#4-5-“抢红包”模块实战" class="headerlink" title="4.5 “抢红包”模块实战"></a>4.5 “抢红包”模块实战</h2><h3 id="4-5-1-业务模块分析"><a href="#4-5-1-业务模块分析" class="headerlink" title="4.5.1 业务模块分析"></a>4.5.1 业务模块分析</h3><ul>
<li>业务角度：点红包+拆红包</li>
<li>系统架构：低耦合和服务的高内聚</li>
<li>技术角度：抢红包业务模块对应的后端接口需要频繁访问缓存系统Redis，用于获取红包剩余个数和随机金额列表，进而判断用户点红包、拆红包是否成功。用户每次成功抢到红包之后，后端进行数据更新，并将相应的信息记入数据库中。</li>
</ul>
<p>前端用户发起抢红包请求，需要带上红包全局唯一标识串resId和当前用户账户Id到系统后端接口。</p>
<h3 id="4-5-2-整体流程"><a href="#4-5-2-整体流程" class="headerlink" title="4.5.2 整体流程"></a>4.5.2 整体流程</h3><p>在RedPacketController类中添加一个处理抢红包请求的方法，源代码:</p>
<div class="hljs"><pre><code class="hljs java"><span class="hljs-comment">/**</span>
<span class="hljs-comment">     * 处理抢红包请求；接受当前用户账号id和红包全局唯一标识串参数</span>
<span class="hljs-comment">     */</span>
    <span class="hljs-meta">@RequestMapping</span>(value = prefix+<span class="hljs-string">"/rob"</span>,method = RequestMethod.GET)
    <span class="hljs-function"><span class="hljs-keyword">public</span> BaseResponse <span class="hljs-title">rob</span><span class="hljs-params">(@RequestParam Integer userId,@RequestParam String redId)</span></span>&#123;
        <span class="hljs-comment">//定义响应对象</span>
        BaseResponse response = <span class="hljs-keyword">new</span> BaseResponse(StatusCode.Success);
        <span class="hljs-keyword">try</span> &#123;
            <span class="hljs-comment">//调用红包业务逻辑处理接口中的抢红包方法，最终返回抢到的红包金额，单位为元（Null表示抢完了）</span>
            BigDecimal result = redPacketService.rob(userId, redId);
            <span class="hljs-keyword">if</span>(result != <span class="hljs-keyword">null</span>)&#123;
                <span class="hljs-comment">//将抢到的红包金额返回到前端</span>
                response.setData(result);
            &#125;<span class="hljs-keyword">else</span>&#123;
                <span class="hljs-comment">//没有抢到红包，即已经被抢完了</span>
                response = <span class="hljs-keyword">new</span> BaseResponse(StatusCode.Fail.getCode(),<span class="hljs-string">"红包已被抢完！"</span>);
            &#125;
        &#125;<span class="hljs-keyword">catch</span> (Exception e)&#123;
            <span class="hljs-comment">//处理过程发生异常，则打印异常信息并返回给前端</span>
            log.error(<span class="hljs-string">"抢红包发生异常：userId=&#123;&#125; redId=&#123;&#125;"</span>,userId,redId,e.fillInStackTrace());
            response = <span class="hljs-keyword">new</span> BaseResponse(StatusCode.Fail.getCode(),e.getMessage());
        &#125;
        <span class="hljs-comment">//返回处理结果给前端</span>
        <span class="hljs-keyword">return</span> response;
    &#125;</code></pre></div>

<p>抢红包方法rob()：</p>
<div class="hljs"><pre><code class="hljs javascript"><span class="hljs-comment">/**</span>
<span class="hljs-comment">    * 抢红包实际业务逻辑处理</span>
<span class="hljs-comment">    * <span class="hljs-doctag">@param </span>userId 当前用户id-抢红包者</span>
<span class="hljs-comment">    * <span class="hljs-doctag">@param </span>redId 红包全局唯一标识串</span>
<span class="hljs-comment">    * <span class="hljs-doctag">@return </span>返回抢到的红包金额或者抢不到红包金额的Null</span>
<span class="hljs-comment">    */</span>
   @Override
   public BigDecimal rob(Integer userId, <span class="hljs-built_in">String</span> redId) throws Exception &#123;
       <span class="hljs-comment">//定义Redis操作组件的值操作方法</span>
       ValueOperations valueOperations = redisTemplate.opsForValue();
       <span class="hljs-comment">//在处理用户抢红包之前，需要先判断一下当前用户是否已经抢过该红包</span>
       <span class="hljs-comment">//如果抢过，则直接返回红包金额，并在前端显示出来</span>
       <span class="hljs-built_in">Object</span> obj = valueOperations.get(redId + userId + <span class="hljs-string">":rob"</span>);
       <span class="hljs-keyword">if</span>(obj!=<span class="hljs-literal">null</span>)&#123;
           <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> BigDecimal(obj.toString());
       &#125;
       <span class="hljs-comment">//"点红包"业务逻辑-主要用于判断缓存系统中是否仍然有红包，即剩余红包个数是否大于0</span>
       <span class="hljs-built_in">Boolean</span> res = click(redId);
       <span class="hljs-keyword">if</span>(res)&#123;
           <span class="hljs-comment">//res为true，则可以进入“拆红包”业务逻辑的处理，从小红包随机金额列表中弹出一个随机金额</span>
           <span class="hljs-built_in">Object</span> value = redisTemplate.opsForList().rightPop(redId);
           <span class="hljs-keyword">if</span>(value != <span class="hljs-literal">null</span>)&#123;
               <span class="hljs-comment">//当前用户抢到一个红包，则进入后续的更新缓存，并将信息记入数据库</span>
               <span class="hljs-built_in">String</span> redTotalKey = redId + <span class="hljs-string">":total"</span>;
               <span class="hljs-comment">//更新缓存系统中剩余的红包个数，即红包个数减1</span>
               Integer currTotal = valueOperations.get(redTotalKey)!=<span class="hljs-literal">null</span>?
                       (Integer)valueOperations.get(redTotalKey):<span class="hljs-number">0</span>;
               <span class="hljs-comment">//将红包金额返回给用户前，这里金额的单位设置为“元”</span>
               <span class="hljs-comment">//如果你不想设置，则可以直接返回value，但是前端需要作除以100的操作</span>
               BigDecimal result = <span class="hljs-keyword">new</span> BigDecimal(value.toString()).divide(<span class="hljs-keyword">new</span> BigDecimal(<span class="hljs-number">100</span>));
               <span class="hljs-comment">//将抢到红包时用户的账号信息以及抢到的金额等信息记入数据库</span>
               redService.recordRobRedPacket(userId,redId,<span class="hljs-keyword">new</span> BigDecimal(value.toString()));
               <span class="hljs-comment">//将当前抢到红包的用户设置进缓存系统中，用于表示当前用户已经抢过红包了</span>
               valueOperations.set(redId+userId+<span class="hljs-string">":rob"</span>,result,<span class="hljs-number">24</span>L, TimeUnit.HOURS);
               <span class="hljs-comment">//打印当前用户抢到红包的记录信息</span>
               log.info(<span class="hljs-string">"当前用户抢到红包了：userId=&#123;&#125; key=&#123;&#125; 金额=&#123;&#125;"</span>,userId,redId,result);
               <span class="hljs-keyword">return</span> result;
           &#125;
           <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;
       &#125;
   &#125;

   private <span class="hljs-built_in">Boolean</span> click(<span class="hljs-built_in">String</span> redId) &#123;
       <span class="hljs-comment">//定义Redis的Bean操作组件-值操作组件</span>
       ValueOperations valueOperations = redisTemplate.opsForValue();
       <span class="hljs-comment">//定义用于查询缓存系统中红包剩余个数的Key</span>
       <span class="hljs-comment">//这在发红包业务模块中已经指定过了</span>
       <span class="hljs-built_in">String</span> redTotalKey = redId + <span class="hljs-string">":total"</span>;
       <span class="hljs-comment">//获取缓存系统Redis中农红包剩余个数</span>
       <span class="hljs-built_in">Object</span> total = valueOperations.get(redTotalKey);
       <span class="hljs-comment">//判断红包剩余个数total是否大于0，如果大于0，则返回true，代表还有红包</span>
       <span class="hljs-keyword">if</span>(total!=<span class="hljs-literal">null</span> &amp;&amp; Integer.valueOf(total.toString())&gt;<span class="hljs-number">0</span>)&#123;
           <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
       &#125;
       <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
   &#125;</code></pre></div>

<p>去缓存系统中查询红包剩余个数Total和随机金额列表时需要提供Key，这些Key 是在“发红包”业务模块代码中定义的。</p>
<p>3、当用户抢到红包后，需要将当前用户的账号信息及抢到的金额等信息记入数据库中，这一实现逻辑是通过调用redService实现类的recordRobRedPacket（）方法实现的，源代码如下：</p>
<div class="hljs"><pre><code class="hljs java"><span class="hljs-comment">/**</span>
<span class="hljs-comment">    * 抢红包记录</span>
<span class="hljs-comment">    * <span class="hljs-doctag">@param</span> userId</span>
<span class="hljs-comment">    * <span class="hljs-doctag">@param</span> redId</span>
<span class="hljs-comment">    * <span class="hljs-doctag">@param</span> amount</span>
<span class="hljs-comment">    * <span class="hljs-doctag">@throws</span> Exception</span>
<span class="hljs-comment">    */</span>
   <span class="hljs-meta">@Override</span>
   <span class="hljs-meta">@Async</span>
   <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">recordRobRedPacket</span><span class="hljs-params">(Integer userId, String redId, BigDecimal amount)</span> <span class="hljs-keyword">throws</span> Exception </span>&#123;
       RedRobRecord redRobRecord=<span class="hljs-keyword">new</span> RedRobRecord();
       redRobRecord.setUserId(userId);
       redRobRecord.setRedPacket(redId);
       redRobRecord.setAmount(amount);
       redRobRecord.setRobTime(<span class="hljs-keyword">new</span> Date());
       <span class="hljs-comment">//将实体对象信息插入数据库中</span>
       redRobRecordMapper.insertSelective(redRobRecord);
   &#125;</code></pre></div>

<h3 id="4-5-3-业务模块自测"><a href="#4-5-3-业务模块自测" class="headerlink" title="4.5.3 业务模块自测"></a>4.5.3 业务模块自测</h3><p>以“发红包”业务模块自测中发出的红包作为测试数据，redId取值为redis:red:packet:10010:371054244610400</p>
<p>1、打开Postman，在地址栏中输入<a href="http://127.0.0.1:8087/middleware/red/packet/rob?userId=10010&amp;redId=redis:red:packet:10010:371054244610400，查看控制台输出结果" target="_blank" rel="noopener">http://127.0.0.1:8087/middleware/red/packet/rob?userId=10010&amp;redId=redis:red:packet:10010:371054244610400，查看控制台输出结果</a></p>
<div class="hljs"><pre><code class="hljs angelscript">[<span class="hljs-number">2021</span><span class="hljs-number">-01</span><span class="hljs-number">-26</span> <span class="hljs-number">19</span>:<span class="hljs-number">35</span>:<span class="hljs-number">06.006</span>] boot -  INFO [http-nio<span class="hljs-number">-8087</span>-exec<span class="hljs-number">-1</span>] ---RedPacketService: 当前用户抢到红包了：userId=<span class="hljs-number">10010</span> key=redis:red:packet:<span class="hljs-number">10010</span>:<span class="hljs-number">371054244610400</span> 金额=<span class="hljs-number">0.76</span></code></pre></div>

<p>2、对同一个链接进行多次发送，系统并不会处理该请求</p>
<h2 id="4-6-Jmeter压力测试高并发抢红包"><a href="#4-6-Jmeter压力测试高并发抢红包" class="headerlink" title="4.6 Jmeter压力测试高并发抢红包"></a>4.6 Jmeter压力测试高并发抢红包</h2><p>Apache Jmeter是基于Java的压力测试工具，能够模拟实际生产环境中高并发产生的巨大负载，从而对应用服务器，网络或对象整体性能进行测试，并对产生的测试结果进行分析和反馈。</p>
<p>下载测试工具包：<a href="http://jmeter.apache.org/download_jmeter.cgi" target="_blank" rel="noopener">http://jmeter.apache.org/download_jmeter.cgi</a></p>
<p>找到bin文件目录，然后双击jmeter.sh文件</p>
<p>右击“文件”选项，新建一个测试计划，然后在该测试计划下新建线程组，最后在线程组下新建“HTTP请求””CSV数据文件设置”“查看结果树”</p>
<p>打开Postman，发起发红包请求，参数如下：</p>
<div class="hljs"><pre><code class="hljs json">&#123;
    <span class="hljs-attr">"userId"</span>:<span class="hljs-number">10030</span>,
    <span class="hljs-attr">"total"</span>:<span class="hljs-number">10</span>,
    <span class="hljs-attr">"amount"</span>:<span class="hljs-number">500</span>
&#125;</code></pre></div>

<p>抢红包请求设置如下：</p>
<p><img src="https://gitee.com/yang_yu_jie/blog-img/raw/master/img/20210530101300.png" srcset="/img/loading.gif" alt="在这里插入图片描述"></p>
<p>用户抢红包账号等设置如下：共有10030~10035六个用户</p>
<p><img src="https://gitee.com/yang_yu_jie/blog-img/raw/master/img/20210530101312.png" srcset="/img/loading.gif" alt="在这里插入图片描述"></p>
<p>运行后查看结果树：</p>
<p><img src="https://gitee.com/yang_yu_jie/blog-img/raw/master/img/20210530102015.png" srcset="/img/loading.gif" alt="在这里插入图片描述"></p>
<p>运行栏数据：</p>
<div class="hljs"><pre><code class="hljs angelscript">[<span class="hljs-number">2021</span><span class="hljs-number">-01</span><span class="hljs-number">-27</span> <span class="hljs-number">09</span>:<span class="hljs-number">45</span>:<span class="hljs-number">43.043</span>] boot -  INFO [http-nio<span class="hljs-number">-8087</span>-exec<span class="hljs-number">-90</span>] ---RedPacketService: 当前用户抢到红包了：userId=<span class="hljs-number">10031</span> key=redis:red:packet:<span class="hljs-number">10030</span>:<span class="hljs-number">426373717637600</span> 金额=<span class="hljs-number">0.28</span>
[<span class="hljs-number">2021</span><span class="hljs-number">-01</span><span class="hljs-number">-27</span> <span class="hljs-number">09</span>:<span class="hljs-number">45</span>:<span class="hljs-number">43.043</span>] boot -  INFO [http-nio<span class="hljs-number">-8087</span>-exec<span class="hljs-number">-212</span>] ---RedPacketService: 当前用户抢到红包了：userId=<span class="hljs-number">10031</span> key=redis:red:packet:<span class="hljs-number">10030</span>:<span class="hljs-number">426373717637600</span> 金额=<span class="hljs-number">0.57</span>
[<span class="hljs-number">2021</span><span class="hljs-number">-01</span><span class="hljs-number">-27</span> <span class="hljs-number">09</span>:<span class="hljs-number">45</span>:<span class="hljs-number">43.043</span>] boot -  INFO [http-nio<span class="hljs-number">-8087</span>-exec<span class="hljs-number">-33</span>] ---RedPacketService: 当前用户抢到红包了：userId=<span class="hljs-number">10030</span> key=redis:red:packet:<span class="hljs-number">10030</span>:<span class="hljs-number">426373717637600</span> 金额=<span class="hljs-number">0.79</span>
[<span class="hljs-number">2021</span><span class="hljs-number">-01</span><span class="hljs-number">-27</span> <span class="hljs-number">09</span>:<span class="hljs-number">45</span>:<span class="hljs-number">43.043</span>] boot -  INFO [http-nio<span class="hljs-number">-8087</span>-exec<span class="hljs-number">-74</span>] ---RedPacketService: 当前用户抢到红包了：userId=<span class="hljs-number">10033</span> key=redis:red:packet:<span class="hljs-number">10030</span>:<span class="hljs-number">426373717637600</span> 金额=<span class="hljs-number">0.82</span>
[<span class="hljs-number">2021</span><span class="hljs-number">-01</span><span class="hljs-number">-27</span> <span class="hljs-number">09</span>:<span class="hljs-number">45</span>:<span class="hljs-number">43.043</span>] boot -  INFO [http-nio<span class="hljs-number">-8087</span>-exec<span class="hljs-number">-223</span>] ---RedPacketService: 当前用户抢到红包了：userId=<span class="hljs-number">10035</span> key=redis:red:packet:<span class="hljs-number">10030</span>:<span class="hljs-number">426373717637600</span> 金额=<span class="hljs-number">0.54</span>
[<span class="hljs-number">2021</span><span class="hljs-number">-01</span><span class="hljs-number">-27</span> <span class="hljs-number">09</span>:<span class="hljs-number">45</span>:<span class="hljs-number">43.043</span>] boot -  INFO [http-nio<span class="hljs-number">-8087</span>-exec<span class="hljs-number">-204</span>] ---RedPacketService: 当前用户抢到红包了：userId=<span class="hljs-number">10035</span> key=redis:red:packet:<span class="hljs-number">10030</span>:<span class="hljs-number">426373717637600</span> 金额=<span class="hljs-number">0.44</span>
[<span class="hljs-number">2021</span><span class="hljs-number">-01</span><span class="hljs-number">-27</span> <span class="hljs-number">09</span>:<span class="hljs-number">45</span>:<span class="hljs-number">43.043</span>] boot -  INFO [http-nio<span class="hljs-number">-8087</span>-exec<span class="hljs-number">-210</span>] ---RedPacketService: 当前用户抢到红包了：userId=<span class="hljs-number">10030</span> key=redis:red:packet:<span class="hljs-number">10030</span>:<span class="hljs-number">426373717637600</span> 金额=<span class="hljs-number">0.08</span>
[<span class="hljs-number">2021</span><span class="hljs-number">-01</span><span class="hljs-number">-27</span> <span class="hljs-number">09</span>:<span class="hljs-number">45</span>:<span class="hljs-number">43.043</span>] boot -  INFO [http-nio<span class="hljs-number">-8087</span>-exec<span class="hljs-number">-215</span>] ---RedPacketService: 当前用户抢到红包了：userId=<span class="hljs-number">10031</span> key=redis:red:packet:<span class="hljs-number">10030</span>:<span class="hljs-number">426373717637600</span> 金额=<span class="hljs-number">0.02</span>
[<span class="hljs-number">2021</span><span class="hljs-number">-01</span><span class="hljs-number">-27</span> <span class="hljs-number">09</span>:<span class="hljs-number">45</span>:<span class="hljs-number">43.043</span>] boot -  INFO [http-nio<span class="hljs-number">-8087</span>-exec<span class="hljs-number">-195</span>] ---RedPacketService: 当前用户抢到红包了：userId=<span class="hljs-number">10032</span> key=redis:red:packet:<span class="hljs-number">10030</span>:<span class="hljs-number">426373717637600</span> 金额=<span class="hljs-number">0.67</span>
[<span class="hljs-number">2021</span><span class="hljs-number">-01</span><span class="hljs-number">-27</span> <span class="hljs-number">09</span>:<span class="hljs-number">45</span>:<span class="hljs-number">43.043</span>] boot -  INFO [http-nio<span class="hljs-number">-8087</span>-exec<span class="hljs-number">-211</span>] ---RedPacketService: 当前用户抢到红包了：userId=<span class="hljs-number">10033</span> key=redis:red:packet:<span class="hljs-number">10030</span>:<span class="hljs-number">426373717637600</span> 金额=<span class="hljs-number">0.79</span></code></pre></div>

<p>异常现象：有用户抢到多个红包！！！</p>
<h2 id="4-7-问题分析与优化方案"><a href="#4-7-问题分析与优化方案" class="headerlink" title="4.7 问题分析与优化方案"></a>4.7 问题分析与优化方案</h2><p>问题所在：同一时刻多个并发的线程对共享资源进行了访问操作。</p>
<h3 id="优化方案"><a href="#优化方案" class="headerlink" title="优化方案"></a>优化方案</h3><p>传统方案：在核心业务逻辑代码中加锁操作（Synchronized）。在分布式系统架构下的服务一般部署在不同的节点（服务器）下，从而当出现高并发请求时，Synchronized无法解决。</p>
<p>主流方案：分布式锁</p>
<h3 id="Redis分布式锁实战"><a href="#Redis分布式锁实战" class="headerlink" title="Redis分布式锁实战"></a>Redis分布式锁实战</h3><p>通过Redis的院子操作selfAbsent()方法对该业务逻辑加分布式锁，表示“如果当前的Key不存在于缓存中，则设置其对应的Value，该方法的操作结果返回true；如果当前的Key已经存在于缓存中，则设置其对应的Value失败，即该方法的操作结果将返回false，由于该方法具备原子性，故当多个并发的线程同一时刻调用该方法时Redis的底层会将线程加入”队列“排队处理。</p>
<p>改造后的rob()方法如下：</p>
<div class="hljs"><pre><code class="hljs java"><span class="hljs-meta">@Override</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> BigDecimal <span class="hljs-title">rob</span><span class="hljs-params">(Integer userId, String redId)</span> <span class="hljs-keyword">throws</span> Exception </span>&#123;
        <span class="hljs-comment">//定义Redis操作组件的值操作方法</span>
        ValueOperations valueOperations = redisTemplate.opsForValue();
        <span class="hljs-comment">//在处理用户抢红包之前，需要先判断一下当前用户是否已经抢过该红包</span>
        <span class="hljs-comment">//如果抢过，则直接返回红包金额，并在前端显示出来</span>
        Object obj = valueOperations.get(redId + userId + <span class="hljs-string">":rob"</span>);
        <span class="hljs-keyword">if</span>(obj!=<span class="hljs-keyword">null</span>)&#123;
            <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> BigDecimal(obj.toString());
        &#125;
        <span class="hljs-comment">//"点红包"业务逻辑-主要用于判断缓存系统中是否仍然有红包，即剩余红包个数是否大于0</span>
        Boolean res = click(redId);
        <span class="hljs-keyword">if</span>(res)&#123;
            <span class="hljs-comment">//上分布式锁，一个红包每个人只能抢到一次随机金额，即要永远保证一对一的关系</span>
            <span class="hljs-comment">//构造缓存中的key</span>
            <span class="hljs-keyword">final</span> String lockKey = redId + userId + <span class="hljs-string">"-lock"</span>;
            <span class="hljs-comment">//调用setIfAbsent()方法，其实就是间接实现了分布式锁</span>
            Boolean lock = valueOperations.setIfAbsent(lockKey, redId);
            <span class="hljs-comment">//设定该分布式锁的过期时间为24小时</span>
            redisTemplate.expire(lockKey,<span class="hljs-number">24L</span>,TimeUnit.HOURS);
            <span class="hljs-keyword">try</span> &#123;
                <span class="hljs-comment">//表示当前线程获取到了该分布式锁</span>
                <span class="hljs-keyword">if</span>(lock)&#123;</code></pre></div>

<p>效果：</p>
<div class="hljs"><pre><code class="hljs angelscript">[<span class="hljs-number">2021</span><span class="hljs-number">-01</span><span class="hljs-number">-27</span> <span class="hljs-number">10</span>:<span class="hljs-number">50</span>:<span class="hljs-number">30.030</span>] boot -  INFO [http-nio<span class="hljs-number">-8087</span>-exec<span class="hljs-number">-10</span>] ---RedPacketService: 当前用户抢到红包了：userId=<span class="hljs-number">10033</span> key=redis:red:packet:<span class="hljs-number">10050</span>:<span class="hljs-number">430694037472700</span> 金额=<span class="hljs-number">1.71</span>
[<span class="hljs-number">2021</span><span class="hljs-number">-01</span><span class="hljs-number">-27</span> <span class="hljs-number">10</span>:<span class="hljs-number">50</span>:<span class="hljs-number">30.030</span>] boot -  INFO [http-nio<span class="hljs-number">-8087</span>-exec<span class="hljs-number">-2</span>] ---RedPacketService: 当前用户抢到红包了：userId=<span class="hljs-number">10034</span> key=redis:red:packet:<span class="hljs-number">10050</span>:<span class="hljs-number">430694037472700</span> 金额=<span class="hljs-number">0.03</span>
[<span class="hljs-number">2021</span><span class="hljs-number">-01</span><span class="hljs-number">-27</span> <span class="hljs-number">10</span>:<span class="hljs-number">50</span>:<span class="hljs-number">30.030</span>] boot -  INFO [http-nio<span class="hljs-number">-8087</span>-exec<span class="hljs-number">-7</span>] ---RedPacketService: 当前用户抢到红包了：userId=<span class="hljs-number">10030</span> key=redis:red:packet:<span class="hljs-number">10050</span>:<span class="hljs-number">430694037472700</span> 金额=<span class="hljs-number">0.67</span>
[<span class="hljs-number">2021</span><span class="hljs-number">-01</span><span class="hljs-number">-27</span> <span class="hljs-number">10</span>:<span class="hljs-number">50</span>:<span class="hljs-number">30.030</span>] boot -  INFO [http-nio<span class="hljs-number">-8087</span>-exec<span class="hljs-number">-5</span>] ---RedPacketService: 当前用户抢到红包了：userId=<span class="hljs-number">10032</span> key=redis:red:packet:<span class="hljs-number">10050</span>:<span class="hljs-number">430694037472700</span> 金额=<span class="hljs-number">1.29</span>
[<span class="hljs-number">2021</span><span class="hljs-number">-01</span><span class="hljs-number">-27</span> <span class="hljs-number">10</span>:<span class="hljs-number">50</span>:<span class="hljs-number">30.030</span>] boot -  INFO [http-nio<span class="hljs-number">-8087</span>-exec<span class="hljs-number">-6</span>] ---RedPacketService: 当前用户抢到红包了：userId=<span class="hljs-number">10035</span> key=redis:red:packet:<span class="hljs-number">10050</span>:<span class="hljs-number">430694037472700</span> 金额=<span class="hljs-number">0.55</span>
[<span class="hljs-number">2021</span><span class="hljs-number">-01</span><span class="hljs-number">-27</span> <span class="hljs-number">10</span>:<span class="hljs-number">50</span>:<span class="hljs-number">30.030</span>] boot -  INFO [http-nio<span class="hljs-number">-8087</span>-exec<span class="hljs-number">-9</span>] ---RedPacketService: 当前用户抢到红包了：userId=<span class="hljs-number">10031</span> key=redis:red:packet:<span class="hljs-number">10050</span>:<span class="hljs-number">430694037472700</span> 金额=<span class="hljs-number">1.46</span></code></pre></div>

<h1 id="第5章-消息中间件RabbitMQ"><a href="#第5章-消息中间件RabbitMQ" class="headerlink" title="第5章 消息中间件RabbitMQ"></a>第5章 消息中间件RabbitMQ</h1><p>问题：传统应用在系统接口和服务处理模块层面仍然沿用“高耦合”和“同步”的处理方式，导致接口由于线程阻塞而延长了整体响应时间，即所谓的“高延迟”。</p>
<h2 id="5-1-RabbitMQ简介"><a href="#5-1-RabbitMQ简介" class="headerlink" title="5.1 RabbitMQ简介"></a>5.1 RabbitMQ简介</h2><p>RabbitMQ的作用：异步通信、服务解耦、接口限流、消息分发、延迟处理</p>
<h3 id="5-1-3-RabbitMQ后端控制台介绍"><a href="#5-1-3-RabbitMQ后端控制台介绍" class="headerlink" title="5.1.3 RabbitMQ后端控制台介绍"></a>5.1.3 RabbitMQ后端控制台介绍</h3><p>安装Erlang以及去官网下载RabbitMQ安装包，安装完成后在浏览器中输入<a href="http://127.0.0.1:15672" target="_blank" rel="noopener">http://127.0.0.1:15672</a></p>
<h3 id="5-1-4-基于Spring的事件驱动模型实战"><a href="#5-1-4-基于Spring的事件驱动模型实战" class="headerlink" title="5.1.4 基于Spring的事件驱动模型实战"></a>5.1.4 基于Spring的事件驱动模型实战</h3><p>Spring事件驱动模型主要由3部分组成，包括发送消息的生产者、消息（或事件）和监听消息的消费者</p>
<p>用户登录成功后的事件实体类LoginEvent</p>
<div class="hljs"><pre><code class="hljs java"><span class="hljs-meta">@Data</span>
<span class="hljs-meta">@ToString</span>
<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">LoginEvent</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">ApplicationEvent</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">Serializable</span> </span>&#123;
    <span class="hljs-keyword">private</span> String userName;
    <span class="hljs-keyword">private</span> String loginTime;
    <span class="hljs-keyword">private</span> String ip;
    <span class="hljs-comment">/**构造方法一*/</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">LoginEvent</span><span class="hljs-params">(Object source)</span> </span>&#123;
        <span class="hljs-keyword">super</span>(source);
    &#125;
    <span class="hljs-comment">/**构造方法二*/</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">LoginEvent</span><span class="hljs-params">(Object source,String userName,String loginTime,String ip)</span> </span>&#123;
        <span class="hljs-keyword">super</span>(source);
        <span class="hljs-keyword">this</span>.userName = userName;
        <span class="hljs-keyword">this</span>.loginTime = loginTime;
        <span class="hljs-keyword">this</span>.ip = ip;
    &#125;
&#125;</code></pre></div>

<p>开发监听消息的消费者Consumer类：</p>
<div class="hljs"><pre><code class="hljs java"><span class="hljs-meta">@Component</span>
<span class="hljs-meta">@EnableAsync</span>
<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Consumer</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">ApplicationListener</span>&lt;<span class="hljs-title">LoginEvent</span>&gt; </span>&#123;
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> Logger log = LoggerFactory.getLogger(Consumer<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    <span class="hljs-comment">/**</span>
<span class="hljs-comment">     * 监听消费信息</span>
<span class="hljs-comment">     * <span class="hljs-doctag">@param</span> loginEvent</span>
<span class="hljs-comment">     */</span>
    <span class="hljs-meta">@Override</span>
    <span class="hljs-meta">@Async</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">onApplicationEvent</span><span class="hljs-params">(LoginEvent loginEvent)</span> </span>&#123;
        <span class="hljs-comment">//打印日志信息</span>
        log.info(<span class="hljs-string">"Spring事件驱动模型-接收消息：&#123;&#125;"</span>,loginEvent);
    &#125;
&#125;</code></pre></div>

<p>用于发送消息或产生事件的生产者Producter</p>
<div class="hljs"><pre><code class="hljs java"><span class="hljs-meta">@Component</span>
<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Publisher</span> </span>&#123;
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> Logger log = LoggerFactory.getLogger(Publisher<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> ApplicationEventPublisher publisher;
    <span class="hljs-comment">/**</span>
<span class="hljs-comment">     * 发送消息的方法</span>
<span class="hljs-comment">     */</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">sendMsg</span><span class="hljs-params">()</span> </span>&#123;
        <span class="hljs-comment">//构造登录成功后用户的实体信息</span>
        LoginEvent event = <span class="hljs-keyword">new</span> LoginEvent(<span class="hljs-keyword">this</span>, <span class="hljs-string">"debug"</span>, <span class="hljs-keyword">new</span> SimpleDateFormat(<span class="hljs-string">"yyyy-MM-dd HH:mm:ss"</span>).format(<span class="hljs-keyword">new</span> Date()), <span class="hljs-string">"127.0.0.1"</span>);
        <span class="hljs-comment">//发送消息</span>
        publisher.publishEvent(event);
        log.info(<span class="hljs-string">"Spring事件驱动模型-发送消息：&#123;&#125;"</span>, event);
    &#125;
&#125;</code></pre></div>

<p>测试类：</p>
<div class="hljs"><pre><code class="hljs java"><span class="hljs-meta">@RunWith</span>(SpringJUnit4ClassRunner<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>
<span class="hljs-class">@<span class="hljs-title">SpringBootTest</span></span>
<span class="hljs-class"><span class="hljs-title">public</span> <span class="hljs-title">class</span> <span class="hljs-title">EventTest</span> </span>&#123;
    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> Publisher publisher;
    <span class="hljs-meta">@Test</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">test1</span><span class="hljs-params">()</span></span>&#123;
        publisher.sendMsg();
    &#125;
&#125;</code></pre></div>

<p>效果：</p>
<div class="hljs"><pre><code class="hljs angelscript">[<span class="hljs-number">2021</span><span class="hljs-number">-01</span><span class="hljs-number">-28</span> <span class="hljs-number">16</span>:<span class="hljs-number">33</span>:<span class="hljs-number">32.032</span>] boot -  INFO [SimpleAsyncTaskExecutor<span class="hljs-number">-1</span>] ---Consumer: Spring事件驱动模型-接收消息：LoginEvent(userName=debug, loginTime=<span class="hljs-number">2021</span><span class="hljs-number">-01</span><span class="hljs-number">-28</span> <span class="hljs-number">16</span>:<span class="hljs-number">33</span>:<span class="hljs-number">32</span>, ip=<span class="hljs-number">127.0</span><span class="hljs-number">.0</span><span class="hljs-number">.1</span>)
[<span class="hljs-number">2021</span><span class="hljs-number">-01</span><span class="hljs-number">-28</span> <span class="hljs-number">16</span>:<span class="hljs-number">33</span>:<span class="hljs-number">32.032</span>] boot -  INFO [main] ---Publisher: Spring事件驱动模型-发送消息：LoginEvent(userName=debug, loginTime=<span class="hljs-number">2021</span><span class="hljs-number">-01</span><span class="hljs-number">-28</span> <span class="hljs-number">16</span>:<span class="hljs-number">33</span>:<span class="hljs-number">32</span>, ip=<span class="hljs-number">127.0</span><span class="hljs-number">.0</span><span class="hljs-number">.1</span>)</code></pre></div>

<h2 id="5-2-SpringBoot项目整合RabbitMQ"><a href="#5-2-SpringBoot项目整合RabbitMQ" class="headerlink" title="5.2 SpringBoot项目整合RabbitMQ"></a>5.2 SpringBoot项目整合RabbitMQ</h2><h3 id="5-2-1-RabbitMQ相关词汇介绍"><a href="#5-2-1-RabbitMQ相关词汇介绍" class="headerlink" title="5.2.1 RabbitMQ相关词汇介绍"></a>5.2.1 RabbitMQ相关词汇介绍</h3><ul>
<li>生产者</li>
<li>消费者</li>
<li>消息</li>
<li>队列：消息的暂存区或者是存储区</li>
<li>交换机：消息的中转站，用于首次接收和分发消息</li>
<li>路由：相当于秘钥、地址或者“第三者”，将消息路由到指定的队列</li>
</ul>
<h3 id="5-2-2-Spring-Boot项目整合RabbitMQ"><a href="#5-2-2-Spring-Boot项目整合RabbitMQ" class="headerlink" title="5.2.2 Spring Boot项目整合RabbitMQ"></a>5.2.2 Spring Boot项目整合RabbitMQ</h3><p>1、加入RabbitMQ依赖</p>
<div class="hljs"><pre><code class="hljs xml"><span class="hljs-comment">&lt;!--rabbitmq--&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-starter-amqp<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>1.3.3.RELEASE<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span></code></pre></div>

<p>2、加入RabbitMQ相关配置，包括RabbitMQ服务器所在的Host、端口号、用户名和密码等配置</p>
<div class="hljs"><pre><code class="hljs properties"><span class="hljs-comment">#RabbitMQ配置</span>
<span class="hljs-meta">spring.rabbitmq.virtual-host</span>=<span class="hljs-string">/</span>
<span class="hljs-comment">#RabbitMQ服务器所在的host，这里连接本地即可</span>
<span class="hljs-meta">spring.rabbitmq.host</span>=<span class="hljs-string">127.0.0.1</span>
<span class="hljs-comment">#5672为RabbitMQ提供服务时的端口</span>
<span class="hljs-meta">spring.rabbitmq.port</span>=<span class="hljs-string">5672</span>
<span class="hljs-comment">#guest和guest为连接到RabbitMQ服务器的账号名和密码</span>
<span class="hljs-meta">spring.rabbitmq.username</span>=<span class="hljs-string">guest</span>
<span class="hljs-meta">spring.rabbitmq.password</span>=<span class="hljs-string">guest</span>
<span class="hljs-comment">#这里是自定义变量，表示本地开发环境</span>
<span class="hljs-meta">mq.env</span>=<span class="hljs-string">local</span></code></pre></div>

<h3 id="5-2-3-自定义注入配置Bean相关组件"><a href="#5-2-3-自定义注入配置Bean相关组件" class="headerlink" title="5.2.3 自定义注入配置Bean相关组件"></a>5.2.3 自定义注入配置Bean相关组件</h3><div class="hljs"><pre><code class="hljs java"><span class="hljs-meta">@Configuration</span>
<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">RabbitmqConfig</span> </span>&#123;
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> Logger log = LoggerFactory.getLogger(RabbitmqConfig<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
    <span class="hljs-comment">/**自动装配RabbitMQ的链接工厂实例*/</span>
    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> CachingConnectionFactory connectionFactory;
    <span class="hljs-comment">/**自动装配消息监听器所在的容器工厂配置类实例*/</span>
    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> SimpleRabbitListenerContainerFactoryConfigurer factoryConfigurer;

    <span class="hljs-comment">/**</span>
<span class="hljs-comment">     * 为单一消费者实例的配置</span>
<span class="hljs-comment">     * <span class="hljs-doctag">@return</span></span>
<span class="hljs-comment">     */</span>
    <span class="hljs-meta">@Bean</span>(name = <span class="hljs-string">"singleListenerContainer"</span>)
    <span class="hljs-function"><span class="hljs-keyword">public</span> SimpleRabbitListenerContainerFactory <span class="hljs-title">listenerContainer</span><span class="hljs-params">()</span></span>&#123;
        <span class="hljs-comment">//定义消息监听器所在的容器工厂</span>
        SimpleRabbitListenerContainerFactory factory = <span class="hljs-keyword">new</span> SimpleRabbitListenerContainerFactory();
        <span class="hljs-comment">//设置容器工厂所用的实例</span>
        factory.setConnectionFactory(connectionFactory);
        <span class="hljs-comment">//设置消息在传输中的格式，在这里采用JSON格式进行传输</span>
        factory.setMessageConverter(<span class="hljs-keyword">new</span> Jackson2JsonMessageConverter());
        <span class="hljs-comment">//设置并发消费者实例的初始数量，这里为1个</span>
        factory.setConcurrentConsumers(<span class="hljs-number">1</span>);
        <span class="hljs-comment">//设置并发消费者实例的最大数量，这里为1个</span>
        factory.setMaxConcurrentConsumers(<span class="hljs-number">1</span>);
        <span class="hljs-comment">//设置并发消费者实例中每个实例拉取的消息数量-在这里为1个</span>
        factory.setPrefetchCount(<span class="hljs-number">1</span>);
        <span class="hljs-keyword">return</span> factory;
    &#125;
    <span class="hljs-comment">/**</span>
<span class="hljs-comment">     * 多个消费者实例的配置，主要针对高并发业务场景的配置</span>
<span class="hljs-comment">     */</span>
    <span class="hljs-meta">@Bean</span>(name = <span class="hljs-string">"multiListenerContainer"</span>)
    <span class="hljs-function"><span class="hljs-keyword">public</span> SimpleRabbitListenerContainerFactory <span class="hljs-title">multiListenerContainer</span><span class="hljs-params">()</span></span>&#123;
        <span class="hljs-comment">//定义消息监听器所在的容器工厂</span>
        SimpleRabbitListenerContainerFactory factory = <span class="hljs-keyword">new</span> SimpleRabbitListenerContainerFactory();
        <span class="hljs-comment">//设置容器工厂所用的实例</span>
        factoryConfigurer.configure(factory,connectionFactory);
        <span class="hljs-comment">//设置消息在传输中的格式，在这里采用JSON格式进行传输</span>
        factory.setMessageConverter(<span class="hljs-keyword">new</span> Jackson2JsonMessageConverter());
        <span class="hljs-comment">//设置消息的确认消费模式，在这里为NONE，表示不需要确认消费</span>
        factory.setAcknowledgeMode(AcknowledgeMode.NONE);
        <span class="hljs-comment">//设置并发消费者实例的初始数量，这里为10个</span>
        factory.setConcurrentConsumers(<span class="hljs-number">10</span>);
        <span class="hljs-comment">//设置并发消费者实例的最大数量，这里为15个</span>
        factory.setMaxConcurrentConsumers(<span class="hljs-number">15</span>);
        <span class="hljs-comment">//设置并发消费者实例中每个实例拉取的消息数量-在这里为10个</span>
        factory.setPrefetchCount(<span class="hljs-number">10</span>);
        <span class="hljs-keyword">return</span> factory;
    &#125;
    <span class="hljs-comment">/**自定义配置RabbitMQ发送消息的操作组件RabbitTemplate*/</span>
    <span class="hljs-meta">@Bean</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> RabbitTemplate <span class="hljs-title">rabbitTemplate</span><span class="hljs-params">()</span></span>&#123;
        <span class="hljs-comment">//设置“发送消息后进行确认”</span>
        connectionFactory.setPublisherConfirms(<span class="hljs-keyword">true</span>);
        <span class="hljs-comment">//设置"发送消息后返回确认信息"</span>
        connectionFactory.setPublisherReturns(<span class="hljs-keyword">true</span>);
        <span class="hljs-comment">//构造发送消息组件实例对象</span>
        RabbitTemplate rabbitTemplate = <span class="hljs-keyword">new</span> RabbitTemplate(connectionFactory);
        rabbitTemplate.setMandatory(<span class="hljs-keyword">true</span>);
        <span class="hljs-comment">//发送消息后，如果发送成功，则输出“消息发送成功”的反馈信息</span>
        rabbitTemplate.setConfirmCallback(<span class="hljs-keyword">new</span> RabbitTemplate.ConfirmCallback() &#123;
            <span class="hljs-meta">@Override</span>
            <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">confirm</span><span class="hljs-params">(CorrelationData correlationData, <span class="hljs-keyword">boolean</span> ack, String cause)</span> </span>&#123;
                log.info(<span class="hljs-string">"消息发送成功：correlationData(&#123;&#125;),ack(&#123;&#125;),cause(&#123;&#125;)"</span>,correlationData,ack,cause);
            &#125;
        &#125;);
        <span class="hljs-comment">//发送消息后，如果发送失败，则输出"消息发送失败-消息丢失"的反馈信息</span>
        rabbitTemplate.setReturnCallback(<span class="hljs-keyword">new</span> RabbitTemplate.ReturnCallback() &#123;
            <span class="hljs-meta">@Override</span>
            <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">returnedMessage</span><span class="hljs-params">(Message message, <span class="hljs-keyword">int</span> replyCode, String replyText, String exchange, String routingKey)</span> </span>&#123;
                log.info(<span class="hljs-string">"“消息丢失：exchange(&#123;&#125;),route(&#123;&#125;),replyCode(&#123;&#125;),replyText(&#123;&#125;),message:&#123;&#125;"</span>,exchange,routingKey,replyCode,replyText,message);
            &#125;
        &#125;);
        <span class="hljs-comment">//最终返回RabbitMQ的操作组件实例RabbitTemplate</span>
        <span class="hljs-keyword">return</span> rabbitTemplate;
    &#125;
&#125;</code></pre></div>

<p>当RabbitMQ需要处理高并发业务场景时，可以通过配置“多消费实例”的方式来实现；而在正常情况下，对消息不需要并发监听消费处理时，则只需要配置“单一消费者实例”的容器工厂即可。</p>
<h3 id="5-2-4-RabbitMQ发送、接收消息实战"><a href="#5-2-4-RabbitMQ发送、接收消息实战" class="headerlink" title="5.2.4 RabbitMQ发送、接收消息实战"></a>5.2.4 RabbitMQ发送、接收消息实战</h3><p>以“生产者发送一串简单的字符串信息到基本的消息模型中，并由消费者进行监听消费处理”为案例进行代码演练</p>
<p>1、在RabbitmqConfig类中创建队列，交换机，路由及其绑定</p>
<div class="hljs"><pre><code class="hljs java"><span class="hljs-comment">/**</span>
<span class="hljs-comment">* 定义读取配置文件的环境变量实例</span>
<span class="hljs-comment">*/</span>
<span class="hljs-meta">@Autowired</span>
<span class="hljs-keyword">private</span> Environment env;
<span class="hljs-comment">/**创建简单消息模型：队列、交换机和路由 **/</span>
<span class="hljs-meta">@Bean</span>(name = <span class="hljs-string">"basicQueue"</span>)
<span class="hljs-function"><span class="hljs-keyword">public</span> Queue <span class="hljs-title">basicQueue</span><span class="hljs-params">()</span></span>&#123;
	<span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> Queue(env.getProperty(<span class="hljs-string">"mq.basic.info.queue.name"</span>),<span class="hljs-keyword">true</span>);
&#125;
<span class="hljs-meta">@Bean</span>
<span class="hljs-function"><span class="hljs-keyword">public</span> DirectExchange <span class="hljs-title">basicExchange</span><span class="hljs-params">()</span></span>&#123;
	<span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> DirectExchange(env.getProperty(<span class="hljs-string">"mq.basic.info.exchange.name"</span>),<span class="hljs-keyword">true</span>,<span class="hljs-keyword">false</span>);
&#125;
<span class="hljs-meta">@Bean</span>
<span class="hljs-function"><span class="hljs-keyword">public</span> Binding <span class="hljs-title">basicBinding</span><span class="hljs-params">()</span></span>&#123;
    <span class="hljs-keyword">return</span> 	BindingBuilder.bind(basicQueue()).to(basicExchange())
    .with(env.getProperty(<span class="hljs-string">"mq.basic.info.routing.key.name"</span>));
&#125;</code></pre></div>

<p>其中，环境变量实例env读取的相关变量是在配置文件application.properties</p>
<div class="hljs"><pre><code class="hljs properties"><span class="hljs-comment">#定义基本消息模型中队列、交换机和路由的名称</span>
<span class="hljs-meta">mq.basic.info.queue.name</span>=<span class="hljs-string">$&#123;mq.env&#125;.middleware.mq.basic.info.queue</span>
<span class="hljs-meta">mq.basic.info.exchange.name</span>=<span class="hljs-string">$&#123;mq.env&#125;.middleware.mq.basic.info.exchange</span>
<span class="hljs-meta">mq.basic.info.routing.key.name</span>=<span class="hljs-string">$&#123;mq.env&#125;.middleware.mq.basic.info.routing.key</span></code></pre></div>

<p>2、开发发送消息的生产者BasicPublisher，在这里指定待发送的消息为一串字符串值，代码如下：</p>
<div class="hljs"><pre><code class="hljs java"><span class="hljs-meta">@Component</span>
<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">BasicPublisher</span> </span>&#123;
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> Logger log = LoggerFactory.getLogger(BasicPublisher<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
    <span class="hljs-comment">/**</span>
<span class="hljs-comment">     * 定义JSON序列化和反序列化实例</span>
<span class="hljs-comment">     */</span>
    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> ObjectMapper objectMapper;
    <span class="hljs-comment">/**</span>
<span class="hljs-comment">     * 定义RabbitMQ消息操作组件RabbitTemplate</span>
<span class="hljs-comment">     */</span>
    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> RabbitTemplate rabbitTemplate;
    <span class="hljs-comment">/**</span>
<span class="hljs-comment">     * 定义环境变量读取实例</span>
<span class="hljs-comment">     */</span>
    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> Environment env;

    <span class="hljs-comment">/**</span>
<span class="hljs-comment">     * 发送消息</span>
<span class="hljs-comment">     *</span>
<span class="hljs-comment">     * <span class="hljs-doctag">@param</span> message 待发送的消息，即一串字符串值</span>
<span class="hljs-comment">     */</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">sendMsg</span><span class="hljs-params">(String message)</span> </span>&#123;
        <span class="hljs-comment">//判断字符串值是否为空</span>
        <span class="hljs-keyword">if</span> (!Strings.isNullOrEmpty(message)) &#123;
            <span class="hljs-keyword">try</span> &#123;
                <span class="hljs-comment">//定义消息传输的格式为JSON字符串格式</span>
                rabbitTemplate.setMessageConverter(<span class="hljs-keyword">new</span> Jackson2JsonMessageConverter());
                <span class="hljs-comment">//指定消息模型中的交换机</span>
                rabbitTemplate.setExchange(env.getProperty(<span class="hljs-string">"mq.basic.info.exchange.name"</span>));
                <span class="hljs-comment">//指定消息模型中的路由</span>
                rabbitTemplate.setRoutingKey(env.getProperty(<span class="hljs-string">"mq.basic.info.routing.key.name"</span>));
                <span class="hljs-comment">//将字符串值转化为待发送的消息，即一串二进制的数据流</span>
                Message msg = MessageBuilder.withBody(message.getBytes(<span class="hljs-string">"utf-8"</span>)).build();
                <span class="hljs-comment">//转化并发消息</span>
                rabbitTemplate.convertAndSend(msg);
                <span class="hljs-comment">//打印日志信息</span>
                log.info(<span class="hljs-string">"基本消息模型-生产者-发送消息：&#123;&#125;"</span>, message);
            &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;
                log.error(<span class="hljs-string">"基本消息模型-生产者-发送消息发生异常：&#123;&#125;"</span>, message, e.fillInStackTrace());
            &#125;
        &#125;
    &#125;
&#125;</code></pre></div>

<p>3、开发监听并接收消费处理信息的消费者实例BasicConsumer</p>
<div class="hljs"><pre><code class="hljs java"><span class="hljs-meta">@Component</span>
<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">BasicConsumer</span> </span>&#123;
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> Logger log = LoggerFactory.getLogger(BasicConsumer<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
    <span class="hljs-comment">/**</span>
<span class="hljs-comment">     * 定义JSON序列化和反序列化实例</span>
<span class="hljs-comment">     */</span>
    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> ObjectMapper objectMapper;

    <span class="hljs-comment">/**</span>
<span class="hljs-comment">     * 监听并接收消费队列中的消息-在这里采用单一容器工厂实例即可</span>
<span class="hljs-comment">     */</span>
    <span class="hljs-meta">@RabbitListener</span>(queues = <span class="hljs-string">"$&#123;mq.basic.info.queue.name&#125;"</span>, containerFactory = <span class="hljs-string">"singleListenerContainer"</span>)
    <span class="hljs-comment">/**由于消息本质上是一串二进制数据流，因而监听接收的消息采用字节数据接收*/</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">consumeMsg</span><span class="hljs-params">(@Payload <span class="hljs-keyword">byte</span>[] msg)</span> </span>&#123;
        <span class="hljs-keyword">try</span> &#123;
            <span class="hljs-comment">//将字节数组的消息转化为字符串并打印</span>
            String message = <span class="hljs-keyword">new</span> String(msg, <span class="hljs-string">"utf-8"</span>);
            log.info(<span class="hljs-string">"基本消息模型-消费者-监听消费到消息：&#123;&#125;"</span>, message);
        &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;
            log.error(<span class="hljs-string">"基本消息模型-消费者-发生异常："</span>, e.fillInStackTrace());
        &#125;
    &#125;
&#125;</code></pre></div>

<p>4、测试类</p>
<div class="hljs"><pre><code class="hljs java"><span class="hljs-meta">@RunWith</span>(SpringJUnit4ClassRunner<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>
<span class="hljs-class">@<span class="hljs-title">SpringBootTest</span></span>
<span class="hljs-class"><span class="hljs-title">public</span> <span class="hljs-title">class</span> <span class="hljs-title">RabbitmqTest</span> </span>&#123;
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> Logger log = LoggerFactory.getLogger(RabbitmqTest<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
    <span class="hljs-comment">/**定义JSON序列化和反序列化实例*/</span>
    <span class="hljs-keyword">private</span> ObjectMapper objectMapper;
    <span class="hljs-comment">/**定义基本消息模型中发送消息的生产者*/</span>
    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> BasicPublisher basicPublisher;
    <span class="hljs-comment">/**用于发送消息的测试方法*/</span>
    <span class="hljs-meta">@Test</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">test</span><span class="hljs-params">()</span></span>&#123;
        String msg = <span class="hljs-string">"~~~~这是一串字符串消息~~~"</span>;
        basicPublisher.sendMsg(msg);
    &#125;
&#125;</code></pre></div>

<h3 id="5-2-5-其他发送接收消息方式实战"><a href="#5-2-5-其他发送接收消息方式实战" class="headerlink" title="5.2.5 其他发送接收消息方式实战"></a>5.2.5 其他发送接收消息方式实战</h3><p>RabbitMQ在实际的应用系统中，可以通过发送字节型（通过getBytes()方法或者序列化方法）的消息和采用@RabbitListener接收字节数组类型的消息之外，还可以通过发送、接收“对象类型”的方式实现消息的发送和接收。</p>
<p>1、在server模块下建立一个用于RabbitMQ操作的消息对应的对象实体包目录：com.debug.middleware.server.rabbitmq.entity，并在该包目录下建立Person类：</p>
<div class="hljs"><pre><code class="hljs java"><span class="hljs-meta">@Data</span>
<span class="hljs-meta">@ToString</span>
<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Person</span> </span>&#123;
    <span class="hljs-keyword">private</span> Integer id;
    <span class="hljs-keyword">private</span> String name;
    <span class="hljs-keyword">private</span> String userName;

    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">Person</span><span class="hljs-params">()</span> </span>&#123;
    &#125;

    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">Person</span><span class="hljs-params">(Integer id, String name, String userName)</span> </span>&#123;
        <span class="hljs-keyword">this</span>.id = id;
        <span class="hljs-keyword">this</span>.name = name;
        <span class="hljs-keyword">this</span>.userName = userName;
    &#125;
&#125;</code></pre></div>

<p>2、在RabbitmqConfig配置类中创建用于发送对象类型消息的队列、交换机、路由及其绑定：</p>
<div class="hljs"><pre><code class="hljs java"><span class="hljs-comment">/**创建简单消息模型-对象类型：队列、交换机和路由*/</span>
   <span class="hljs-meta">@Bean</span>(name=<span class="hljs-string">"objectQueue"</span>)
   <span class="hljs-function"><span class="hljs-keyword">public</span> Queue <span class="hljs-title">objectQueue</span><span class="hljs-params">()</span></span>&#123;
       <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> Queue(env.getProperty(<span class="hljs-string">"mq.object.info.queue.name"</span>),<span class="hljs-keyword">true</span>);
   &#125;
   <span class="hljs-meta">@Bean</span>
   <span class="hljs-function"><span class="hljs-keyword">public</span> DirectExchange <span class="hljs-title">objectExchange</span><span class="hljs-params">()</span></span>&#123;
       <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> DirectExchange(env.getProperty(<span class="hljs-string">"mq.object.info.exchange.name"</span>),<span class="hljs-keyword">true</span>,<span class="hljs-keyword">false</span>);
   &#125;
   <span class="hljs-meta">@Bean</span>
   <span class="hljs-function"><span class="hljs-keyword">public</span> Binding <span class="hljs-title">objectBinding</span><span class="hljs-params">()</span></span>&#123;
       <span class="hljs-keyword">return</span> BindingBuilder.bind(objectQueue()).to(objectExchange())
               .with(env.getProperty(<span class="hljs-string">"mq.object.info.routing.key.name"</span>));
   &#125;</code></pre></div>

<p>参数配置</p>
<div class="hljs"><pre><code class="hljs properties"><span class="hljs-comment">#基本消息模型-对象消息</span>
<span class="hljs-meta">mq.object.info.queue.name</span>=<span class="hljs-string">$&#123;mq.env&#125;.middleware.mq.object.info.queue</span>
<span class="hljs-meta">mq.object.info.exchange.name</span>=<span class="hljs-string">$&#123;mq.env&#125;.middleware.mq.object.info.exchange</span>
<span class="hljs-meta">mq.object.info.routing.key.name</span>=<span class="hljs-string">$&#123;mq.env&#125;.middleware.mq.object.info.routing.key</span></code></pre></div>

<p>3、生产者</p>
<div class="hljs"><pre><code class="hljs java"><span class="hljs-comment">/**发送对象类型的消息*/</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">sendObjectMsg</span><span class="hljs-params">(Person p)</span></span>&#123;
        <span class="hljs-comment">//判断对象是否为空</span>
        <span class="hljs-keyword">if</span>(p != <span class="hljs-keyword">null</span>)&#123;
            <span class="hljs-keyword">try</span> &#123;
                <span class="hljs-comment">//设置消息在传输过程中的格式，这里指定为JSON格式</span>
                rabbitTemplate.setMessageConverter(<span class="hljs-keyword">new</span> Jackson2JsonMessageConverter());
                <span class="hljs-comment">//指定发送消息时对应的交换机</span>
                rabbitTemplate.setExchange(env.getProperty(<span class="hljs-string">"mq.object.info.exchange.name"</span>));
                <span class="hljs-comment">//指定发送消息时对应的路由</span>
                rabbitTemplate.setRoutingKey(env.getProperty(<span class="hljs-string">"mq.object.info.routing.key.name"</span>));
                <span class="hljs-comment">//采用convertAndSend方法即可发送消息</span>
                rabbitTemplate.convertAndSend(p, <span class="hljs-keyword">new</span> MessagePostProcessor() &#123;
                    <span class="hljs-meta">@Override</span>
                    <span class="hljs-function"><span class="hljs-keyword">public</span> Message <span class="hljs-title">postProcessMessage</span><span class="hljs-params">(Message message)</span> <span class="hljs-keyword">throws</span> AmqpException </span>&#123;
                        <span class="hljs-comment">//获取消息的属性</span>
                        MessageProperties messageProperties = message.getMessageProperties();
                        <span class="hljs-comment">//设置消息的持久化模式</span>
                        messageProperties.setDeliveryMode(MessageDeliveryMode.PERSISTENT);
                        <span class="hljs-comment">//设置消息的类型，这里指定为Person类型</span>
                        messageProperties.setHeader(AbstractJavaTypeMapper.DEFAULT_CONTENT_CLASSID_FIELD_NAME,Person<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
                        <span class="hljs-comment">//返回消息实例</span>
                        <span class="hljs-keyword">return</span> message;
                    &#125;
                &#125;);
                <span class="hljs-comment">//打印日志信息</span>
                log.info(<span class="hljs-string">"基本消息模型-生产者-发送对象类型的消息：&#123;&#125;"</span>,p);
            &#125;<span class="hljs-keyword">catch</span> (Exception e)&#123;
                log.error(<span class="hljs-string">"基本消息模型-生产者-发送对象类型的消息发生异常：&#123;&#125;"</span>,p,e.fillInStackTrace());
            &#125;
        &#125;</code></pre></div>

<p>如果需要发送对象类型的消息，则需要借助RabbitTemplate的convertAndSend方法，通过MessagePostProcessor的实现类直接指定待发送消息的类型。</p>
<p>4、开发用于监听消费处理消息的消费者功能</p>
<div class="hljs"><pre><code class="hljs java"><span class="hljs-meta">@RabbitListener</span>(queues = <span class="hljs-string">"$&#123;mq.object.info.queue.name&#125;"</span>,containerFactory = <span class="hljs-string">"singleListenerContainer"</span>)
   <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">consumeObjectMsg</span><span class="hljs-params">(@Payload Person person)</span></span>&#123;
       <span class="hljs-keyword">try</span> &#123;
           log.info(<span class="hljs-string">"基本消息模型-监听消费处理对象信息-消费者-监听消费到消息：&#123;&#125;"</span>,person);
       &#125;<span class="hljs-keyword">catch</span> (Exception e)&#123;
           log.error(<span class="hljs-string">"基本消息模型-监听消费处理对象信息-消费者-发生异常："</span>,e.fillInStackTrace());
       &#125;
   &#125;</code></pre></div>

<p>5、测试</p>
<div class="hljs"><pre><code class="hljs java"><span class="hljs-meta">@Test</span>
<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">test2</span><span class="hljs-params">()</span></span>&#123;
    Person p = <span class="hljs-keyword">new</span> Person(<span class="hljs-number">1</span>,<span class="hljs-string">"大圣"</span>,<span class="hljs-string">"debug"</span>);
    basicPublisher.sendObjectMsg(p);
&#125;</code></pre></div>

<h2 id="5-3-RabbitMQ多种消息模型实战"><a href="#5-3-RabbitMQ多种消息模型实战" class="headerlink" title="5.3 RabbitMQ多种消息模型实战"></a>5.3 RabbitMQ多种消息模型实战</h2><p>RabbitMQ的核心组件体系中，主要有4中典型的消息模型：即基于HeadersExchange的消息模型、基于fanoutExchange的消息模型、基于DirectExchange的消息模型以及基于TopicExchange的消息模型。</p>
<h3 id="5-3-1-基于FanoutExchange的消息模型实战"><a href="#5-3-1-基于FanoutExchange的消息模型实战" class="headerlink" title="5.3.1 基于FanoutExchange的消息模型实战"></a>5.3.1 基于FanoutExchange的消息模型实战</h3><p>交换机的一种，具有“广播消息”的作用，当消息进入交换机这个“中转站”时，交换机会检查哪个队列跟自己是绑定在一起的，找到相应的队列后，将消息传输到相应的绑定队列中，并最终由队列对应的消费者进行监听消费。</p>
<p>1、在RabbitmqConfig中创建交换机、多条队列及其绑定</p>
<div class="hljs"><pre><code class="hljs java"><span class="hljs-comment">/**创建消息模型-fanoutExchange*/</span>
  <span class="hljs-meta">@Bean</span>(name=<span class="hljs-string">"fanoutQueueOne"</span>)
  <span class="hljs-function"><span class="hljs-keyword">public</span> Queue <span class="hljs-title">fanoutQueueOne</span><span class="hljs-params">()</span></span>&#123;
      <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> Queue(env.getProperty(<span class="hljs-string">"mq.fanout.queue.one.name"</span>),<span class="hljs-keyword">true</span>);
  &#125;
  <span class="hljs-meta">@Bean</span>(name = <span class="hljs-string">"fanoutQueueTwo"</span>)
  <span class="hljs-function"><span class="hljs-keyword">public</span> Queue <span class="hljs-title">fanoutQueueTwo</span><span class="hljs-params">()</span></span>&#123;
      <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> Queue(env.getProperty(<span class="hljs-string">"mq.fanout.queue.two.name"</span>),<span class="hljs-keyword">true</span>);
  &#125;
  <span class="hljs-meta">@Bean</span>
  <span class="hljs-function"><span class="hljs-keyword">public</span> FanoutExchange <span class="hljs-title">fanoutExchange</span><span class="hljs-params">()</span></span>&#123;
      <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> FanoutExchange(env.getProperty(<span class="hljs-string">"mq.fanout.exchange.name"</span>),<span class="hljs-keyword">true</span>,<span class="hljs-keyword">false</span>);
  &#125;
  <span class="hljs-meta">@Bean</span>
  <span class="hljs-function"><span class="hljs-keyword">public</span> Binding <span class="hljs-title">fanoutBindingOne</span><span class="hljs-params">()</span></span>&#123;
      <span class="hljs-keyword">return</span> BindingBuilder.bind(fanoutQueueOne()).to(fanoutExchange());
  &#125;
  <span class="hljs-meta">@Bean</span>
  <span class="hljs-function"><span class="hljs-keyword">public</span> Binding <span class="hljs-title">fanoutBindingTwo</span><span class="hljs-params">()</span></span>&#123;
      <span class="hljs-keyword">return</span> BindingBuilder.bind(fanoutQueueTwo()).to(fanoutExchange());
  &#125;</code></pre></div>

<p>环境变量实例env读取的变量所在配置文件</p>
<div class="hljs"><pre><code class="hljs properties"><span class="hljs-comment">#消息模型-fanoutExchange</span>
<span class="hljs-meta">mq.fanout.queue.one.name</span>=<span class="hljs-string">$&#123;mq.env&#125;.middleware.mq.fanout.one.queue</span>
<span class="hljs-meta">mq.fanout.queue.two.name</span>=<span class="hljs-string">$&#123;mq.env&#125;.middleware.mq.fanout.two.queue</span>
<span class="hljs-meta">mq.fanout.exchange.name</span>=<span class="hljs-string">$&#123;mq.env&#125;.middleware.mq.fanout.exchange</span></code></pre></div>

<p>2、创建对象实体信息EventInfo</p>
<div class="hljs"><pre><code class="hljs java"><span class="hljs-meta">@Data</span>
<span class="hljs-meta">@ToString</span>
<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">EventInfo</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">Serializable</span> </span>&#123;
    <span class="hljs-keyword">private</span> Integer id;
    <span class="hljs-keyword">private</span> String <span class="hljs-keyword">module</span>;
    <span class="hljs-keyword">private</span> String name;
    <span class="hljs-keyword">private</span> String desc;

    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">EventInfo</span><span class="hljs-params">()</span> </span>&#123;
    &#125;

    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">EventInfo</span><span class="hljs-params">(Integer id, String <span class="hljs-keyword">module</span>, String name, String desc)</span> </span>&#123;
        <span class="hljs-keyword">this</span>.id = id;
        <span class="hljs-keyword">this</span>.<span class="hljs-keyword">module</span> = <span class="hljs-keyword">module</span>;
        <span class="hljs-keyword">this</span>.name = name;
        <span class="hljs-keyword">this</span>.desc = desc;
    &#125;
&#125;</code></pre></div>

<p>3、开发生产消息的生产者ModelPublisher类</p>
<div class="hljs"><pre><code class="hljs java"><span class="hljs-meta">@Component</span>
<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ModelPublisher</span> </span>&#123;
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> Logger log = LoggerFactory.getLogger(ModelPublisher<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
    <span class="hljs-comment">/**JSON序列化和反序列化组件*/</span>
    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> ObjectMapper objectMapper;
    <span class="hljs-comment">/**定义发送消息的操作组件RabbitTemplate*/</span>
    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> RabbitTemplate rabbitTemplate;
    <span class="hljs-comment">/**定义读取环境变量的实例*/</span>
    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> Environment env;
    
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">sendMsg</span><span class="hljs-params">(EventInfo info)</span></span>&#123;
        <span class="hljs-keyword">if</span>(info != <span class="hljs-keyword">null</span>)&#123;
            <span class="hljs-keyword">try</span> &#123;
                <span class="hljs-comment">//定义消息的传输格式为JSON</span>
                rabbitTemplate.setMessageConverter(<span class="hljs-keyword">new</span> Jackson2JsonMessageConverter());
                <span class="hljs-comment">//设置广播式交换机FanoutExchange</span>
                rabbitTemplate.setExchange(env.getProperty(<span class="hljs-string">"mq.fanout.exchange.name"</span>));
                <span class="hljs-comment">//创建消息实例</span>
                Message msg = MessageBuilder.withBody(objectMapper.writeValueAsBytes(info)).build();
                <span class="hljs-comment">//发送消息</span>
                rabbitTemplate.convertAndSend(msg);
                <span class="hljs-comment">//打印日志</span>
                log.info(<span class="hljs-string">"消息模型fanoutExchange-生产者-发送消息：&#123;&#125;"</span>,info);
            &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;
                log.error(<span class="hljs-string">"消息模型fanoutExchange-生产者-发送消息发生异常：&#123;&#125;"</span>,info,e.fillInStackTrace());
            &#125;
        &#125;
    &#125;
&#125;</code></pre></div>

<p>4、开发用于监听接收消费处理消息的消费者ModelConsumer，开发两条队列分别对应的监听消费方法</p>
<div class="hljs"><pre><code class="hljs java"><span class="hljs-meta">@Component</span>
<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ModelConsumer</span> </span>&#123;
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> Logger log = LoggerFactory.getLogger(ModelConsumer<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">public</span> ObjectMapper objectMapper;

    <span class="hljs-comment">/**</span>
<span class="hljs-comment">     * 监听消费队列中的消息-fanoutExchange-one-这是第一条队列对应的消费者</span>
<span class="hljs-comment">     * <span class="hljs-doctag">@param</span> msg</span>
<span class="hljs-comment">     */</span>
    <span class="hljs-meta">@RabbitListener</span>(queues = <span class="hljs-string">"$&#123;mq.fanout.queue.one.name&#125;"</span>,containerFactory = <span class="hljs-string">"singleListenerContainer"</span>)
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">consumeFanoutMsgOne</span><span class="hljs-params">(@Payload <span class="hljs-keyword">byte</span>[] msg)</span></span>&#123;
        <span class="hljs-keyword">try</span> &#123;
            <span class="hljs-comment">//监听消费队列中的消息，并进行解析处理</span>
            EventInfo info = objectMapper.readValue(msg, EventInfo<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
            log.info(<span class="hljs-string">"消息模型fanoutExchange-one-消费者-监听消费到消息：&#123;&#125;"</span>,info);
        &#125;<span class="hljs-keyword">catch</span> (Exception e)&#123;
            log.error(<span class="hljs-string">"消息模型-消费者-发生异常:"</span>,e.fillInStackTrace());
        &#125;
    &#125;
    <span class="hljs-comment">/**</span>
<span class="hljs-comment">     * 监听消费队列中的消息-fanoutExchange-two-这是第二条队列对应的消费者</span>
<span class="hljs-comment">     * <span class="hljs-doctag">@param</span> msg</span>
<span class="hljs-comment">     */</span>
    <span class="hljs-meta">@RabbitListener</span>(queues = <span class="hljs-string">"$&#123;mq.fanout.queue.two.name&#125;"</span>,containerFactory = <span class="hljs-string">"singleListenerContainer"</span>)
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">consumeFanoutMsgTwo</span><span class="hljs-params">(@Payload <span class="hljs-keyword">byte</span>[] msg)</span></span>&#123;
        <span class="hljs-keyword">try</span> &#123;
            <span class="hljs-comment">//监听消费队列中的消息，并进行解析处理</span>
            EventInfo info = objectMapper.readValue(msg, EventInfo<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
            log.info(<span class="hljs-string">"消息模型fanoutExchange-two-消费者-监听消费到消息：&#123;&#125;"</span>,info);
        &#125;<span class="hljs-keyword">catch</span> (Exception e)&#123;
            log.error(<span class="hljs-string">"消息模型-消费者-发生异常:"</span>,e.fillInStackTrace());
        &#125;
    &#125;
&#125;</code></pre></div>

<p>5、测试类</p>
<div class="hljs"><pre><code class="hljs java"><span class="hljs-meta">@Autowired</span>
   <span class="hljs-keyword">private</span> ModelPublisher modelPublisher;
   <span class="hljs-meta">@Test</span>
   <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">test3</span><span class="hljs-params">()</span></span>&#123;
       <span class="hljs-comment">//创建对象实例</span>
       EventInfo info = <span class="hljs-keyword">new</span> EventInfo(<span class="hljs-number">1</span>, <span class="hljs-string">"增删改查模块"</span>, <span class="hljs-string">"基于fanoutExchange的消息模型"</span>, <span class="hljs-string">"这是基于fanoutExchange的消息模型"</span>);
       <span class="hljs-comment">//触发生产者发送消息</span>
       modelPublisher.sendMsg(info);
   &#125;</code></pre></div>

<p>效果：</p>
<div class="hljs"><pre><code class="hljs routeros">[2021-02-01 10:16:11.011] boot -  <span class="hljs-builtin-name">INFO</span> [SimpleAsyncTaskExecutor-1] ---ModelConsumer: 消息模型fanoutExchange-two-消费者-监听消费到消息：EventInfo(<span class="hljs-attribute">id</span>=1, <span class="hljs-attribute">module</span>=增删改查模块, <span class="hljs-attribute">name</span>=基于fanoutExchange的消息模型, <span class="hljs-attribute">desc</span>=这是基于fanoutExchange的消息模型)
[2021-02-01 10:16:11.011] boot -  <span class="hljs-builtin-name">INFO</span> [SimpleAsyncTaskExecutor-1] ---ModelConsumer: 消息模型fanoutExchange-one-消费者-监听消费到消息：EventInfo(<span class="hljs-attribute">id</span>=1, <span class="hljs-attribute">module</span>=增删改查模块, <span class="hljs-attribute">name</span>=基于fanoutExchange的消息模型, <span class="hljs-attribute">desc</span>=这是基于fanoutExchange的消息模型)</code></pre></div>

<p>由于该FanoutExchange绑定了两条队列，因而两条队列分别对应的消费者将监听接收到相应的消息。</p>
<p>总结：</p>
<p>基于FanoutExchange消费模型主要的核心组件是交换机和队列，一个交换机可以对应并绑定多个队列，从而对应多个消费者！</p>
<p>此种消费模型适用于“业务数据需要广播传输”的场景，比如“用户操作写日志”。</p>
<h3 id="5-3-2-基于DirectExchange的消息模型实战"><a href="#5-3-2-基于DirectExchange的消息模型实战" class="headerlink" title="5.3.2 基于DirectExchange的消息模型实战"></a>5.3.2 基于DirectExchange的消息模型实战</h3><p>交换机，具有“直连传输消息”的作用，即当消息进入交换机这个“中转站”时，交换机会检查哪个路由跟自己绑定在一起，并根据生产者发送消息指定的路由进行匹配，如果能找到对应的绑定模型，则将消息直接路由传输到指定的队列，最终由队列对应的消费者进行监听消费。</p>
<p>业务场景：将实体对象信息当做消息，并发送到基于DirectExchange构成的消息模型中，根据绑定的路由，将消息路由至对应绑定的队列中，最终由对应的消费者进行监听消费处理。</p>
<p>1、在RabbitmqConfig配置文件中创建一个交换机、两个路由和对应绑定的两条队列。</p>
<div class="hljs"><pre><code class="hljs java"><span class="hljs-comment">/**创建消息模型-DirectExchange*/</span>
   <span class="hljs-meta">@Bean</span>
   <span class="hljs-function"><span class="hljs-keyword">public</span> DirectExchange <span class="hljs-title">directExchange</span><span class="hljs-params">()</span></span>&#123;
       <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> DirectExchange(env.getProperty(<span class="hljs-string">"mq.direct.exchange.name"</span>),<span class="hljs-keyword">true</span>,<span class="hljs-keyword">false</span>);
   &#125;
   <span class="hljs-meta">@Bean</span>(name = <span class="hljs-string">"directQueueOne"</span>)
   <span class="hljs-function"><span class="hljs-keyword">public</span> Queue <span class="hljs-title">directQueueOne</span><span class="hljs-params">()</span></span>&#123;
       <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> Queue(env.getProperty(<span class="hljs-string">"mq.direct.queue.one.name"</span>),<span class="hljs-keyword">true</span>);
   &#125;
   <span class="hljs-meta">@Bean</span>(name = <span class="hljs-string">"directQueueTwo"</span>)
   <span class="hljs-function"><span class="hljs-keyword">public</span> Queue <span class="hljs-title">directQueueTwo</span><span class="hljs-params">()</span></span>&#123;
       <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> Queue(env.getProperty(<span class="hljs-string">"mq.direct.queue.two.name"</span>),<span class="hljs-keyword">true</span>);
   &#125;
   <span class="hljs-meta">@Bean</span>
   <span class="hljs-function"><span class="hljs-keyword">public</span> Binding <span class="hljs-title">directBindOne</span><span class="hljs-params">()</span></span>&#123;
       <span class="hljs-keyword">return</span> BindingBuilder.bind(directQueueOne()).to(directExchange())
               .with(env.getProperty(<span class="hljs-string">"mq.direct.routing.key.one.name"</span>));
   &#125;
   <span class="hljs-meta">@Bean</span>
   <span class="hljs-function"><span class="hljs-keyword">public</span> Binding <span class="hljs-title">directBindTwo</span><span class="hljs-params">()</span></span>&#123;
       <span class="hljs-keyword">return</span> BindingBuilder.bind(directQueueTwo()).to(directExchange())
               .with(env.getProperty(<span class="hljs-string">"mq.direct.routing.key.two.name"</span>));
   &#125;</code></pre></div>

<p>配置文件中变量取值如下：</p>
<div class="hljs"><pre><code class="hljs properties"><span class="hljs-comment">#消息模型DirectExchange</span>
<span class="hljs-meta">mq.direct.exchange.name</span>=<span class="hljs-string">$&#123;mq.env&#125;.middleware.mq.direct.exchange</span>
<span class="hljs-meta">mq.direct.routing.key.one.name</span>=<span class="hljs-string">$&#123;mq.env&#125;.middleware.mq.direct.routing.key.one</span>
<span class="hljs-meta">mq.direct.routing.key.two.name</span>=<span class="hljs-string">$&#123;mq.env&#125;.middleware.mq.direct.routing.key.two</span>
<span class="hljs-meta">mq.direct.queue.one.name</span>=<span class="hljs-string">$&#123;mq.env&#125;.middleware.mq.direct.one.queue</span>
<span class="hljs-meta">mq.direct.queue.two.name</span>=<span class="hljs-string">$&#123;mq.env&#125;.middleware.mq.direct.two.queue</span></code></pre></div>

<p>2、生产者，开发两个用于发送消息的生产者方法</p>
<div class="hljs"><pre><code class="hljs java"><span class="hljs-comment">/**</span>
<span class="hljs-comment">     * 发送消息-基于DirectExchange消息模型-one</span>
<span class="hljs-comment">     */</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">sendMsgDirectOne</span><span class="hljs-params">(EventInfo info)</span></span>&#123;
        <span class="hljs-keyword">if</span>(info != <span class="hljs-keyword">null</span>)&#123;
            <span class="hljs-keyword">try</span> &#123;
                <span class="hljs-comment">//设置消息传输的格式为JSON</span>
                rabbitTemplate.setMessageConverter(<span class="hljs-keyword">new</span> Jackson2JsonMessageConverter());
                <span class="hljs-comment">//设置交换机</span>
                rabbitTemplate.setExchange(env.getProperty(<span class="hljs-string">"mq.direct.exchange.name"</span>));
                <span class="hljs-comment">//设置路由1</span>
                rabbitTemplate.setRoutingKey(env.getProperty(<span class="hljs-string">"mq.direct.routing.key.one.name"</span>));
                <span class="hljs-comment">//创建消息</span>
                Message msg = MessageBuilder.withBody(objectMapper.writeValueAsBytes(info)).build();
                <span class="hljs-comment">//发送消息</span>
                rabbitTemplate.convertAndSend(msg);
                <span class="hljs-comment">//打印日志</span>
                log.info(<span class="hljs-string">"消息模型DirectExchange-one-生产者-发送消息：&#123;&#125;"</span>,info);
            &#125;<span class="hljs-keyword">catch</span> (Exception e)&#123;
                log.error(<span class="hljs-string">"消息模型DirectExchange-one-生产者-发送消息发生异常：&#123;&#125;"</span>,info,e.fillInStackTrace());
            &#125;
        &#125;
    &#125;

    <span class="hljs-comment">/**</span>
<span class="hljs-comment">     * 发送消息-基于DirectExchange消息模型-two</span>
<span class="hljs-comment">     * <span class="hljs-doctag">@param</span> info</span>
<span class="hljs-comment">     */</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">sendMsgDirectTwo</span><span class="hljs-params">(EventInfo info)</span></span>&#123;
        <span class="hljs-keyword">if</span> (info != <span class="hljs-keyword">null</span>)&#123;
            <span class="hljs-keyword">try</span> &#123;
                rabbitTemplate.setMessageConverter(<span class="hljs-keyword">new</span> Jackson2JsonMessageConverter());
                rabbitTemplate.setExchange(env.getProperty(<span class="hljs-string">"mq.direct.exchange.name"</span>));
                rabbitTemplate.setRoutingKey(env.getProperty(<span class="hljs-string">"mq.direct.routing.key.two.name"</span>));
                Message msg = MessageBuilder.withBody(objectMapper.writeValueAsBytes(info)).build();
                rabbitTemplate.convertAndSend(msg);
                log.info(<span class="hljs-string">"消息模型DirectExchange-two-生产者-发送消息：&#123;&#125;"</span>,info);
            &#125;<span class="hljs-keyword">catch</span> (Exception e)&#123;
                log.error(<span class="hljs-string">"消息模型DirectExchange-two-生产者-发送消息发生异常：&#123;&#125;"</span>,info,e.fillInStackTrace());
            &#125;
        &#125;
    &#125;</code></pre></div>

<p>3、两个消费者方法，用于监听不同队列中的消息</p>
<div class="hljs"><pre><code class="hljs java"><span class="hljs-comment">/**</span>
<span class="hljs-comment">    * 第一个路由绑定的对应队列的消费者方法</span>
<span class="hljs-comment">    * <span class="hljs-doctag">@param</span> msg</span>
<span class="hljs-comment">    */</span>
   <span class="hljs-meta">@RabbitListener</span>(queues = <span class="hljs-string">"$&#123;mq.direct.queue.one.name&#125;"</span>,containerFactory = <span class="hljs-string">"singleListenerContainer"</span>)
   <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">consumeDirectMsgOne</span><span class="hljs-params">(@Payload <span class="hljs-keyword">byte</span>[] msg)</span></span>&#123;
       <span class="hljs-keyword">try</span> &#123;
           <span class="hljs-comment">//监听消费信息并进行JSON反序列化解析</span>
           EventInfo info = objectMapper.readValue(msg, EventInfo<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
           <span class="hljs-comment">//打印日志消息</span>
           log.info(<span class="hljs-string">"消息模型DirectExchange-one-消费者-监听消费到消息：&#123;&#125;"</span>,info);
       &#125;<span class="hljs-keyword">catch</span> (Exception e)&#123;
           log.error(<span class="hljs-string">"消息模型DirectExchange-one-消费者-监听消费发生异常："</span>,e.fillInStackTrace());
       &#125;
   &#125;
   <span class="hljs-comment">/**</span>
<span class="hljs-comment">    * 第二个路由绑定的对应队列的消费者方法</span>
<span class="hljs-comment">    * <span class="hljs-doctag">@param</span> msg</span>
<span class="hljs-comment">    */</span>
   <span class="hljs-meta">@RabbitListener</span>(queues = <span class="hljs-string">"$&#123;mq.direct.queue.two.name&#125;"</span>,containerFactory = <span class="hljs-string">"singleListenerContainer"</span>)
   <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">consumeDirectMsgTwo</span><span class="hljs-params">(@Payload <span class="hljs-keyword">byte</span>[] msg)</span> </span>&#123;
       <span class="hljs-keyword">try</span> &#123;
           <span class="hljs-comment">//监听消费信息并进行JSON反序列化解析</span>
           EventInfo info = objectMapper.readValue(msg, EventInfo<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
           <span class="hljs-comment">//打印日志消息</span>

           log.info(<span class="hljs-string">"消息模型DirectExchange-two-消费者-监听消费到消息：&#123;&#125;"</span>, info);
       &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;
           log.error(<span class="hljs-string">"消息模型DirectExchange-two-消费者-监听消费发生异常："</span>, e.fillInStackTrace());
       &#125;
   &#125;</code></pre></div>

<p>4、测试类</p>
<div class="hljs"><pre><code class="hljs java"><span class="hljs-meta">@Test</span>
   <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">test4</span><span class="hljs-params">()</span></span>&#123;
       <span class="hljs-comment">//创建对象实例</span>
       EventInfo info = <span class="hljs-keyword">new</span> EventInfo(
               <span class="hljs-number">1</span>,
               <span class="hljs-string">"增删改查模块-1"</span>,
               <span class="hljs-string">"基于directExchange的消息模型-1"</span>,
               <span class="hljs-string">"这是基于directExchange的消息模型-1"</span>);
       <span class="hljs-comment">//触发生产者发送消息</span>
       modelPublisher.sendMsgDirectOne(info);
       info = <span class="hljs-keyword">new</span> EventInfo(
               <span class="hljs-number">2</span>,
               <span class="hljs-string">"增删改查模块-2"</span>,
               <span class="hljs-string">"基于directExchange的消息模型-2"</span>,
               <span class="hljs-string">"这是基于directExchange的消息模型-2"</span>);
       modelPublisher.sendMsgDirectTwo(info);
   &#125;</code></pre></div>

<p>效果：各自的消费者都监听消费到了各自的消息</p>
<h3 id="5-3-3-基于TopicExchange的消息模型实战"><a href="#5-3-3-基于TopicExchange的消息模型实战" class="headerlink" title="5.3.3 基于TopicExchange的消息模型实战"></a>5.3.3 基于TopicExchange的消息模型实战</h3><p>“发布-主题-订阅”式的交换机，可以通过为路由的名称指定特定的通配符“<em>”和“#”，从而绑定到不同的队列中。“\</em>“表示一个特定的单词，“#”表示任意的单词（可以是一个，多个，也可以没有）</p>
<p>业务场景：将一串字符串信息当做消息，并发送到基于TopicExchange构成的消息模型中，根据绑定的路由将消息路由至绑定的队列中，最终由对应的消费者进行监听消费处理。</p>
<p>1、在RabbitmqConfig配置文件中创建基于TopicExchange的消息模型，这里创建一个交换机、两个分别包含通配符“*”和“#”的路由及队列绑定</p>
<div class="hljs"><pre><code class="hljs java"><span class="hljs-comment">/**创建绑定-通配符为*的路由*/</span>
   <span class="hljs-meta">@Bean</span>
   <span class="hljs-function"><span class="hljs-keyword">public</span> Binding <span class="hljs-title">topicBindingOne</span><span class="hljs-params">()</span></span>&#123;
       <span class="hljs-keyword">return</span> BindingBuilder.bind(topicQueueOne()).to(topicExchange())
               .with(env.getProperty(<span class="hljs-string">"mq.topic.routing.key.one.name"</span>));
   &#125;
   <span class="hljs-comment">/**创建绑定-通配符为#的路由*/</span>
   <span class="hljs-meta">@Bean</span>
   <span class="hljs-function"><span class="hljs-keyword">public</span> Binding <span class="hljs-title">topicBindingTwo</span><span class="hljs-params">()</span></span>&#123;
       <span class="hljs-keyword">return</span> BindingBuilder.bind(topicQueueTwo()).to(topicExchange())
               .with(env.getProperty(<span class="hljs-string">"mq.topic.routing.key.two.name"</span>));
   &#125;</code></pre></div>

<p>环境变量实例env读取的变量取值：</p>
<div class="hljs"><pre><code class="hljs properties"><span class="hljs-comment">#消息模型-TopicExchange</span>
<span class="hljs-meta">mq.topic.exchange.name</span>=<span class="hljs-string">$&#123;mq.env&#125;.middleware.mq.topic.exchange</span>
<span class="hljs-meta">mq.topic.routing.key.one.name</span>=<span class="hljs-string">$&#123;mq.env&#125;.middleware.mq.topic.routing.*.key</span>
<span class="hljs-meta">mq.topic.routing.key.two.name</span>=<span class="hljs-string">$&#123;mq.env&#125;.middleware.mq.topic.routing.#.key</span>
<span class="hljs-meta">mq.topic.queue.one.name</span>=<span class="hljs-string">$&#123;mq.env&#125;.middleware.mq.topic.one.queue</span>
<span class="hljs-meta">mq.topic.queue.two.name</span>=<span class="hljs-string">$&#123;mq.env&#125;.middleware.mq.topic.two.queue</span></code></pre></div>

<p>2、生产者，这里将“路由”参数开放出来，供调用者调用时指定该参数值，目的是用于测试两个通配符所起的作用。</p>
<div class="hljs"><pre><code class="hljs java"><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">sendMsgTopic</span><span class="hljs-params">(String msg,String routingKey)</span></span>&#123;
       <span class="hljs-keyword">if</span>(!Strings.isNullOrEmpty(msg) &amp;&amp; !Strings.isNullOrEmpty(routingKey))&#123;
           <span class="hljs-keyword">try</span> &#123;
               <span class="hljs-comment">//设置消息的传输格式为JSON</span>
               rabbitTemplate.setMessageConverter(<span class="hljs-keyword">new</span> Jackson2JsonMessageConverter());
               <span class="hljs-comment">//指定交换机</span>
               rabbitTemplate.setExchange(env.getProperty(<span class="hljs-string">"mq.topic.exchange.name"</span>));
               <span class="hljs-comment">//指定路由的实际取值，根据不同取值，RabbitMQ将自行进行匹配通配符，从而路由到不同的队列中</span>
               rabbitTemplate.setRoutingKey(routingKey);
               <span class="hljs-comment">//创建消息</span>
               Message message = MessageBuilder.withBody(msg.getBytes(<span class="hljs-string">"UTF-8"</span>)).build();
               <span class="hljs-comment">//发送消息</span>
               rabbitTemplate.convertAndSend(message);
               <span class="hljs-comment">//打印日志</span>
               log.info(<span class="hljs-string">"消息模型TopicExchange-生产者-发送消息：&#123;&#125; 路由：&#123;&#125; "</span>,msg,routingKey);
           &#125;<span class="hljs-keyword">catch</span> (Exception e)&#123;
               log.error(<span class="hljs-string">"消息模型TopicExchange-生产者-发送消息发生异常：&#123;&#125;"</span>,msg,e.fillInStackTrace());
           &#125;
       &#125;</code></pre></div>

<p>3、开发用于监听消费消息的消费者</p>
<div class="hljs"><pre><code class="hljs java"><span class="hljs-comment">/**</span>
<span class="hljs-comment">     * 监听消费队列中的消息-TopicExchange-*通配符</span>
<span class="hljs-comment">     * <span class="hljs-doctag">@param</span> msg</span>
<span class="hljs-comment">     */</span>
    <span class="hljs-meta">@RabbitListener</span>(queues = <span class="hljs-string">"$&#123;mq.topic.queue.one.name&#125;"</span>,containerFactory = <span class="hljs-string">"singleListenerContainer"</span>)
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">consumeTopicMsgOne</span><span class="hljs-params">(@Payload <span class="hljs-keyword">byte</span>[] msg)</span></span>&#123;
        <span class="hljs-keyword">try</span> &#123;
            String message = <span class="hljs-keyword">new</span> String(msg, <span class="hljs-string">"utf-8"</span>);
            log.info(<span class="hljs-string">"消息模型-TopicExchange-*-消费者-监听消费到消息：&#123;&#125;"</span>,message);
        &#125;<span class="hljs-keyword">catch</span> (Exception e)&#123;
            log.error(<span class="hljs-string">"消息模型-TopicExchange-*-消费者-监听消息发生异常："</span>,e.fillInStackTrace());
        &#125;
    &#125;
    <span class="hljs-comment">/**</span>
<span class="hljs-comment">     * 监听消费队列中的消息-TopicExchange-#通配符</span>
<span class="hljs-comment">     * <span class="hljs-doctag">@param</span> msg</span>
<span class="hljs-comment">     */</span>
    <span class="hljs-meta">@RabbitListener</span>(queues = <span class="hljs-string">"$&#123;mq.topic.queue.two.name&#125;"</span>,containerFactory = <span class="hljs-string">"singleListenerContainer"</span>)
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">consumeTopicMsgTwo</span><span class="hljs-params">(@Payload <span class="hljs-keyword">byte</span>[] msg)</span></span>&#123;
        <span class="hljs-keyword">try</span> &#123;
            String message = <span class="hljs-keyword">new</span> String(msg, <span class="hljs-string">"utf-8"</span>);
            log.info(<span class="hljs-string">"消息模型-TopicExchange-#-消费者-监听消费到消息：&#123;&#125;"</span>,message);
        &#125;<span class="hljs-keyword">catch</span> (Exception e)&#123;
            log.error(<span class="hljs-string">"消息模型-TopicExchange-#-消费者-监听消息发生异常："</span>,e.fillInStackTrace());
        &#125;
    &#125;</code></pre></div>

<p>4、测试类：</p>
<div class="hljs"><pre><code class="hljs java">  <span class="hljs-meta">@Test</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">test5</span><span class="hljs-params">()</span></span>&#123;
        String msg = <span class="hljs-string">"这是TopicExchange消息模型的消息"</span>;
        String routingKeyOne = <span class="hljs-string">"local.middleware.mq.topic.routing.java.key"</span>;
        String routingKeyTwo = <span class="hljs-string">"local.middleware.mq.topic.routing.php.python.key"</span>;
        String routingKeyThree = <span class="hljs-string">"local.middleware.mq.topic.routing.key"</span>;
<span class="hljs-comment">//        modelPublisher.sendMsgTopic(msg,routingKeyOne);</span>
        modelPublisher.sendMsgTopic(msg,routingKeyTwo);
<span class="hljs-comment">//        modelPublisher.sendMsgTopic(msg,routingKeyThree);</span>
    &#125;</code></pre></div>

<p>TopicExchange消息模型适用于“发布订阅主题式”的场景，具有普适性的特点。</p>
<h2 id="5-4-RabbitMQ确认消费机制"><a href="#5-4-RabbitMQ确认消费机制" class="headerlink" title="5.4 RabbitMQ确认消费机制"></a>5.4 RabbitMQ确认消费机制</h2><p>RabbitMQ在消息的发送、传输和接收过程中，可以保证消息成功发送、不会丢失，以及被确认消费。</p>
<h3 id="5-4-1-消息高可用和确认消费"><a href="#5-4-1-消息高可用和确认消费" class="headerlink" title="5.4.1 消息高可用和确认消费"></a>5.4.1 消息高可用和确认消费</h3><p>1、RabbitMQ会在生产者在发送完消息之后进行“发送确认”，当确认成功时即代表消息一经成功发送出去了，相关代码如下：</p>
<div class="hljs"><pre><code class="hljs java"><span class="hljs-comment">/**自定义配置RabbitMQ发送消息的操作组件RabbitTemplate*/</span>
    <span class="hljs-meta">@Bean</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> RabbitTemplate <span class="hljs-title">rabbitTemplate</span><span class="hljs-params">()</span></span>&#123;
        <span class="hljs-comment">//设置“发送消息后进行确认”</span>
        connectionFactory.setPublisherConfirms(<span class="hljs-keyword">true</span>);
        <span class="hljs-comment">//设置"发送消息后返回确认信息"</span>
        connectionFactory.setPublisherReturns(<span class="hljs-keyword">true</span>);
        <span class="hljs-comment">//构造发送消息组件实例对象</span>
        RabbitTemplate rabbitTemplate = <span class="hljs-keyword">new</span> RabbitTemplate(connectionFactory);
        rabbitTemplate.setMandatory(<span class="hljs-keyword">true</span>);
        <span class="hljs-comment">//发送消息后，如果发送成功，则输出“消息发送成功”的反馈信息</span>
        rabbitTemplate.setConfirmCallback(<span class="hljs-keyword">new</span> RabbitTemplate.ConfirmCallback() &#123;
            <span class="hljs-meta">@Override</span>
            <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">confirm</span><span class="hljs-params">(CorrelationData correlationData, <span class="hljs-keyword">boolean</span> ack, String cause)</span> </span>&#123;
                log.info(<span class="hljs-string">"消息发送成功：correlationData(&#123;&#125;),ack(&#123;&#125;),cause(&#123;&#125;)"</span>,correlationData,ack,cause);
            &#125;
        &#125;);
        <span class="hljs-comment">//发送消息后，如果发送失败，则输出"消息发送失败-消息丢失"的反馈信息</span>
        rabbitTemplate.setReturnCallback(<span class="hljs-keyword">new</span> RabbitTemplate.ReturnCallback() &#123;
            <span class="hljs-meta">@Override</span>
            <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">returnedMessage</span><span class="hljs-params">(Message message, <span class="hljs-keyword">int</span> replyCode, String replyText, String exchange, String routingKey)</span> </span>&#123;
                log.info(<span class="hljs-string">"“消息丢失：exchange(&#123;&#125;),route(&#123;&#125;),replyCode(&#123;&#125;),replyText(&#123;&#125;),message:&#123;&#125;"</span>,exchange,routingKey,replyCode,replyText,message);
            &#125;
        &#125;);
        <span class="hljs-comment">//最终返回RabbitMQ的操作组件实例RabbitTemplate</span>
        <span class="hljs-keyword">return</span> rabbitTemplate;
    &#125;</code></pre></div>

<p>2、保证RabbitMQ队列中的消息“不丢失”，是在创建队列、交换机时设置其持久化参数为true，即durable参数取值为true。</p>
<p><img src="https://gitee.com/yang_yu_jie/blog-img/raw/master/img/20210530101930.png" srcset="/img/loading.gif" alt="在这里插入图片描述"></p>
<p>在创建消息时，RabbitMQ要求设置消息的持久化模式为“持久化”，从而保证RabbitMQ服务器出现崩溃并执行重启操作之后，队列、交换机仍旧存在而且消息不会丢失。</p>
<div class="hljs"><pre><code class="hljs java"><span class="hljs-function"><span class="hljs-keyword">public</span> Message <span class="hljs-title">postProcessMessage</span><span class="hljs-params">(Message message)</span> <span class="hljs-keyword">throws</span> AmqpException </span>&#123;
                        <span class="hljs-comment">//获取消息的属性</span>
                        MessageProperties messageProperties = message.getMessageProperties();
                        <span class="hljs-comment">//设置消息的持久化模式</span>
                        messageProperties.setDeliveryMode(MessageDeliveryMode.PERSISTENT);
                        <span class="hljs-comment">//设置消息的类型，这里指定为Person类型</span>
                        messageProperties.setHeader(AbstractJavaTypeMapper.DEFAULT_CONTENT_CLASSID_FIELD_NAME,Person<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
                        <span class="hljs-comment">//返回消息实例</span>
                        <span class="hljs-keyword">return</span> message;
                    &#125;</code></pre></div>

<p>3、保证消息能够被准确消费、不重复消费，RabbitMQ提供了“消息确认机制”，只有当消息被确认消费后，消息才会从队列中被移除。</p>
<div class="hljs"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">enum</span> AcknowledgeMode &#123;
    NONE,
    MANUAL,
    AUTO;

    <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-title">AcknowledgeMode</span><span class="hljs-params">()</span> </span>&#123;
    &#125;

    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">boolean</span> <span class="hljs-title">isTransactionAllowed</span><span class="hljs-params">()</span> </span>&#123;
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span> == AUTO || <span class="hljs-keyword">this</span> == MANUAL;
    &#125;

    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">boolean</span> <span class="hljs-title">isAutoAck</span><span class="hljs-params">()</span> </span>&#123;
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span> == NONE;
    &#125;

    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">boolean</span> <span class="hljs-title">isManual</span><span class="hljs-params">()</span> </span>&#123;
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span> == MANUAL;
    &#125;
&#125;</code></pre></div>

<h3 id="5-4-2-常见的确认消费模式介绍"><a href="#5-4-2-常见的确认消费模式介绍" class="headerlink" title="5.4.2 常见的确认消费模式介绍"></a>5.4.2 常见的确认消费模式介绍</h3><p>三种模式：NONE、AUTO、MANUAL</p>
<p>NONE：无需确认，即生产者将消息发送至队列，消费者监听到该消息时，无需发送任何反馈信息给RabbitMQ服务器。</p>
<p>AUTO：自动确认，即生产者将消息发送至队列，消费者监听到该消息时，需要发送一个AUTO ACK的反馈信息给RabbitMQ服务器，之后该消息将在RabbitMQ的队列中被移除。</p>
<p>MANUAL：人为手动确认消费，即生产者将消息发送至队列，消费者监听到该消息时需要手动地“以代码的形式”发送一个ACK的反馈信息给RabbitMQ服务器，之后该消息将在RabbitMQ的队列中被移除，同时告知生产者，消息已经成功发送并且成功被消费者监听消费了。</p>
<h3 id="5-4-3-基于自动确认消费模式实战"><a href="#5-4-3-基于自动确认消费模式实战" class="headerlink" title="5.4.3 基于自动确认消费模式实战"></a>5.4.3 基于自动确认消费模式实战</h3><p>1、KnowledgeInfo类充当“消息”进行传输</p>
<div class="hljs"><pre><code class="hljs java"><span class="hljs-meta">@Data</span>
<span class="hljs-meta">@ToString</span>
<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">KnowledeInfo</span> </span>&#123;
    <span class="hljs-keyword">private</span> Integer id;
    <span class="hljs-keyword">private</span> String mode;
    <span class="hljs-keyword">private</span> String code;
&#125;</code></pre></div>

<p>2、在RabbitmqConfig配置类中创建相应的队列，交换机，路由及其绑定，同时再创建一个基于自动确认消费模式的“监听器容器工厂实例”，目的是用于指定特定的队列对应的消费者采用“自动确认消费”的模式。</p>
<div class="hljs"><pre><code class="hljs java"><span class="hljs-comment">/**单一消费者-确认模式为AUTO*/</span>
  <span class="hljs-meta">@Bean</span>(name = <span class="hljs-string">"singleListenerContainerAuto"</span>)
  <span class="hljs-function"><span class="hljs-keyword">public</span> SimpleRabbitListenerContainerFactory <span class="hljs-title">listenerContainerAuto</span><span class="hljs-params">()</span></span>&#123;
      <span class="hljs-comment">//创建消息监听器所在的容器工厂实例</span>
      SimpleRabbitListenerContainerFactory factory = <span class="hljs-keyword">new</span> SimpleRabbitListenerContainerFactory();
      <span class="hljs-comment">//容器工厂实例设置链接工厂</span>
      factory.setConnectionFactory(connectionFactory);
      <span class="hljs-comment">//设置消息在传输中的格式</span>
      factory.setMessageConverter(<span class="hljs-keyword">new</span> Jackson2JsonMessageConverter());
      <span class="hljs-comment">//设置消费者并发实例，在这里采用单一的模式</span>
      factory.setConcurrentConsumers(<span class="hljs-number">1</span>);
      <span class="hljs-comment">//设置消费者并发最大数量的实例</span>
      factory.setMaxConcurrentConsumers(<span class="hljs-number">1</span>);
      <span class="hljs-comment">//设置消费者每个并发的实例预拉取的消息数据量</span>
      factory.setPrefetchCount(<span class="hljs-number">1</span>);
      <span class="hljs-comment">//设置确认消费模式为自动确认消费AUTO</span>
      factory.setAcknowledgeMode(AcknowledgeMode.AUTO);
      <span class="hljs-comment">//返回监听器容器工厂实例</span>
      <span class="hljs-keyword">return</span> factory;
  &#125;
  <span class="hljs-comment">/**创建队列*/</span>
  <span class="hljs-meta">@Bean</span>
  <span class="hljs-function"><span class="hljs-keyword">public</span> Queue <span class="hljs-title">autoQueue</span><span class="hljs-params">()</span></span>&#123;
      <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> Queue(env.getProperty(<span class="hljs-string">"mq.auto.knowledge.queue.name"</span>),<span class="hljs-keyword">true</span>);
  &#125;
  <span class="hljs-comment">/**创建交换机*/</span>
  <span class="hljs-meta">@Bean</span>
  <span class="hljs-function"><span class="hljs-keyword">public</span> DirectExchange <span class="hljs-title">autoExchange</span><span class="hljs-params">()</span></span>&#123;
      <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> DirectExchange(env.getProperty(<span class="hljs-string">"mq.auto.knowledge.exchange.name"</span>),<span class="hljs-keyword">true</span>,<span class="hljs-keyword">false</span>);
  &#125;
  <span class="hljs-comment">/**创建绑定*/</span>
  <span class="hljs-meta">@Bean</span>
  <span class="hljs-function"><span class="hljs-keyword">public</span> Binding <span class="hljs-title">autoBinding</span><span class="hljs-params">()</span></span>&#123;
      <span class="hljs-keyword">return</span> BindingBuilder.bind(autoQueue()).to(autoExchange())
              .with(env.getProperty(<span class="hljs-string">"mq.auto.knowledge.routing.ken.name"</span>));
  &#125;</code></pre></div>

<p>相关配置文件中的变量：</p>
<div class="hljs"><pre><code class="hljs properties"><span class="hljs-comment">#确认消费模式为自动确认机制</span>
<span class="hljs-meta">mq.auto.knowledge.queue.name</span>=<span class="hljs-string">$&#123;mq.env&#125;.middleware.auto.knowledge.queue</span>
<span class="hljs-meta">mq.auto.knowledge.exchange.name</span>=<span class="hljs-string">$&#123;mq.env&#125;.middleware.auto.knowledge.exchange</span>
<span class="hljs-meta">mq.auto.knowledge.routing.ken.name</span>=<span class="hljs-string">$&#123;mq.env&#125;.middleware.auto.knowledge.routing.key</span></code></pre></div>

<p>3、生产者</p>
<div class="hljs"><pre><code class="hljs java"><span class="hljs-meta">@Component</span>
<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">KnowledgePublisher</span> </span>&#123;
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> Logger log = LoggerFactory.getLogger(KnowledgePublisher<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
    <span class="hljs-comment">/**定义JSON序列化和反序列化组件实例*/</span>
    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> ObjectMapper objectMapper;
    <span class="hljs-comment">/**定义读取环境变量的实例*/</span>
    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> Environment env;
    <span class="hljs-comment">/**定义RabbitMQ操作组件实例*/</span>
    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> RabbitTemplate rabbitTemplate;
    <span class="hljs-comment">/**</span>
<span class="hljs-comment">     * 基于AUTO机制-生产者发送消息</span>
<span class="hljs-comment">     */</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">sendAutoMsg</span><span class="hljs-params">(KnowledgeInfo info)</span></span>&#123;
        <span class="hljs-keyword">try</span> &#123;
            <span class="hljs-keyword">if</span>(info != <span class="hljs-keyword">null</span>)&#123;
                <span class="hljs-comment">//设置消息的传输格式</span>
                rabbitTemplate.setMessageConverter(<span class="hljs-keyword">new</span> Jackson2JsonMessageConverter());
                <span class="hljs-comment">//设置交换机</span>
                rabbitTemplate.setExchange(env.getProperty(<span class="hljs-string">"mq.auto.knowledge.exchange.name"</span>));
                <span class="hljs-comment">//设置路由</span>
                rabbitTemplate.setRoutingKey(env.getProperty(<span class="hljs-string">"mq.auto.knowledge.routing.key.name"</span>));
                <span class="hljs-comment">//创建消息，并对消息进行持久化策略设置</span>
                Message message = MessageBuilder
                        .withBody(objectMapper.writeValueAsBytes(info))
                        .setDeliveryMode(MessageDeliveryMode.PERSISTENT)
                        .build();
                <span class="hljs-comment">//发送消息</span>
                rabbitTemplate.convertAndSend(message);
                log.info(<span class="hljs-string">"基于AUTO机制-生产者发送消息-内容为：&#123;&#125;"</span>,info);
            &#125;
        &#125;<span class="hljs-keyword">catch</span> (Exception e)&#123;
            log.error(<span class="hljs-string">"基于AUTO机制-生产者发送消息-发生异常：&#123;&#125;"</span>,info,e.fillInStackTrace());
        &#125;
    &#125;
&#125;</code></pre></div>

<p>4、开发用于监听消费消息的消费者：</p>
<div class="hljs"><pre><code class="hljs java"><span class="hljs-meta">@Component</span>
<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">KnowledgeConsumer</span> </span>&#123;
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> Logger log = LoggerFactory.getLogger(KnowledgeConsumer<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> ObjectMapper objectMapper;
    <span class="hljs-meta">@RabbitListener</span>(queues = <span class="hljs-string">"$&#123;mq.auto.knowledge.queue.name&#125;"</span>,containerFactory = <span class="hljs-string">"singleListenerContainerAuto"</span>)
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">consumeAutoMsg</span><span class="hljs-params">(@Payload <span class="hljs-keyword">byte</span>[] msg)</span></span>&#123;
        <span class="hljs-keyword">try</span> &#123;
            <span class="hljs-comment">//监听消费解析消息体</span>
            KnowledgeInfo info = objectMapper.readValue(msg, KnowledgeInfo<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
            log.info(<span class="hljs-string">"基于AUTO的确认消费模式-消费者监听消费信息-内容为：&#123;&#125;"</span>,info);
        &#125;<span class="hljs-keyword">catch</span> (Exception e)&#123;
            log.error(<span class="hljs-string">"基于AUTO的确认消费模式-消费者监听消费消息-发生异常："</span>,e.fillInStackTrace());
        &#125;
    &#125;
&#125;</code></pre></div>

<p>5、测试方法</p>
<div class="hljs"><pre><code class="hljs java"><span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">public</span> KnowledgePublisher knowledgePublisher;
    <span class="hljs-meta">@Test</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">test6</span><span class="hljs-params">()</span></span>&#123;
        KnowledgeInfo info = <span class="hljs-keyword">new</span> KnowledgeInfo();
        info.setId(<span class="hljs-number">10010</span>);
        info.setCode(<span class="hljs-string">"auto"</span>);
        info.setMode(<span class="hljs-string">"基于AUTO的消息确认消费模式"</span>);
        knowledgePublisher.sendAutoMsg(info);
    &#125;</code></pre></div>

<h3 id="5-4-4-基于手动确认消费模式实战"><a href="#5-4-4-基于手动确认消费模式实战" class="headerlink" title="5.4.4 基于手动确认消费模式实战"></a>5.4.4 基于手动确认消费模式实战</h3><p>1、在RabbitmqConfig配置类中创建相关组件，并创建“基于MANUAL手动确认消费模式”对应的消费者所在的监听器容器工厂实例。</p>
<div class="hljs"><pre><code class="hljs java"><span class="hljs-comment">/**</span>
<span class="hljs-comment">     * 单一消费者-确认模式为MANUAL</span>
<span class="hljs-comment">     */</span>
    <span class="hljs-meta">@Bean</span>(name = <span class="hljs-string">"manualQueue"</span>)
    <span class="hljs-function"><span class="hljs-keyword">public</span> Queue <span class="hljs-title">manualQueue</span><span class="hljs-params">()</span></span>&#123;
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> Queue(env.getProperty(<span class="hljs-string">"mq.manual.knowledge.queue.name"</span>),<span class="hljs-keyword">true</span>);
    &#125;
    <span class="hljs-meta">@Bean</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> TopicExchange <span class="hljs-title">manualExchange</span><span class="hljs-params">()</span></span>&#123;
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> TopicExchange(env.getProperty(<span class="hljs-string">"mq.manual.knowledge.exchange.name"</span>),<span class="hljs-keyword">true</span>,<span class="hljs-keyword">false</span>);
    &#125;
    <span class="hljs-meta">@Bean</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> Binding <span class="hljs-title">manualBinding</span><span class="hljs-params">()</span></span>&#123;
        <span class="hljs-keyword">return</span> BindingBuilder.bind(manualQueue()).to(manualExchange())
                .with(env.getProperty(<span class="hljs-string">"mq.manual.knowledge.routing.key.name"</span>));
    &#125;
    <span class="hljs-comment">/**定义手动确认消费模式对应的消费者监听器实例*/</span>
    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> KnowledgeManualConsumer knowledgeManualConsumer;
    <span class="hljs-comment">/**</span>
<span class="hljs-comment">     * 创建消费者监听器容器工厂实例-确认模式为MANUAL，并指定监听的队列和消费者</span>
<span class="hljs-comment">     */</span>
    <span class="hljs-meta">@Bean</span>(name = <span class="hljs-string">"simpleContainerManual"</span>)
    <span class="hljs-function"><span class="hljs-keyword">public</span> SimpleMessageListenerContainer <span class="hljs-title">simpleMessageListenerContainer</span><span class="hljs-params">(</span></span>
<span class="hljs-function"><span class="hljs-params">            @Qualifier(<span class="hljs-string">"manualQueue"</span>)</span> Queue manualQueue)</span>&#123;
        <span class="hljs-comment">//创建消息监听器容器实例</span>
        SimpleMessageListenerContainer container = <span class="hljs-keyword">new</span> SimpleMessageListenerContainer();
        <span class="hljs-comment">//设置链接工厂</span>
        container.setConnectionFactory(connectionFactory);
        <span class="hljs-comment">//设置消息的传输格式-JSON</span>
        container.setMessageConverter(<span class="hljs-keyword">new</span> Jackson2JsonMessageConverter());
        <span class="hljs-comment">//单一消费者实例配置</span>
        container.setConcurrentConsumers(<span class="hljs-number">1</span>);
        container.setMaxConcurrentConsumers(<span class="hljs-number">1</span>);
        container.setPrefetchCount(<span class="hljs-number">1</span>);
        <span class="hljs-comment">//设置消息的确认模式，采用手动确认消费机制</span>
        container.setAcknowledgeMode(AcknowledgeMode.MANUAL);
        container.setQueues(manualQueue);
        <span class="hljs-comment">//指定该容器中消息监听器，即消费者</span>
        container.setMessageListener(knowledgeManualConsumer);
        <span class="hljs-comment">//返回容器工厂实例</span>
        <span class="hljs-keyword">return</span> container;
    &#125;</code></pre></div>

<div class="hljs"><pre><code class="hljs properties"><span class="hljs-comment">#确认消费模式为手动确认机制</span>
<span class="hljs-meta">mq.manual.knowledge.queue.name</span>=<span class="hljs-string">$&#123;mq.env&#125;.middleware.manual.knowledge.queue</span>
<span class="hljs-meta">mq.manual.knowledge.exchange.name</span>=<span class="hljs-string">$&#123;mq.env&#125;.middleware.manual.knowledge.exchange</span>
<span class="hljs-meta">mq.manual.knowledge.routing.key.name</span>=<span class="hljs-string">$&#123;mq.env&#125;.middleware.manual.knowledge.routing.key</span></code></pre></div>

<p>2、消费者，需要实现“RabbitMQ通道确认消息监听器“，即ChannelAwareMessageListener接口，并实现onMessage()方法。</p>
<div class="hljs"><pre><code class="hljs java"><span class="hljs-meta">@Component</span>(<span class="hljs-string">"knowledgeManualConsumer"</span>)
<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">KnowledgeManualConsumer</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">ChannelAwareMessageListener</span> </span>&#123;
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> Logger log = LoggerFactory.getLogger(KnowledgeManualConsumer<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> ObjectMapper objectMapper;

    <span class="hljs-comment">/**</span>
<span class="hljs-comment">     * 监听消费消息</span>
<span class="hljs-comment">     * <span class="hljs-doctag">@param</span> message 消息实体</span>
<span class="hljs-comment">     * <span class="hljs-doctag">@param</span> channel 通道实例</span>
<span class="hljs-comment">     * <span class="hljs-doctag">@throws</span> Exception</span>
<span class="hljs-comment">     */</span>
    <span class="hljs-meta">@Override</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">onMessage</span><span class="hljs-params">(Message message, Channel channel)</span> <span class="hljs-keyword">throws</span> Exception </span>&#123;
        <span class="hljs-comment">//获取消息属性</span>
        MessageProperties messageProperties = message.getMessageProperties();
        <span class="hljs-comment">//获取消息分发时的全局唯一标识</span>
        <span class="hljs-keyword">long</span> deliveryTag = messageProperties.getDeliveryTag();
        <span class="hljs-keyword">try</span> &#123;
            <span class="hljs-comment">//获得消息体</span>
            <span class="hljs-keyword">byte</span>[] msg = message.getBody();
            <span class="hljs-comment">//解析消息体</span>
            KnowledgeInfo info = objectMapper.readValue(msg, KnowledgeInfo<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
            log.info(<span class="hljs-string">"确认消费模式-人为手动确认消费-监听器监听消费消息-内容为：&#123;&#125;"</span>,info);
            <span class="hljs-comment">//执行完业务逻辑后，手动进行确认消费，其中第一个参数为：消息的分发标识；第二个参数；是否允许批量确认消费</span>
            channel.basicAck(deliveryTag,<span class="hljs-keyword">true</span>);
        &#125;<span class="hljs-keyword">catch</span> (Exception e)&#123;
            log.info(<span class="hljs-string">"确认消费模式-人为手动确认消费-监听器监听消费消息-发生异常："</span>,e.fillInStackTrace());
            <span class="hljs-comment">//如果在处理消息的过程中发生了异常，则依旧需要人为手动确认消费掉该消息，</span>
            <span class="hljs-comment">// 否则该消息将一直留在队列中，从而导致消息的重复消费</span>
            channel.basicReject(deliveryTag,<span class="hljs-keyword">false</span>);
        &#125;
    &#125;
&#125;</code></pre></div>

<p>3、生产者</p>
<div class="hljs"><pre><code class="hljs java"><span class="hljs-meta">@Component</span>
<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">KnowLedgeManualPublisher</span> </span>&#123;
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> Logger log = LoggerFactory.getLogger(KnowLedgeManualPublisher<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> ObjectMapper objectMapper;
    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> Environment env;
    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> RabbitTemplate rabbitTemplate;

    <span class="hljs-comment">/**</span>
<span class="hljs-comment">     * 基于MANUAL机制-生产者发送消费</span>
<span class="hljs-comment">     * <span class="hljs-doctag">@param</span> info</span>
<span class="hljs-comment">     */</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">sendAutoMsg</span><span class="hljs-params">(KnowledgeInfo info)</span></span>&#123;
        <span class="hljs-keyword">try</span> &#123;
            <span class="hljs-keyword">if</span>(info != <span class="hljs-keyword">null</span>)&#123;
                rabbitTemplate.setMessageConverter(<span class="hljs-keyword">new</span> Jackson2JsonMessageConverter());
                rabbitTemplate.setExchange(env.getProperty(<span class="hljs-string">"mq.manual.knowledge.exchange.name"</span>));
                rabbitTemplate.setRoutingKey(env.getProperty(<span class="hljs-string">"mq.manual.knowledge.routing.key.name"</span>));
                <span class="hljs-comment">//创建消息</span>
                Message message = MessageBuilder.withBody(objectMapper.writeValueAsBytes(info))
                        .setDeliveryMode(MessageDeliveryMode.PERSISTENT)
                        .build();
                rabbitTemplate.convertAndSend(message);
                log.info(<span class="hljs-string">"基于MANUAL机制-生产者发送消息-内容为：&#123;&#125;"</span>,info);
            &#125;
        &#125;<span class="hljs-keyword">catch</span> (Exception e)&#123;
            log.error(<span class="hljs-string">"基于MANUAL机制-生产者发送消息-发生异常：&#123;&#125;"</span>,info,e.fillInStackTrace());
        &#125;
    &#125;</code></pre></div>

<p>4、测试方法</p>
<div class="hljs"><pre><code class="hljs java"><span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> KnowLedgeManualPublisher knowLedgeManualPublisher;
    <span class="hljs-meta">@Test</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">test7</span><span class="hljs-params">()</span></span>&#123;
        KnowledgeInfo info = <span class="hljs-keyword">new</span> KnowledgeInfo();
        info.setId(<span class="hljs-number">10011</span>);
        info.setCode(<span class="hljs-string">"manual"</span>);
        info.setMode(<span class="hljs-string">"基于MANUAL的消息确认消费模式"</span>);
        knowLedgeManualPublisher.sendAutoMsg(info);
    &#125;</code></pre></div>

<h2 id="5-5-典型应用场景实战之用户登录成功写日志"><a href="#5-5-典型应用场景实战之用户登录成功写日志" class="headerlink" title="5.5 典型应用场景实战之用户登录成功写日志"></a>5.5 典型应用场景实战之用户登录成功写日志</h2><h3 id="5-5-1-需求分析"><a href="#5-5-1-需求分析" class="headerlink" title="5.5.1 需求分析"></a>5.5.1 需求分析</h3><p>将每次用户登录成功之后的登录信息记入数据库，以便用于相关的日志分析</p>
<p>整体业务流程包含“登录模块”和“日志记录模块”。</p>
<h3 id="5-5-2-数据库表设计"><a href="#5-5-2-数据库表设计" class="headerlink" title="5.5.2 数据库表设计"></a>5.5.2 数据库表设计</h3><p>1、进行用户信息表的设计，主要包含用户id，用户名和登录密码等字段。</p>
<div class="hljs"><pre><code class="hljs sql"><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> <span class="hljs-string">`user`</span>(
  <span class="hljs-string">`id`</span> <span class="hljs-built_in">int</span>(<span class="hljs-number">11</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span> AUTO_INCREMENT <span class="hljs-keyword">COMMENT</span> <span class="hljs-string">'用户id'</span>,
  <span class="hljs-string">`user_name`</span> <span class="hljs-built_in">varchar</span>(<span class="hljs-number">255</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span> <span class="hljs-keyword">COMMENT</span> <span class="hljs-string">'用户名'</span>,
  <span class="hljs-string">`password`</span> <span class="hljs-built_in">varchar</span>(<span class="hljs-number">255</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span> <span class="hljs-keyword">COMMENT</span> <span class="hljs-string">'密码'</span>,
  <span class="hljs-string">`create_time`</span> datetime <span class="hljs-keyword">DEFAULT</span> <span class="hljs-literal">NULL</span> <span class="hljs-keyword">COMMENT</span> <span class="hljs-string">'创建时间'</span>,
  PRIMARY <span class="hljs-keyword">KEY</span> (<span class="hljs-string">`id`</span>),
  <span class="hljs-keyword">UNIQUE</span> <span class="hljs-keyword">KEY</span> <span class="hljs-string">`idx_user_name`</span> (<span class="hljs-string">`user_name`</span>) <span class="hljs-keyword">USING</span> BTREE 
)<span class="hljs-keyword">ENGINE</span>=<span class="hljs-keyword">InnoDB</span> AUTO_INCREMENT=<span class="hljs-number">4</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">CHARSET</span> = utf8 <span class="hljs-keyword">COMMENT</span> = <span class="hljs-string">'用户信息表'</span>;</code></pre></div>

<p>2、日志记录表</p>
<div class="hljs"><pre><code class="hljs java">CREATE TABLE `sys_log`(
  `id` <span class="hljs-keyword">int</span>(<span class="hljs-number">11</span>) NOT NULL AUTO_INCREMENT,
  `user_id` <span class="hljs-keyword">int</span>(<span class="hljs-number">11</span>) DEFAULT <span class="hljs-string">'0'</span> COMMENT <span class="hljs-string">'用户id'</span>,
  `<span class="hljs-keyword">module</span>` varchar(<span class="hljs-number">255</span>) DEFAULT NULL COMMENT <span class="hljs-string">'所属操作模块'</span>,
  `data` varchar(<span class="hljs-number">5000</span>) CHARACTER SET utf8mb4 DEFAULT NULL COMMENT <span class="hljs-string">'操作数据'</span>,
  `memo` varchar(<span class="hljs-number">5000</span>) CHARACTER SET  utf8mb4 DEFAULT NULL COMMENT <span class="hljs-string">'备注'</span>,
  `create_time` datetime DEFAULT NULL COMMENT <span class="hljs-string">'创建时间'</span>,
  <span class="hljs-function">PRIMARY <span class="hljs-title">KEY</span> <span class="hljs-params">(`id`)</span></span>
<span class="hljs-function">)ENGINE</span>=InnoDB AUTO_INCREMENT=<span class="hljs-number">4</span> DEFAULT CHARSET = utf8 COMMENT = <span class="hljs-string">'日志记录表'</span>;</code></pre></div>

<p>3、对应的实体类，Mapper操作接口以及Mapper.xml</p>
<p>User类：</p>
<div class="hljs"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">User</span> </span>&#123;
    <span class="hljs-keyword">private</span> Integer id;

    <span class="hljs-keyword">private</span> String userName;

    <span class="hljs-keyword">private</span> String password;

    <span class="hljs-keyword">private</span> Date createTime;

    <span class="hljs-function"><span class="hljs-keyword">public</span> Integer <span class="hljs-title">getId</span><span class="hljs-params">()</span> </span>&#123;
        <span class="hljs-keyword">return</span> id;
    &#125;

    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setId</span><span class="hljs-params">(Integer id)</span> </span>&#123;
        <span class="hljs-keyword">this</span>.id = id;
    &#125;

    <span class="hljs-function"><span class="hljs-keyword">public</span> String <span class="hljs-title">getUserName</span><span class="hljs-params">()</span> </span>&#123;
        <span class="hljs-keyword">return</span> userName;
    &#125;

    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setUserName</span><span class="hljs-params">(String userName)</span> </span>&#123;
        <span class="hljs-keyword">this</span>.userName = userName == <span class="hljs-keyword">null</span> ? <span class="hljs-keyword">null</span> : userName.trim();
    &#125;

    <span class="hljs-function"><span class="hljs-keyword">public</span> String <span class="hljs-title">getPassword</span><span class="hljs-params">()</span> </span>&#123;
        <span class="hljs-keyword">return</span> password;
    &#125;

    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setPassword</span><span class="hljs-params">(String password)</span> </span>&#123;
        <span class="hljs-keyword">this</span>.password = password == <span class="hljs-keyword">null</span> ? <span class="hljs-keyword">null</span> : password.trim();
    &#125;

    <span class="hljs-function"><span class="hljs-keyword">public</span> Date <span class="hljs-title">getCreateTime</span><span class="hljs-params">()</span> </span>&#123;
        <span class="hljs-keyword">return</span> createTime;
    &#125;

    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setCreateTime</span><span class="hljs-params">(Date createTime)</span> </span>&#123;
        <span class="hljs-keyword">this</span>.createTime = createTime;
    &#125;
&#125;</code></pre></div>

<p>SysLog类</p>
<div class="hljs"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">SysLog</span> </span>&#123;
    <span class="hljs-keyword">private</span> Integer id;

    <span class="hljs-keyword">private</span> Integer userId;

    <span class="hljs-keyword">private</span> String <span class="hljs-keyword">module</span>;

    <span class="hljs-keyword">private</span> String data;

    <span class="hljs-keyword">private</span> String memo;

    <span class="hljs-keyword">private</span> Date createTime;

    <span class="hljs-function"><span class="hljs-keyword">public</span> Integer <span class="hljs-title">getId</span><span class="hljs-params">()</span> </span>&#123;
        <span class="hljs-keyword">return</span> id;
    &#125;

    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setId</span><span class="hljs-params">(Integer id)</span> </span>&#123;
        <span class="hljs-keyword">this</span>.id = id;
    &#125;

    <span class="hljs-function"><span class="hljs-keyword">public</span> Integer <span class="hljs-title">getUserId</span><span class="hljs-params">()</span> </span>&#123;
        <span class="hljs-keyword">return</span> userId;
    &#125;

    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setUserId</span><span class="hljs-params">(Integer userId)</span> </span>&#123;
        <span class="hljs-keyword">this</span>.userId = userId;
    &#125;

    <span class="hljs-function"><span class="hljs-keyword">public</span> String <span class="hljs-title">getModule</span><span class="hljs-params">()</span> </span>&#123;
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">module</span>;
    &#125;

    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setModule</span><span class="hljs-params">(String <span class="hljs-keyword">module</span>)</span> </span>&#123;
        <span class="hljs-keyword">this</span>.<span class="hljs-keyword">module</span> = <span class="hljs-keyword">module</span> == <span class="hljs-keyword">null</span> ? <span class="hljs-keyword">null</span> : <span class="hljs-keyword">module</span>.trim();
    &#125;

    <span class="hljs-function"><span class="hljs-keyword">public</span> String <span class="hljs-title">getData</span><span class="hljs-params">()</span> </span>&#123;
        <span class="hljs-keyword">return</span> data;
    &#125;

    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setData</span><span class="hljs-params">(String data)</span> </span>&#123;
        <span class="hljs-keyword">this</span>.data = data == <span class="hljs-keyword">null</span> ? <span class="hljs-keyword">null</span> : data.trim();
    &#125;

    <span class="hljs-function"><span class="hljs-keyword">public</span> String <span class="hljs-title">getMemo</span><span class="hljs-params">()</span> </span>&#123;
        <span class="hljs-keyword">return</span> memo;
    &#125;

    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setMemo</span><span class="hljs-params">(String memo)</span> </span>&#123;
        <span class="hljs-keyword">this</span>.memo = memo == <span class="hljs-keyword">null</span> ? <span class="hljs-keyword">null</span> : memo.trim();
    &#125;

    <span class="hljs-function"><span class="hljs-keyword">public</span> Date <span class="hljs-title">getCreateTime</span><span class="hljs-params">()</span> </span>&#123;
        <span class="hljs-keyword">return</span> createTime;
    &#125;

    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setCreateTime</span><span class="hljs-params">(Date createTime)</span> </span>&#123;
        <span class="hljs-keyword">this</span>.createTime = createTime;
    &#125;
&#125;</code></pre></div>

<p>User类对应的Mapper接口：</p>
<div class="hljs"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">interface</span> <span class="hljs-title">UserMapper</span> </span>&#123;
    <span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">deleteByPrimaryKey</span><span class="hljs-params">(Integer id)</span></span>;

    <span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">insert</span><span class="hljs-params">(User record)</span></span>;

    <span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">insertSelective</span><span class="hljs-params">(User record)</span></span>;

    <span class="hljs-function">User <span class="hljs-title">selectByPrimaryKey</span><span class="hljs-params">(Integer id)</span></span>;

    <span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">updateByPrimaryKeySelective</span><span class="hljs-params">(User record)</span></span>;

    <span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">updateByPrimaryKey</span><span class="hljs-params">(User record)</span></span>;

    <span class="hljs-function">User <span class="hljs-title">selectByUserNamePassword</span><span class="hljs-params">(@Param(<span class="hljs-string">"userName"</span>)</span> String userName, @<span class="hljs-title">Param</span><span class="hljs-params">(<span class="hljs-string">"password"</span>)</span> String password)</span>;
&#125;</code></pre></div>

<p>UserMapper.xml：</p>
<div class="hljs"><pre><code class="hljs xml"><span class="hljs-meta">&lt;?xml version="1.0" encoding="UTF-8" ?&gt;</span>
<span class="hljs-meta">&lt;!DOCTYPE <span class="hljs-meta-keyword">mapper</span> <span class="hljs-meta-keyword">PUBLIC</span> <span class="hljs-meta-string">"-//mybatis.org//DTD Mapper 3.0//EN"</span> <span class="hljs-meta-string">"http://mybatis.org/dtd/mybatis-3-mapper.dtd"</span> &gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">mapper</span> <span class="hljs-attr">namespace</span>=<span class="hljs-string">"com.debug.middleware.model.mapper.UserMapper"</span> &gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">resultMap</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"BaseResultMap"</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"com.debug.middleware.model.entity.User"</span> &gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">id</span> <span class="hljs-attr">column</span>=<span class="hljs-string">"id"</span> <span class="hljs-attr">property</span>=<span class="hljs-string">"id"</span> <span class="hljs-attr">jdbcType</span>=<span class="hljs-string">"INTEGER"</span> /&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">result</span> <span class="hljs-attr">column</span>=<span class="hljs-string">"user_name"</span> <span class="hljs-attr">property</span>=<span class="hljs-string">"userName"</span> <span class="hljs-attr">jdbcType</span>=<span class="hljs-string">"VARCHAR"</span> /&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">result</span> <span class="hljs-attr">column</span>=<span class="hljs-string">"password"</span> <span class="hljs-attr">property</span>=<span class="hljs-string">"password"</span> <span class="hljs-attr">jdbcType</span>=<span class="hljs-string">"VARCHAR"</span> /&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">result</span> <span class="hljs-attr">column</span>=<span class="hljs-string">"create_time"</span> <span class="hljs-attr">property</span>=<span class="hljs-string">"createTime"</span> <span class="hljs-attr">jdbcType</span>=<span class="hljs-string">"TIMESTAMP"</span> /&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">resultMap</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">sql</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"Base_Column_List"</span> &gt;</span>
        id, user_name, password, create_time
    <span class="hljs-tag">&lt;/<span class="hljs-name">sql</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">select</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"selectByPrimaryKey"</span> <span class="hljs-attr">resultMap</span>=<span class="hljs-string">"BaseResultMap"</span> <span class="hljs-attr">parameterType</span>=<span class="hljs-string">"java.lang.Integer"</span> &gt;</span>
        select
        <span class="hljs-tag">&lt;<span class="hljs-name">include</span> <span class="hljs-attr">refid</span>=<span class="hljs-string">"Base_Column_List"</span> /&gt;</span>
        from user
        where id = #&#123;id,jdbcType=INTEGER&#125;
    <span class="hljs-tag">&lt;/<span class="hljs-name">select</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">delete</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"deleteByPrimaryKey"</span> <span class="hljs-attr">parameterType</span>=<span class="hljs-string">"java.lang.Integer"</span> &gt;</span>
        delete from user
        where id = #&#123;id,jdbcType=INTEGER&#125;
    <span class="hljs-tag">&lt;/<span class="hljs-name">delete</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">insert</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"insert"</span> <span class="hljs-attr">parameterType</span>=<span class="hljs-string">"com.debug.middleware.model.entity.User"</span> &gt;</span>
        insert into user (id, user_name, password,
                          create_time)
        values (#&#123;id,jdbcType=INTEGER&#125;, #&#123;userName,jdbcType=VARCHAR&#125;, #&#123;password,jdbcType=VARCHAR&#125;,
                #&#123;createTime,jdbcType=TIMESTAMP&#125;)
    <span class="hljs-tag">&lt;/<span class="hljs-name">insert</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">insert</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"insertSelective"</span> <span class="hljs-attr">parameterType</span>=<span class="hljs-string">"com.debug.middleware.model.entity.User"</span> &gt;</span>
        insert into user
        <span class="hljs-tag">&lt;<span class="hljs-name">trim</span> <span class="hljs-attr">prefix</span>=<span class="hljs-string">"("</span> <span class="hljs-attr">suffix</span>=<span class="hljs-string">")"</span> <span class="hljs-attr">suffixOverrides</span>=<span class="hljs-string">","</span> &gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">if</span> <span class="hljs-attr">test</span>=<span class="hljs-string">"id != null"</span> &gt;</span>
                id,
            <span class="hljs-tag">&lt;/<span class="hljs-name">if</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">if</span> <span class="hljs-attr">test</span>=<span class="hljs-string">"userName != null"</span> &gt;</span>
                user_name,
            <span class="hljs-tag">&lt;/<span class="hljs-name">if</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">if</span> <span class="hljs-attr">test</span>=<span class="hljs-string">"password != null"</span> &gt;</span>
                password,
            <span class="hljs-tag">&lt;/<span class="hljs-name">if</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">if</span> <span class="hljs-attr">test</span>=<span class="hljs-string">"createTime != null"</span> &gt;</span>
                create_time,
            <span class="hljs-tag">&lt;/<span class="hljs-name">if</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">trim</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">trim</span> <span class="hljs-attr">prefix</span>=<span class="hljs-string">"values ("</span> <span class="hljs-attr">suffix</span>=<span class="hljs-string">")"</span> <span class="hljs-attr">suffixOverrides</span>=<span class="hljs-string">","</span> &gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">if</span> <span class="hljs-attr">test</span>=<span class="hljs-string">"id != null"</span> &gt;</span>
                #&#123;id,jdbcType=INTEGER&#125;,
            <span class="hljs-tag">&lt;/<span class="hljs-name">if</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">if</span> <span class="hljs-attr">test</span>=<span class="hljs-string">"userName != null"</span> &gt;</span>
                #&#123;userName,jdbcType=VARCHAR&#125;,
            <span class="hljs-tag">&lt;/<span class="hljs-name">if</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">if</span> <span class="hljs-attr">test</span>=<span class="hljs-string">"password != null"</span> &gt;</span>
                #&#123;password,jdbcType=VARCHAR&#125;,
            <span class="hljs-tag">&lt;/<span class="hljs-name">if</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">if</span> <span class="hljs-attr">test</span>=<span class="hljs-string">"createTime != null"</span> &gt;</span>
                #&#123;createTime,jdbcType=TIMESTAMP&#125;,
            <span class="hljs-tag">&lt;/<span class="hljs-name">if</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">trim</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">insert</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">update</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"updateByPrimaryKeySelective"</span> <span class="hljs-attr">parameterType</span>=<span class="hljs-string">"com.debug.middleware.model.entity.User"</span> &gt;</span>
        update user
        <span class="hljs-tag">&lt;<span class="hljs-name">set</span> &gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">if</span> <span class="hljs-attr">test</span>=<span class="hljs-string">"userName != null"</span> &gt;</span>
                user_name = #&#123;userName,jdbcType=VARCHAR&#125;,
            <span class="hljs-tag">&lt;/<span class="hljs-name">if</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">if</span> <span class="hljs-attr">test</span>=<span class="hljs-string">"password != null"</span> &gt;</span>
                password = #&#123;password,jdbcType=VARCHAR&#125;,
            <span class="hljs-tag">&lt;/<span class="hljs-name">if</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">if</span> <span class="hljs-attr">test</span>=<span class="hljs-string">"createTime != null"</span> &gt;</span>
                create_time = #&#123;createTime,jdbcType=TIMESTAMP&#125;,
            <span class="hljs-tag">&lt;/<span class="hljs-name">if</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">set</span>&gt;</span>
        where id = #&#123;id,jdbcType=INTEGER&#125;
    <span class="hljs-tag">&lt;/<span class="hljs-name">update</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">update</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"updateByPrimaryKey"</span> <span class="hljs-attr">parameterType</span>=<span class="hljs-string">"com.debug.middleware.model.entity.User"</span> &gt;</span>
        update user
        set user_name = #&#123;userName,jdbcType=VARCHAR&#125;,
            password = #&#123;password,jdbcType=VARCHAR&#125;,
            create_time = #&#123;createTime,jdbcType=TIMESTAMP&#125;
        where id = #&#123;id,jdbcType=INTEGER&#125;
    <span class="hljs-tag">&lt;/<span class="hljs-name">update</span>&gt;</span>

    <span class="hljs-comment">&lt;!--根据用户名、密码查询--&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">select</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"selectByUserNamePassword"</span> <span class="hljs-attr">resultType</span>=<span class="hljs-string">"com.debug.middleware.model.entity.User"</span>&gt;</span>
        SELECT <span class="hljs-tag">&lt;<span class="hljs-name">include</span> <span class="hljs-attr">refid</span>=<span class="hljs-string">"Base_Column_List"</span>/&gt;</span>
        FROM user WHERE user_name=#&#123;userName&#125; AND password=#&#123;password&#125;
    <span class="hljs-tag">&lt;/<span class="hljs-name">select</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">mapper</span>&gt;</span></code></pre></div>

<p>SysLog对应的Mapper操作接口：</p>
<div class="hljs"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">interface</span> <span class="hljs-title">SysLogMapper</span> </span>&#123;
    <span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">deleteByPrimaryKey</span><span class="hljs-params">(Integer id)</span></span>;

    <span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">insert</span><span class="hljs-params">(SysLog record)</span></span>;

    <span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">insertSelective</span><span class="hljs-params">(SysLog record)</span></span>;

    <span class="hljs-function">SysLog <span class="hljs-title">selectByPrimaryKey</span><span class="hljs-params">(Integer id)</span></span>;

    <span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">updateByPrimaryKeySelective</span><span class="hljs-params">(SysLog record)</span></span>;

    <span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">updateByPrimaryKey</span><span class="hljs-params">(SysLog record)</span></span>;
&#125;</code></pre></div>

<p>SysLogMapper.xml</p>
<div class="hljs"><pre><code class="hljs xml"><span class="hljs-meta">&lt;?xml version="1.0" encoding="UTF-8" ?&gt;</span>
<span class="hljs-comment">&lt;!--xml头部定义--&gt;</span>
<span class="hljs-meta">&lt;!DOCTYPE <span class="hljs-meta-keyword">mapper</span> <span class="hljs-meta-keyword">PUBLIC</span> <span class="hljs-meta-string">"-//mybatis.org//DTD Mapper 3.0//EN"</span> <span class="hljs-meta-string">"http://mybatis.org/dtd/mybatis-3-mapper.dtd"</span> &gt;</span>
<span class="hljs-comment">&lt;!--SysLogMapper操作接口所在的命名空间--&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">mapper</span> <span class="hljs-attr">namespace</span>=<span class="hljs-string">"com.debug.middleware.model.mapper.SysLogMapper"</span> &gt;</span>
    <span class="hljs-comment">&lt;!--查询得到的结果集映射配置--&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">resultMap</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"BaseResultMap"</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"com.debug.middleware.model.entity.SysLog"</span> &gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">id</span> <span class="hljs-attr">column</span>=<span class="hljs-string">"id"</span> <span class="hljs-attr">property</span>=<span class="hljs-string">"id"</span> <span class="hljs-attr">jdbcType</span>=<span class="hljs-string">"INTEGER"</span> /&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">result</span> <span class="hljs-attr">column</span>=<span class="hljs-string">"user_id"</span> <span class="hljs-attr">property</span>=<span class="hljs-string">"userId"</span> <span class="hljs-attr">jdbcType</span>=<span class="hljs-string">"INTEGER"</span> /&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">result</span> <span class="hljs-attr">column</span>=<span class="hljs-string">"module"</span> <span class="hljs-attr">property</span>=<span class="hljs-string">"module"</span> <span class="hljs-attr">jdbcType</span>=<span class="hljs-string">"VARCHAR"</span> /&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">result</span> <span class="hljs-attr">column</span>=<span class="hljs-string">"data"</span> <span class="hljs-attr">property</span>=<span class="hljs-string">"data"</span> <span class="hljs-attr">jdbcType</span>=<span class="hljs-string">"VARCHAR"</span> /&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">result</span> <span class="hljs-attr">column</span>=<span class="hljs-string">"memo"</span> <span class="hljs-attr">property</span>=<span class="hljs-string">"memo"</span> <span class="hljs-attr">jdbcType</span>=<span class="hljs-string">"VARCHAR"</span> /&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">result</span> <span class="hljs-attr">column</span>=<span class="hljs-string">"create_time"</span> <span class="hljs-attr">property</span>=<span class="hljs-string">"createTime"</span> <span class="hljs-attr">jdbcType</span>=<span class="hljs-string">"TIMESTAMP"</span> /&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">resultMap</span>&gt;</span>
    <span class="hljs-comment">&lt;!--定义查询的SQL片段--&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">sql</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"Base_Column_List"</span> &gt;</span>
        id, user_id, module, data, memo, create_time
    <span class="hljs-tag">&lt;/<span class="hljs-name">sql</span>&gt;</span>
    <span class="hljs-comment">&lt;!--根据主键id查询日志记录--&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">select</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"selectByPrimaryKey"</span> <span class="hljs-attr">resultMap</span>=<span class="hljs-string">"BaseResultMap"</span> <span class="hljs-attr">parameterType</span>=<span class="hljs-string">"java.lang.Integer"</span> &gt;</span>
        select
        <span class="hljs-tag">&lt;<span class="hljs-name">include</span> <span class="hljs-attr">refid</span>=<span class="hljs-string">"Base_Column_List"</span> /&gt;</span>
        from sys_log
        where id = #&#123;id,jdbcType=INTEGER&#125;
    <span class="hljs-tag">&lt;/<span class="hljs-name">select</span>&gt;</span>
    <span class="hljs-comment">&lt;!--根据主键id删除日志记录--&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">delete</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"deleteByPrimaryKey"</span> <span class="hljs-attr">parameterType</span>=<span class="hljs-string">"java.lang.Integer"</span> &gt;</span>
        delete from sys_log
        where id = #&#123;id,jdbcType=INTEGER&#125;
    <span class="hljs-tag">&lt;/<span class="hljs-name">delete</span>&gt;</span>
    <span class="hljs-comment">&lt;!--插入日志记录--&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">insert</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"insert"</span> <span class="hljs-attr">parameterType</span>=<span class="hljs-string">"com.debug.middleware.model.entity.SysLog"</span> &gt;</span>
        insert into sys_log (id, user_id, module,
                             data, memo, create_time
                )
        values (#&#123;id,jdbcType=INTEGER&#125;, #&#123;userId,jdbcType=INTEGER&#125;, #&#123;module,jdbcType=VARCHAR&#125;,
                #&#123;data,jdbcType=VARCHAR&#125;, #&#123;memo,jdbcType=VARCHAR&#125;, #&#123;createTime,jdbcType=TIMESTAMP&#125;
                       )
    <span class="hljs-tag">&lt;/<span class="hljs-name">insert</span>&gt;</span>
    <span class="hljs-comment">&lt;!--插入日志记录--&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">insert</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"insertSelective"</span> <span class="hljs-attr">parameterType</span>=<span class="hljs-string">"com.debug.middleware.model.entity.SysLog"</span> &gt;</span>
        insert into sys_log
        <span class="hljs-tag">&lt;<span class="hljs-name">trim</span> <span class="hljs-attr">prefix</span>=<span class="hljs-string">"("</span> <span class="hljs-attr">suffix</span>=<span class="hljs-string">")"</span> <span class="hljs-attr">suffixOverrides</span>=<span class="hljs-string">","</span> &gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">if</span> <span class="hljs-attr">test</span>=<span class="hljs-string">"id != null"</span> &gt;</span>
                id,
            <span class="hljs-tag">&lt;/<span class="hljs-name">if</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">if</span> <span class="hljs-attr">test</span>=<span class="hljs-string">"userId != null"</span> &gt;</span>
                user_id,
            <span class="hljs-tag">&lt;/<span class="hljs-name">if</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">if</span> <span class="hljs-attr">test</span>=<span class="hljs-string">"module != null"</span> &gt;</span>
                module,
            <span class="hljs-tag">&lt;/<span class="hljs-name">if</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">if</span> <span class="hljs-attr">test</span>=<span class="hljs-string">"data != null"</span> &gt;</span>
                data,
            <span class="hljs-tag">&lt;/<span class="hljs-name">if</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">if</span> <span class="hljs-attr">test</span>=<span class="hljs-string">"memo != null"</span> &gt;</span>
                memo,
            <span class="hljs-tag">&lt;/<span class="hljs-name">if</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">if</span> <span class="hljs-attr">test</span>=<span class="hljs-string">"createTime != null"</span> &gt;</span>
                create_time,
            <span class="hljs-tag">&lt;/<span class="hljs-name">if</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">trim</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">trim</span> <span class="hljs-attr">prefix</span>=<span class="hljs-string">"values ("</span> <span class="hljs-attr">suffix</span>=<span class="hljs-string">")"</span> <span class="hljs-attr">suffixOverrides</span>=<span class="hljs-string">","</span> &gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">if</span> <span class="hljs-attr">test</span>=<span class="hljs-string">"id != null"</span> &gt;</span>
                #&#123;id,jdbcType=INTEGER&#125;,
            <span class="hljs-tag">&lt;/<span class="hljs-name">if</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">if</span> <span class="hljs-attr">test</span>=<span class="hljs-string">"userId != null"</span> &gt;</span>
                #&#123;userId,jdbcType=INTEGER&#125;,
            <span class="hljs-tag">&lt;/<span class="hljs-name">if</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">if</span> <span class="hljs-attr">test</span>=<span class="hljs-string">"module != null"</span> &gt;</span>
                #&#123;module,jdbcType=VARCHAR&#125;,
            <span class="hljs-tag">&lt;/<span class="hljs-name">if</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">if</span> <span class="hljs-attr">test</span>=<span class="hljs-string">"data != null"</span> &gt;</span>
                #&#123;data,jdbcType=VARCHAR&#125;,
            <span class="hljs-tag">&lt;/<span class="hljs-name">if</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">if</span> <span class="hljs-attr">test</span>=<span class="hljs-string">"memo != null"</span> &gt;</span>
                #&#123;memo,jdbcType=VARCHAR&#125;,
            <span class="hljs-tag">&lt;/<span class="hljs-name">if</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">if</span> <span class="hljs-attr">test</span>=<span class="hljs-string">"createTime != null"</span> &gt;</span>
                #&#123;createTime,jdbcType=TIMESTAMP&#125;,
            <span class="hljs-tag">&lt;/<span class="hljs-name">if</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">trim</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">insert</span>&gt;</span>
    <span class="hljs-comment">&lt;!--更新日志记录--&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">update</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"updateByPrimaryKeySelective"</span> <span class="hljs-attr">parameterType</span>=<span class="hljs-string">"com.debug.middleware.model.entity.SysLog"</span> &gt;</span>
        update sys_log
        <span class="hljs-tag">&lt;<span class="hljs-name">set</span> &gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">if</span> <span class="hljs-attr">test</span>=<span class="hljs-string">"userId != null"</span> &gt;</span>
                user_id = #&#123;userId,jdbcType=INTEGER&#125;,
            <span class="hljs-tag">&lt;/<span class="hljs-name">if</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">if</span> <span class="hljs-attr">test</span>=<span class="hljs-string">"module != null"</span> &gt;</span>
                module = #&#123;module,jdbcType=VARCHAR&#125;,
            <span class="hljs-tag">&lt;/<span class="hljs-name">if</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">if</span> <span class="hljs-attr">test</span>=<span class="hljs-string">"data != null"</span> &gt;</span>
                data = #&#123;data,jdbcType=VARCHAR&#125;,
            <span class="hljs-tag">&lt;/<span class="hljs-name">if</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">if</span> <span class="hljs-attr">test</span>=<span class="hljs-string">"memo != null"</span> &gt;</span>
                memo = #&#123;memo,jdbcType=VARCHAR&#125;,
            <span class="hljs-tag">&lt;/<span class="hljs-name">if</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">if</span> <span class="hljs-attr">test</span>=<span class="hljs-string">"createTime != null"</span> &gt;</span>
                create_time = #&#123;createTime,jdbcType=TIMESTAMP&#125;,
            <span class="hljs-tag">&lt;/<span class="hljs-name">if</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">set</span>&gt;</span>
        where id = #&#123;id,jdbcType=INTEGER&#125;
    <span class="hljs-tag">&lt;/<span class="hljs-name">update</span>&gt;</span>
    <span class="hljs-comment">&lt;!--更新日志记录--&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">update</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"updateByPrimaryKey"</span> <span class="hljs-attr">parameterType</span>=<span class="hljs-string">"com.debug.middleware.model.entity.SysLog"</span> &gt;</span>
        update sys_log
        set user_id = #&#123;userId,jdbcType=INTEGER&#125;,
            module = #&#123;module,jdbcType=VARCHAR&#125;,
            data = #&#123;data,jdbcType=VARCHAR&#125;,
            memo = #&#123;memo,jdbcType=VARCHAR&#125;,
            create_time = #&#123;createTime,jdbcType=TIMESTAMP&#125;
        where id = #&#123;id,jdbcType=INTEGER&#125;
    <span class="hljs-tag">&lt;/<span class="hljs-name">update</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">mapper</span>&gt;</span></code></pre></div>

<h3 id="5-5-3-开发环境搭建"><a href="#5-5-3-开发环境搭建" class="headerlink" title="5.5.3 开发环境搭建"></a>5.5.3 开发环境搭建</h3><p>1、定义用户单击登录按钮时，后端需要接收的用户登录信息</p>
<div class="hljs"><pre><code class="hljs java"><span class="hljs-meta">@Data</span>
<span class="hljs-meta">@ToString</span>
<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">UserLoginDto</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">Serializable</span> </span>&#123;
    <span class="hljs-meta">@NotBlank</span>
    <span class="hljs-keyword">private</span> String userName;
    <span class="hljs-meta">@NotBlank</span>
    <span class="hljs-keyword">private</span> String password;
    <span class="hljs-keyword">private</span> Integer userId;
&#125;</code></pre></div>

<p>2、开发“接收并处理用户登录实体信息”的控制器UserController，主要用于校验前端用户提交的相关登录信息，并将校验通过后的数据传递给Service层进行处理：</p>
<div class="hljs"><pre><code class="hljs java"><span class="hljs-meta">@RestController</span>
<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">UserController</span> </span>&#123;
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> Logger log = LoggerFactory.getLogger(UserController<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
    <span class="hljs-comment">//前端请求前缀</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> String prefix = <span class="hljs-string">"user"</span>;
    <span class="hljs-comment">/**</span>
<span class="hljs-comment">     * 注入用户操作Service层实例</span>
<span class="hljs-comment">     */</span>
    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> UserService userService;
    <span class="hljs-meta">@RequestMapping</span>(value = prefix+<span class="hljs-string">"/login"</span>,method = RequestMethod.POST,consumes = MediaType.APPLICATION_JSON_UTF8_VALUE)
    <span class="hljs-function"><span class="hljs-keyword">public</span> BaseResponse <span class="hljs-title">login</span><span class="hljs-params">(@RequestBody @Validated UserLoginDto dto, BindingResult result)</span></span>&#123;
        <span class="hljs-comment">//校验前端用户提交的用户登录信息的合法性</span>
        <span class="hljs-keyword">if</span>(result.hasErrors())&#123;
            <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> BaseResponse(StatusCode.InvalidParams);
        &#125;
        <span class="hljs-comment">//定义返回结果实例</span>
        BaseResponse response = <span class="hljs-keyword">new</span> BaseResponse(StatusCode.Success);
        <span class="hljs-keyword">try</span> &#123;
            <span class="hljs-comment">//调用Service层方法真正处理用户登录逻辑</span>
            Boolean res = userService.login(dto);
            <span class="hljs-keyword">if</span>(res)&#123;
                response = <span class="hljs-keyword">new</span> BaseResponse(StatusCode.Success.getCode(),<span class="hljs-string">"登录成功"</span>);
            &#125;<span class="hljs-keyword">else</span> &#123;
                response = <span class="hljs-keyword">new</span> BaseResponse(StatusCode.Fail.getCode(),<span class="hljs-string">"登录失败-账户名密码不匹配"</span>);
            &#125;
        &#125;<span class="hljs-keyword">catch</span> (Exception e)&#123;
            <span class="hljs-comment">//表示处理过程发生异常</span>
            response = <span class="hljs-keyword">new</span> BaseResponse(StatusCode.Fail.getCode(),e.getMessage());
        &#125;
        <span class="hljs-keyword">return</span> response;
    &#125;
&#125;</code></pre></div>

<p>3、开发用户登录服务UserService类相关功能</p>
<div class="hljs"><pre><code class="hljs java"><span class="hljs-meta">@Service</span>
<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">UserService</span> </span>&#123;
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> Logger log = LoggerFactory.getLogger(UserService<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
    <span class="hljs-comment">/**</span>
<span class="hljs-comment">     * 注入用户实体类对应的Mapper操作接口</span>
<span class="hljs-comment">     */</span>
    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> UserMapper userMapper;
    <span class="hljs-comment">/**</span>
<span class="hljs-comment">     * 日志生产者-用于发送登录成功后相关用户消息</span>
<span class="hljs-comment">     */</span>
    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> LogPublisher logPublisher;
    <span class="hljs-function"><span class="hljs-keyword">public</span> Boolean <span class="hljs-title">login</span><span class="hljs-params">(UserLoginDto dto)</span></span>&#123;
        <span class="hljs-comment">//根据用户名和密码查询用户实体记录</span>
        User user = userMapper.selectByUserNamePassword(dto.getUserName(),dto.getPassword());
        <span class="hljs-keyword">if</span>(user!=<span class="hljs-keyword">null</span>)&#123;
            dto.setUserId(user.getId());
            logPublisher.sendLogMsg(dto);
            <span class="hljs-keyword">return</span> <span class="hljs-keyword">true</span>;
        &#125;<span class="hljs-keyword">else</span> &#123;
            <span class="hljs-keyword">return</span> <span class="hljs-keyword">false</span>;
        &#125;
    &#125;
&#125;</code></pre></div>

<h3 id="5-5-4-基于TopicExchange构建日志消息模型"><a href="#5-5-4-基于TopicExchange构建日志消息模型" class="headerlink" title="5.5.4 基于TopicExchange构建日志消息模型"></a>5.5.4 基于TopicExchange构建日志消息模型</h3><p>用户登录成功之后将相关的用户登录信息通过RabbitMQ的消息队列异步写入数据库中，相关配置如下：</p>
<div class="hljs"><pre><code class="hljs java"><span class="hljs-comment">/**</span>
<span class="hljs-comment">     * 用户登录成功写日志消息模型创建</span>
<span class="hljs-comment">     */</span>
    <span class="hljs-meta">@Bean</span>(name = <span class="hljs-string">"loginQueue"</span>)
    <span class="hljs-function"><span class="hljs-keyword">public</span> Queue <span class="hljs-title">loginQueue</span><span class="hljs-params">()</span></span>&#123;
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> Queue(env.getProperty(<span class="hljs-string">"mq.login.queue.name"</span>),<span class="hljs-keyword">true</span>);
    &#125;
    <span class="hljs-meta">@Bean</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> TopicExchange <span class="hljs-title">loginExchange</span><span class="hljs-params">()</span></span>&#123;
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> TopicExchange(env.getProperty(<span class="hljs-string">"mq.login.exchange.name"</span>),<span class="hljs-keyword">true</span>,<span class="hljs-keyword">false</span>);
    &#125;
    <span class="hljs-meta">@Bean</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> Binding <span class="hljs-title">loginBinding</span><span class="hljs-params">()</span></span>&#123;
        <span class="hljs-keyword">return</span> BindingBuilder.bind(loginQueue()).to(loginExchange())
                .with(env.getProperty(<span class="hljs-string">"mq.login.routing.key.name"</span>));
    &#125;</code></pre></div>

<p>取值：</p>
<div class="hljs"><pre><code class="hljs properties"><span class="hljs-comment">#用户登录成功写日志消息模型</span>
<span class="hljs-meta">mq.login.queue.name</span>=<span class="hljs-string">$&#123;mq.env&#125;.middleware.login.queue</span>
<span class="hljs-meta">mq.login.exchange.name</span>=<span class="hljs-string">$&#123;mq.env&#125;.middleware.login.exchange</span>
<span class="hljs-meta">mq.login.routing.key.name</span>=<span class="hljs-string">$&#123;mq.env&#125;.middleware.login.routing.key</span></code></pre></div>

<h3 id="5-5-5-异步发送接收登录日志消息实战"><a href="#5-5-5-异步发送接收登录日志消息实战" class="headerlink" title="5.5.5 异步发送接收登录日志消息实战"></a>5.5.5 异步发送接收登录日志消息实战</h3><p>用户登录成功后将相关登录信息异步写入数据库，即在LogPublisher类中开发相应的方法，用于将相关消息发送给RabbitMQ队列，并被相应的消费者监听消费。</p>
<div class="hljs"><pre><code class="hljs java"><span class="hljs-meta">@Component</span>
<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">LogPublisher</span> </span>&#123;
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> Logger log = LoggerFactory.getLogger(LogPublisher<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
    <span class="hljs-comment">/**</span>
<span class="hljs-comment">     * 定义RabbitMQ操作组件</span>
<span class="hljs-comment">     */</span>
    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> RabbitTemplate rabbitTemplate;
    <span class="hljs-comment">/**定义环境变量读取实例env*/</span>
    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> Environment env;
    <span class="hljs-comment">/**定义JSON序列化和反序列化组件*/</span>
    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> ObjectMapper objectMapper;
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">sendLogMsg</span><span class="hljs-params">(UserLoginDto loginDto)</span></span>&#123;
        <span class="hljs-keyword">try</span> &#123;
            <span class="hljs-comment">//设置消息传输格式-JSON</span>
            rabbitTemplate.setMessageConverter(<span class="hljs-keyword">new</span> Jackson2JsonMessageConverter());
            <span class="hljs-comment">//设置交换机</span>
            rabbitTemplate.setExchange(env.getProperty(<span class="hljs-string">"mq.login.exchange.name"</span>));
            <span class="hljs-comment">//设置路由</span>
            rabbitTemplate.setRoutingKey(env.getProperty(<span class="hljs-string">"mq.login.routing.key.name"</span>));
            <span class="hljs-comment">//发送消息</span>
            rabbitTemplate.convertAndSend(loginDto, <span class="hljs-keyword">new</span> MessagePostProcessor() &#123;
                <span class="hljs-meta">@Override</span>
                <span class="hljs-function"><span class="hljs-keyword">public</span> Message <span class="hljs-title">postProcessMessage</span><span class="hljs-params">(Message message)</span> <span class="hljs-keyword">throws</span> AmqpException </span>&#123;
                    <span class="hljs-comment">//获取消息属性</span>
                    MessageProperties messageProperties = message.getMessageProperties();
                    <span class="hljs-comment">//设置消息的持久化模式为持久化</span>
                    messageProperties.setDeliveryMode(MessageDeliveryMode.PERSISTENT);
                    <span class="hljs-comment">//设置消息头，表示传输的消息直接指定为某个类实例，</span>
                    <span class="hljs-comment">// 消费者在监听消费时可以直接定义该类对象参数进行接收即可</span>
                    messageProperties.setHeader(AbstractJavaTypeMapper
                                      .DEFAULT_CONTENT_CLASSID_FIELD_NAME,UserLoginDto<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
                    <span class="hljs-keyword">return</span> message;
                &#125;
            &#125;);
            log.info(<span class="hljs-string">"系统日志记录-生产者-将登陆成功后的用户相关信息发送给队列-内容：&#123;&#125;"</span>,loginDto);
        &#125;<span class="hljs-keyword">catch</span> (Exception e)&#123;
            log.error(<span class="hljs-string">"系统日志记录-生产者-将登陆成功后的用户相关信息发送给队列-发生异常：&#123;&#125;"</span>,loginDto,e.fillInStackTrace());
        &#125;
    &#125;
&#125;</code></pre></div>

<p>开发“用户登录成功写日志”队列对应的消费者的相关功能</p>
<div class="hljs"><pre><code class="hljs java"><span class="hljs-meta">@Component</span>
<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">LogConsumer</span> </span>&#123;
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> Logger log = LoggerFactory.getLogger(LogConsumer<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
    <span class="hljs-comment">//定义系统日志服务实例</span>
    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> SysLogService sysLogService;
    <span class="hljs-comment">/**</span>
<span class="hljs-comment">     * 监听消费并处理用户登录成功后的消息</span>
<span class="hljs-comment">     */</span>
    <span class="hljs-meta">@RabbitListener</span>(queues = <span class="hljs-string">"$&#123;mq.login.queue.name&#125;"</span>,containerFactory = <span class="hljs-string">"singleListenerContainer"</span>)
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">consumeMsg</span><span class="hljs-params">(@Payload UserLoginDto loginDto)</span></span>&#123;
        <span class="hljs-keyword">try</span> &#123;
            log.info(<span class="hljs-string">"系统日志记录-消费者-监听消费用户登录成功后的消息=内容：&#123;&#125;"</span>,loginDto);
            <span class="hljs-comment">//调用日志记录服务-用于记录用户登录成功后将相关登录信息记入数据库</span>
            sysLogService.recordLog(loginDto);
        &#125;<span class="hljs-keyword">catch</span> (Exception e)&#123;
            log.error(<span class="hljs-string">"系统日志记录-消费者-监听消费用户登录成功后的的消息-发生异常：&#123;&#125;"</span>,loginDto,e.fillInStackTrace());
        &#125;
    &#125;
&#125;</code></pre></div>

<p>SysLogService类为记录系统日志服务，主要是将相关日志信息记入数据库：</p>
<div class="hljs"><pre><code class="hljs java"><span class="hljs-meta">@Service</span>
<span class="hljs-meta">@EnableAsync</span>
<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">SysLogService</span> </span>&#123;
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> Logger log = LoggerFactory.getLogger(SysLogService<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
    <span class="hljs-comment">/**定义系统日志操作接口Mapper*/</span>
    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> SysLogMapper sysLogMapper;
    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> ObjectMapper objectMapper;

    <span class="hljs-comment">/**</span>
<span class="hljs-comment">     * 将用户登录成功的信息记入数据库</span>
<span class="hljs-comment">     */</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">recordLog</span><span class="hljs-params">(UserLoginDto dto)</span> </span>&#123;
        <span class="hljs-keyword">try</span> &#123;
            <span class="hljs-comment">//定义系统日志对象，并设置相应字段的取值</span>
            SysLog entity = <span class="hljs-keyword">new</span> SysLog();
            entity.setUserId(dto.getUserId());
            entity.setModule(<span class="hljs-string">"用户登录模块"</span>);
            entity.setData(objectMapper.writeValueAsString(dto));
            entity.setMemo(<span class="hljs-string">"用户登录成功记录相关登录信息"</span>);
            entity.setCreateTime(<span class="hljs-keyword">new</span> Date());
            <span class="hljs-comment">//插入数据库</span>
            sysLogMapper.insertSelective(entity);
        &#125;<span class="hljs-keyword">catch</span> (Exception e)&#123;
            log.error(<span class="hljs-string">"系统日志服务-记录用户登录成功的信息入数据库-发生异常：&#123;&#125;"</span>,dto,e.fillInStackTrace());
        &#125;
    &#125;
&#125;</code></pre></div>

<h3 id="5-5-6-整体业务模块自测实战"><a href="#5-5-6-整体业务模块自测实战" class="headerlink" title="5.5.6 整体业务模块自测实战"></a>5.5.6 整体业务模块自测实战</h3><p>1、打开Postman，在地址栏输入<a href="http://127.0.0.1:8087/middleware/user/login，请求方法为POST，选择Body为JSON，请求体中" target="_blank" rel="noopener">http://127.0.0.1:8087/middleware/user/login，请求方法为POST，选择Body为JSON，请求体中</a> 参数userName：jack，password：123456</p>
<p>2、将用户名和登录密码等信息提前在数据库表user中输入，充当“测试数据”。</p>
<h1 id="第6章-死信队列-延迟队列实战"><a href="#第6章-死信队列-延迟队列实战" class="headerlink" title="第6章 死信队列/延迟队列实战"></a>第6章 死信队列/延迟队列实战</h1><h2 id="6-1-死信队列概述"><a href="#6-1-死信队列概述" class="headerlink" title="6.1 死信队列概述"></a>6.1 死信队列概述</h2><h3 id="6-1-1-死信队列简介与作用"><a href="#6-1-1-死信队列简介与作用" class="headerlink" title="6.1.1 死信队列简介与作用"></a>6.1.1 死信队列简介与作用</h3><p>死信队列又称延迟队列、延时队列，即进入该队列中的消息会被延迟消费的队列。</p>
<p>RabbitMQ的引入主要是替代了传统处理流程的“定时器”处理逻辑，利用死信队列来进行处理。</p>
<h2 id="6-2-RabbitMQ死信队列实战"><a href="#6-2-RabbitMQ死信队列实战" class="headerlink" title="6.2 RabbitMQ死信队列实战"></a>6.2 RabbitMQ死信队列实战</h2><p>死信队列占用系统资源少，不需要轮询数据库获取数据，减少DB层面资源的消耗，人为干预很少，只需要搭建好死信队列模型即可，而且会自动消费处理。</p>
<h3 id="6-2-1-死信队列专有词汇介绍"><a href="#6-2-1-死信队列专有词汇介绍" class="headerlink" title="6.2.1 死信队列专有词汇介绍"></a>6.2.1 死信队列专有词汇介绍</h3><ul>
<li>DLX：死信交换机</li>
<li>DLK：死信路由</li>
<li>TTL：进入死信队列中的消息可以存活的时间</li>
</ul>
<h3 id="6-2-2-死信队列消息模型实战"><a href="#6-2-2-死信队列消息模型实战" class="headerlink" title="6.2.2 死信队列消息模型实战"></a>6.2.2 死信队列消息模型实战</h3><p>生产者生产的消息首先到达第一个中转站（即基本交换机），由于基本交换机和基本路由绑定，并对应到指定的“死信队列”，因而消息将进入第一个暂存区，即“死信队列”中，当存活时间一到，消息将进入第二个中转站，即“真正的消息模型”中的死信交换机，然后直接被路由到第二个暂存区，即“真正的队列”中最终该消息被“真正的队列”对应的消费者监听消费。</p>
<p>基本交换机和基本路由绑定死信队列，死信交换机和死信路由绑定真正的队列。</p>
<p>1、DeadInfo实体类充当“消息”</p>
<p>2、在RabbitmqConfig配置类中创建包含死信队列的基本消息模型和包含真正队列的真正消息模型：</p>
<div class="hljs"><pre><code class="hljs java"><span class="hljs-comment">/**</span>
<span class="hljs-comment">     * 死信队列消息模型构建</span>
<span class="hljs-comment">     */</span>
    <span class="hljs-comment">/**创建死信队列*/</span>
    <span class="hljs-meta">@Bean</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> Queue <span class="hljs-title">basicDeadQueue</span><span class="hljs-params">()</span> </span>&#123;
        <span class="hljs-comment">//创建死信队列的组成成分map，用于存放组成成分的相关成员</span>
        Map&lt;String, Object&gt; args = <span class="hljs-keyword">new</span> HashMap&lt;&gt;();
        <span class="hljs-comment">//创建死信交换机</span>
        args.put(<span class="hljs-string">"x-dead-letter-exchange"</span>,env.getProperty(<span class="hljs-string">"mq.dead.exchange.name"</span>));
        <span class="hljs-comment">//创建死信路由</span>
        args.put(<span class="hljs-string">"x-dead-letter-routing-key"</span>,env.getProperty(<span class="hljs-string">"mq.dead.routing.key.name"</span>));
        <span class="hljs-comment">//设定TTL，单位为ms，在这里指10s</span>
        args.put(<span class="hljs-string">"x-message-ttl"</span>,<span class="hljs-number">10000</span>);
        <span class="hljs-comment">//创建并返回死信队列实例</span>
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> Queue(env.getProperty(<span class="hljs-string">"mq.dead.queue.name"</span>),<span class="hljs-keyword">true</span>,<span class="hljs-keyword">false</span>,<span class="hljs-keyword">false</span>,args);
    &#125;
    <span class="hljs-comment">/**创建“基本消息模型”的基本交换机-面向生产者*/</span>
    <span class="hljs-meta">@Bean</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> TopicExchange <span class="hljs-title">basicProducerExchange</span><span class="hljs-params">()</span></span>&#123;
        <span class="hljs-comment">//创建并返回基本交换机实例</span>
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> TopicExchange(env.getProperty(<span class="hljs-string">"mq.producer.basic.exchange.name"</span>),<span class="hljs-keyword">true</span>,<span class="hljs-keyword">false</span>);
    &#125;
    <span class="hljs-comment">/**创建“基本消息模型”的基本绑定-基本交换机+基本路由 -面向生产者*/</span>
    <span class="hljs-meta">@Bean</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> Binding <span class="hljs-title">basicProducerBingding</span><span class="hljs-params">()</span></span>&#123;
        <span class="hljs-keyword">return</span> BindingBuilder.bind(basicQueue()).to(basicExchange())
                .with(env.getProperty(<span class="hljs-string">"mq.producer.basic.routing.key.name"</span>));
    &#125;
    <span class="hljs-comment">/**创建真正的队列-面向消费者*/</span>
    <span class="hljs-meta">@Bean</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> Queue <span class="hljs-title">realConsumerQueue</span><span class="hljs-params">()</span></span>&#123;
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> Queue(env.getProperty(<span class="hljs-string">"mq.consumer.real.queue.name"</span>),<span class="hljs-keyword">true</span>);
    &#125;
    <span class="hljs-comment">/**创建死信交换机*/</span>
    <span class="hljs-meta">@Bean</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> TopicExchange <span class="hljs-title">basicDeadExchange</span><span class="hljs-params">()</span></span>&#123;
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> TopicExchange(env.getProperty(<span class="hljs-string">"mq.dead.exchange.name"</span>),<span class="hljs-keyword">true</span>,<span class="hljs-keyword">false</span>);
    &#125;
    <span class="hljs-comment">/**创建死信路由及其绑定*/</span>
    <span class="hljs-meta">@Bean</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> Binding <span class="hljs-title">basicDeadBinding</span><span class="hljs-params">()</span></span>&#123;
        <span class="hljs-keyword">return</span> BindingBuilder.bind(realConsumerQueue()).to(basicDeadExchange())
                .with(env.getProperty(<span class="hljs-string">"mq.dead.routing.key.name"</span>));
    &#125;</code></pre></div>

<p>3、环境变量实例env取值如下：</p>
<div class="hljs"><pre><code class="hljs properties"><span class="hljs-comment">#死信队列消息模型</span>
<span class="hljs-comment">#定义死信队列的名称</span>
<span class="hljs-meta">mq.dead.queue.name</span>=<span class="hljs-string">$&#123;mq.env&#125;.middleware.dead.queue</span>
<span class="hljs-comment">#定义死信交换机的名称</span>
<span class="hljs-meta">mq.dead.exchange.name</span>=<span class="hljs-string">$&#123;mq.env&#125;.middleware.dead.exchange</span>
<span class="hljs-comment">#定义死信路由的名称</span>
<span class="hljs-meta">mq.dead.routing.key.name</span>=<span class="hljs-string">$&#123;mq.env&#125;.middleware.dead.routing.key</span>
<span class="hljs-comment">#定义“基本消息模型”中的基本交换机的名称</span>
<span class="hljs-meta">mq.producer.basic.exchange.name</span>=<span class="hljs-string">$&#123;mq.env&#125;.middleware.producer.basic.exchange</span>
<span class="hljs-comment">#定义“基本消息模型”中的基本路由名称</span>
<span class="hljs-meta">mq.producer.basic.routing.key.name</span>=<span class="hljs-string">$&#123;mq.env&#125;.middleware.producer.baic.routing.key</span>
<span class="hljs-comment">#定义面向消费者真正的队列名称</span>
<span class="hljs-meta">mq.consumer.real.queue.name</span>=<span class="hljs-string">$&#123;mq.env&#125;.middleware.consumer.real.queue</span></code></pre></div>

<p>4、运行项目，在浏览器地址栏中输入<a href="http://127.0.0.1:15672并回车，输入账号和密码后，查看死信队列和真正的队列。">http://127.0.0.1:15672并回车，输入账号和密码后，查看死信队列和真正的队列。</a></p>
<h3 id="6-2-3-死信队列延迟发送消息实战"><a href="#6-2-3-死信队列延迟发送消息实战" class="headerlink" title="6.2.3 死信队列延迟发送消息实战"></a>6.2.3 死信队列延迟发送消息实战</h3><p>1、开发用于生产、发送消息的生产者DeadPublisher类，主要是将实体对象充当消息发送到“基本消息模型’中</p>
<div class="hljs"><pre><code class="hljs java"><span class="hljs-meta">@Component</span>
<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">DeadPublisher</span> </span>&#123;
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> Logger log = LoggerFactory.getLogger(DeadPublisher<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
    <span class="hljs-comment">/**定义环境变量*/</span>
    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> Environment env;
    <span class="hljs-comment">/**定义RabbitMQ操作组件*/</span>
    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> RabbitTemplate rabbitTemplate;
    <span class="hljs-comment">/**定义JSON序列化和反序列化组件实例*/</span>
    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> ObjectMapper objectMapper;
    <span class="hljs-comment">/**发送对象类型的消息给死信队列*/</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">sendMsg</span><span class="hljs-params">(DeadInfo info)</span></span>&#123;
        <span class="hljs-keyword">try</span> &#123;
            <span class="hljs-comment">//设置消息的传输格式为JSON</span>
            rabbitTemplate.setMessageConverter(<span class="hljs-keyword">new</span> Jackson2JsonMessageConverter());
            <span class="hljs-comment">//设置基本的交换机</span>
            rabbitTemplate.setExchange(env.getProperty(<span class="hljs-string">"mq.producer.basic.exchange.name"</span>));
            <span class="hljs-comment">//设置基本路由</span>
            rabbitTemplate.setRoutingKey(env.getProperty(<span class="hljs-string">"mq.producer.basic.routing.key.name"</span>));
            <span class="hljs-comment">//发送对象类型的消息</span>
            rabbitTemplate.convertAndSend(info, <span class="hljs-keyword">new</span> MessagePostProcessor() &#123;
                <span class="hljs-meta">@Override</span>
                <span class="hljs-function"><span class="hljs-keyword">public</span> Message <span class="hljs-title">postProcessMessage</span><span class="hljs-params">(Message message)</span> <span class="hljs-keyword">throws</span> AmqpException </span>&#123;
                    <span class="hljs-comment">//获取消息属性对象</span>
                    MessageProperties messageProperties = message.getMessageProperties();
                    <span class="hljs-comment">//设置消息的持久化策略</span>
                    messageProperties.setDeliveryMode(MessageDeliveryMode.PERSISTENT);
                    <span class="hljs-comment">//设置消息头，即直接指定发送的消息所属的对象类型</span>
                    messageProperties.setHeader(AbstractJavaTypeMapper
                                                .DEFAULT_CONTENT_CLASSID_FIELD_NAME,DeadInfo<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
                    <span class="hljs-comment">//设置消息的TTL，当消息和队列都设置了TTL时，则取较短时间的值</span>
                    <span class="hljs-comment">//messageProperties.setExpiration(String.valueOf(10000));</span>
                    <span class="hljs-comment">//返回消息实例</span>
                    <span class="hljs-keyword">return</span> message;
                &#125;
            &#125;);
            <span class="hljs-comment">//打印日志</span>
            log.info(<span class="hljs-string">"死信队列实例-发送对象类型的消息入死信队列-内容为：&#123;&#125;"</span>,info);
        &#125;<span class="hljs-keyword">catch</span> (Exception e)&#123;
            log.error(<span class="hljs-string">"死信队列实例-发送对象类型的消息入死信队列-发生异常：&#123;&#125;"</span>,info,e.fillInStackTrace());
        &#125;
    &#125;
&#125;</code></pre></div>

<p>2、消费者</p>
<div class="hljs"><pre><code class="hljs java"><span class="hljs-meta">@Component</span>
<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">DeadConsumer</span> </span>&#123;
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> Logger log = LoggerFactory.getLogger(DeadConsumer<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> ObjectMapper objectMapper;
    <span class="hljs-meta">@RabbitListener</span>(queues = <span class="hljs-string">"$&#123;mq.consumer.real.queue.name&#125;"</span>,containerFactory = <span class="hljs-string">"singleListenerContainer"</span>)
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">consumeMsg</span><span class="hljs-params">(@Payload DeadInfo info)</span></span>&#123;
        <span class="hljs-keyword">try</span> &#123;
            log.info(<span class="hljs-string">"死信队列实战-监听真正的队列-消费队列中的消息，监听到消息内容为：&#123;&#125;"</span>,info);
            <span class="hljs-comment">//TODO：用于执行后续的相关业务逻辑</span>
            
        &#125;<span class="hljs-keyword">catch</span> (Exception e)&#123;
            log.error(<span class="hljs-string">"死信队列实战-监听真正的队列-消费队列中的消息 - 面向消费者发生异常：&#123;&#125;"</span>,info,e.fillInStackTrace());
        &#125;
    &#125;
&#125;</code></pre></div>

<p>3、测试</p>
<div class="hljs"><pre><code class="hljs java"><span class="hljs-comment">/**定义死信队列消息模型生产者实例*/</span>
   <span class="hljs-meta">@Autowired</span>
   <span class="hljs-keyword">private</span> DeadPublisher deadPublisher;
   <span class="hljs-meta">@Test</span>
   <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">test8</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> InterruptedException </span>&#123;
       DeadInfo info = <span class="hljs-keyword">new</span> DeadInfo(<span class="hljs-number">1</span>,<span class="hljs-string">"~~我是第一则消息~~"</span>);
       deadPublisher.sendMsg(info);
       info = <span class="hljs-keyword">new</span> DeadInfo(<span class="hljs-number">2</span>,<span class="hljs-string">"~~我是第二则消息~~"</span>);
       deadPublisher.sendMsg(info);
       Thread.sleep(<span class="hljs-number">30000</span>);
   &#125;</code></pre></div>

<h2 id="6-3-典型应用场景实战之商城平台订单支付超时"><a href="#6-3-典型应用场景实战之商城平台订单支付超时" class="headerlink" title="6.3 典型应用场景实战之商城平台订单支付超时"></a>6.3 典型应用场景实战之商城平台订单支付超时</h2><h3 id="6-3-1-整体业务场景介绍"><a href="#6-3-1-整体业务场景介绍" class="headerlink" title="6.3.1 整体业务场景介绍"></a>6.3.1 整体业务场景介绍</h3><p>实现“自动检测用户下单记录是否已经超过了支付时间”</p>
<h3 id="6-3-2-整体业务流程分析"><a href="#6-3-2-整体业务流程分析" class="headerlink" title="6.3.2 整体业务流程分析"></a>6.3.2 整体业务流程分析</h3><p>该业务场景主要由三大核心业务流程组成：</p>
<ul>
<li>用户下单：将用户下单记录存储至数据库，设置支付状态为“已保存”</li>
<li>死信队列发送和延迟监听下单记录：实现自动监听超时支付的消息记录</li>
<li>更新用户下单记录状态：当监听到消息记录时查询并决定是否需要更新下单记录状态，如果状态仍为“已保存”，则说明未付款，将该状态更新为“已失效”。</li>
</ul>
<h3 id="6-3-3-数据库设计"><a href="#6-3-3-数据库设计" class="headerlink" title="6.3.3 数据库设计"></a>6.3.3 数据库设计</h3><p>用户下单记录表，用来记录用户的下单历史记录</p>
<div class="hljs"><pre><code class="hljs sql"><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> <span class="hljs-string">`user_order`</span> (
  <span class="hljs-string">`id`</span>          <span class="hljs-built_in">int</span>(<span class="hljs-number">11</span>)      <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span> AUTO_INCREMENT,
  <span class="hljs-string">`order_no`</span>    <span class="hljs-built_in">varchar</span>(<span class="hljs-number">255</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span>
  <span class="hljs-keyword">COMMENT</span> <span class="hljs-string">'订单编号'</span>,
  <span class="hljs-string">`user_id`</span>     <span class="hljs-built_in">int</span>(<span class="hljs-number">11</span>)      <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span>
  <span class="hljs-keyword">COMMENT</span> <span class="hljs-string">'用户id'</span>,
  <span class="hljs-string">`status`</span>      <span class="hljs-built_in">int</span>(<span class="hljs-number">11</span>)               <span class="hljs-keyword">DEFAULT</span> <span class="hljs-literal">NULL</span>
  <span class="hljs-keyword">COMMENT</span> <span class="hljs-string">'状态（1=已保存，2=已付款，3=已取消）'</span>,
  <span class="hljs-string">`is_active`</span>   <span class="hljs-built_in">int</span>(<span class="hljs-number">255</span>)              <span class="hljs-keyword">DEFAULT</span> <span class="hljs-string">'1'</span>
  <span class="hljs-keyword">COMMENT</span> <span class="hljs-string">'是否有效（1=有效，0=失效）'</span>,
  <span class="hljs-string">`create_time`</span> datetime              <span class="hljs-keyword">DEFAULT</span> <span class="hljs-literal">NULL</span>,
  <span class="hljs-string">`update_time`</span> datetime              <span class="hljs-keyword">DEFAULT</span> <span class="hljs-literal">NULL</span>,
  PRIMARY <span class="hljs-keyword">KEY</span> (<span class="hljs-string">`id`</span>)
)
  <span class="hljs-keyword">ENGINE</span> = <span class="hljs-keyword">InnoDB</span>
  <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">CHARSET</span> = utf8
  <span class="hljs-keyword">COMMENT</span> = <span class="hljs-string">'用户下单记录表'</span></code></pre></div>

<p>RabbitMQ失效下单记录的历史记录表</p>
<div class="hljs"><pre><code class="hljs sql"><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> <span class="hljs-string">`mq_order`</span> (
  <span class="hljs-string">`id`</span>            <span class="hljs-built_in">int</span>(<span class="hljs-number">11</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span> AUTO_INCREMENT,
  <span class="hljs-string">`order_id`</span>      <span class="hljs-built_in">int</span>(<span class="hljs-number">11</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span>
  <span class="hljs-keyword">COMMENT</span> <span class="hljs-string">'下单记录id'</span>,
  <span class="hljs-string">`business_time`</span> datetime         <span class="hljs-keyword">DEFAULT</span> <span class="hljs-literal">NULL</span>
  <span class="hljs-keyword">COMMENT</span> <span class="hljs-string">'失效下单记录的时间'</span>,
  <span class="hljs-string">`memo`</span>          <span class="hljs-built_in">varchar</span>(<span class="hljs-number">255</span>)     <span class="hljs-keyword">DEFAULT</span> <span class="hljs-literal">NULL</span>
  <span class="hljs-keyword">COMMENT</span> <span class="hljs-string">'备注信息'</span>,
  PRIMARY <span class="hljs-keyword">KEY</span> (<span class="hljs-string">`id`</span>)
)
  <span class="hljs-keyword">ENGINE</span> = <span class="hljs-keyword">InnoDB</span>
  <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">CHARSET</span> = utf8
  <span class="hljs-keyword">COMMENT</span> = <span class="hljs-string">'RabbitMQ失效下单记录的历史记录表'</span></code></pre></div>

<p>1、UserOrder，用户下单实体类</p>
<div class="hljs"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">UserOrder</span> </span>&#123;
    <span class="hljs-keyword">private</span> Integer id;

    <span class="hljs-keyword">private</span> String orderNo;

    <span class="hljs-keyword">private</span> Integer userId;

    <span class="hljs-keyword">private</span> Integer status;

    <span class="hljs-keyword">private</span> Integer isActive;

    <span class="hljs-keyword">private</span> Date createTime;

    <span class="hljs-keyword">private</span> Date updateTime;

    <span class="hljs-function"><span class="hljs-keyword">public</span> Integer <span class="hljs-title">getId</span><span class="hljs-params">()</span> </span>&#123;
        <span class="hljs-keyword">return</span> id;
    &#125;

    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setId</span><span class="hljs-params">(Integer id)</span> </span>&#123;
        <span class="hljs-keyword">this</span>.id = id;
    &#125;

    <span class="hljs-function"><span class="hljs-keyword">public</span> String <span class="hljs-title">getOrderNo</span><span class="hljs-params">()</span> </span>&#123;
        <span class="hljs-keyword">return</span> orderNo;
    &#125;

    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setOrderNo</span><span class="hljs-params">(String orderNo)</span> </span>&#123;
        <span class="hljs-keyword">this</span>.orderNo = orderNo == <span class="hljs-keyword">null</span> ? <span class="hljs-keyword">null</span> : orderNo.trim();
    &#125;

    <span class="hljs-function"><span class="hljs-keyword">public</span> Integer <span class="hljs-title">getUserId</span><span class="hljs-params">()</span> </span>&#123;
        <span class="hljs-keyword">return</span> userId;
    &#125;

    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setUserId</span><span class="hljs-params">(Integer userId)</span> </span>&#123;
        <span class="hljs-keyword">this</span>.userId = userId;
    &#125;

    <span class="hljs-function"><span class="hljs-keyword">public</span> Integer <span class="hljs-title">getStatus</span><span class="hljs-params">()</span> </span>&#123;
        <span class="hljs-keyword">return</span> status;
    &#125;

    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setStatus</span><span class="hljs-params">(Integer status)</span> </span>&#123;
        <span class="hljs-keyword">this</span>.status = status;
    &#125;

    <span class="hljs-function"><span class="hljs-keyword">public</span> Integer <span class="hljs-title">getIsActive</span><span class="hljs-params">()</span> </span>&#123;
        <span class="hljs-keyword">return</span> isActive;
    &#125;

    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setIsActive</span><span class="hljs-params">(Integer isActive)</span> </span>&#123;
        <span class="hljs-keyword">this</span>.isActive = isActive;
    &#125;

    <span class="hljs-function"><span class="hljs-keyword">public</span> Date <span class="hljs-title">getCreateTime</span><span class="hljs-params">()</span> </span>&#123;
        <span class="hljs-keyword">return</span> createTime;
    &#125;

    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setCreateTime</span><span class="hljs-params">(Date createTime)</span> </span>&#123;
        <span class="hljs-keyword">this</span>.createTime = createTime;
    &#125;

    <span class="hljs-function"><span class="hljs-keyword">public</span> Date <span class="hljs-title">getUpdateTime</span><span class="hljs-params">()</span> </span>&#123;
        <span class="hljs-keyword">return</span> updateTime;
    &#125;

    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setUpdateTime</span><span class="hljs-params">(Date updateTime)</span> </span>&#123;
        <span class="hljs-keyword">this</span>.updateTime = updateTime;
    &#125;

    <span class="hljs-meta">@Override</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> String <span class="hljs-title">toString</span><span class="hljs-params">()</span> </span>&#123;
        <span class="hljs-keyword">return</span> <span class="hljs-string">"UserOrder&#123;"</span> +
                <span class="hljs-string">"id="</span> + id +
                <span class="hljs-string">", orderNo='"</span> + orderNo + <span class="hljs-string">'\''</span> +
                <span class="hljs-string">", userId="</span> + userId +
                <span class="hljs-string">", status="</span> + status +
                <span class="hljs-string">", isActive="</span> + isActive +
                <span class="hljs-string">", createTime="</span> + createTime +
                <span class="hljs-string">", updateTime="</span> + updateTime +
                <span class="hljs-string">'&#125;'</span>;
    &#125;
&#125;</code></pre></div>

<p>MqOrder类，RabbitMQ死信队列更新失效订单的状态实体</p>
<div class="hljs"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MqOrder</span> </span>&#123;
    <span class="hljs-keyword">private</span> Integer id; <span class="hljs-comment">//主键id</span>
    <span class="hljs-keyword">private</span> Integer orderId; <span class="hljs-comment">//下单记录id</span>
    <span class="hljs-keyword">private</span> Date businessTime; <span class="hljs-comment">//失效下单记录状态的业务时间</span>
    <span class="hljs-keyword">private</span> String memo; <span class="hljs-comment">//备注信息</span>

    <span class="hljs-function"><span class="hljs-keyword">public</span> Integer <span class="hljs-title">getId</span><span class="hljs-params">()</span> </span>&#123;
        <span class="hljs-keyword">return</span> id;
    &#125;

    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setId</span><span class="hljs-params">(Integer id)</span> </span>&#123;
        <span class="hljs-keyword">this</span>.id = id;
    &#125;

    <span class="hljs-function"><span class="hljs-keyword">public</span> Integer <span class="hljs-title">getOrderId</span><span class="hljs-params">()</span> </span>&#123;
        <span class="hljs-keyword">return</span> orderId;
    &#125;

    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setOrderId</span><span class="hljs-params">(Integer orderId)</span> </span>&#123;
        <span class="hljs-keyword">this</span>.orderId = orderId;
    &#125;

    <span class="hljs-function"><span class="hljs-keyword">public</span> Date <span class="hljs-title">getBusinessTime</span><span class="hljs-params">()</span> </span>&#123;
        <span class="hljs-keyword">return</span> businessTime;
    &#125;

    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setBusinessTime</span><span class="hljs-params">(Date businessTime)</span> </span>&#123;
        <span class="hljs-keyword">this</span>.businessTime = businessTime;
    &#125;

    <span class="hljs-function"><span class="hljs-keyword">public</span> String <span class="hljs-title">getMemo</span><span class="hljs-params">()</span> </span>&#123;
        <span class="hljs-keyword">return</span> memo;
    &#125;

    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setMemo</span><span class="hljs-params">(String memo)</span> </span>&#123;
        <span class="hljs-keyword">this</span>.memo = memo == <span class="hljs-keyword">null</span> ? <span class="hljs-keyword">null</span> : memo.trim();
    &#125;
&#125;</code></pre></div>

<p>2、MqOrderMapper</p>
<div class="hljs"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">interface</span> <span class="hljs-title">MqOrderMapper</span> </span>&#123;
    <span class="hljs-comment">/**根据主键id删除记录*/</span>
    <span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">deleteByPrimaryKey</span><span class="hljs-params">(Integer id)</span></span>;
    <span class="hljs-comment">/**插入记录*/</span>
    <span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">insert</span><span class="hljs-params">(MqOrder record)</span></span>;
    <span class="hljs-comment">/**插入记录*/</span>
    <span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">insertSelective</span><span class="hljs-params">(MqOrder record)</span></span>;
    <span class="hljs-comment">/**根据主键id查询记录*/</span>
    <span class="hljs-function">MqOrder <span class="hljs-title">selectByPrimaryKey</span><span class="hljs-params">(Integer id)</span></span>;
    <span class="hljs-comment">/**更新记录*/</span>
    <span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">updateByPrimaryKeySelective</span><span class="hljs-params">(MqOrder record)</span></span>;
    <span class="hljs-comment">/**更新记录*/</span>
    <span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">updateByPrimaryKey</span><span class="hljs-params">(MqOrder record)</span></span>;
&#125;</code></pre></div>

<p>对应的MqOrderMapper.xml代码如下：</p>
<div class="hljs"><pre><code class="hljs xml"><span class="hljs-meta">&lt;?xml version="1.0" encoding="UTF-8" ?&gt;</span>
<span class="hljs-comment">&lt;!--xml文档类型定义--&gt;</span>
<span class="hljs-meta">&lt;!DOCTYPE <span class="hljs-meta-keyword">mapper</span> <span class="hljs-meta-keyword">PUBLIC</span> <span class="hljs-meta-string">"-//mybatis.org//DTD Mapper 3.0//EN"</span> <span class="hljs-meta-string">"http://mybatis.org/dtd/mybatis-3-mapper.dtd"</span> &gt;</span>
<span class="hljs-comment">&lt;!--Mapper操作接口--&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">mapper</span> <span class="hljs-attr">namespace</span>=<span class="hljs-string">"com.debug.middleware.model.mapper.MqOrderMapper"</span> &gt;</span>
  <span class="hljs-comment">&lt;!--Mapper查询结果集映射--&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">resultMap</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"BaseResultMap"</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"com.debug.middleware.model.entity.MqOrder"</span> &gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">id</span> <span class="hljs-attr">column</span>=<span class="hljs-string">"id"</span> <span class="hljs-attr">property</span>=<span class="hljs-string">"id"</span> <span class="hljs-attr">jdbcType</span>=<span class="hljs-string">"INTEGER"</span> /&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">result</span> <span class="hljs-attr">column</span>=<span class="hljs-string">"order_id"</span> <span class="hljs-attr">property</span>=<span class="hljs-string">"orderId"</span> <span class="hljs-attr">jdbcType</span>=<span class="hljs-string">"INTEGER"</span> /&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">result</span> <span class="hljs-attr">column</span>=<span class="hljs-string">"business_time"</span> <span class="hljs-attr">property</span>=<span class="hljs-string">"businessTime"</span> <span class="hljs-attr">jdbcType</span>=<span class="hljs-string">"TIMESTAMP"</span> /&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">result</span> <span class="hljs-attr">column</span>=<span class="hljs-string">"memo"</span> <span class="hljs-attr">property</span>=<span class="hljs-string">"memo"</span> <span class="hljs-attr">jdbcType</span>=<span class="hljs-string">"VARCHAR"</span> /&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">resultMap</span>&gt;</span>
  <span class="hljs-comment">&lt;!--Mapper查询SQL片段定义--&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">sql</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"Base_Column_List"</span> &gt;</span>
    id, order_id, business_time, memo
  <span class="hljs-tag">&lt;/<span class="hljs-name">sql</span>&gt;</span>
  <span class="hljs-comment">&lt;!--根据主键id查询--&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">select</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"selectByPrimaryKey"</span> <span class="hljs-attr">resultMap</span>=<span class="hljs-string">"BaseResultMap"</span> <span class="hljs-attr">parameterType</span>=<span class="hljs-string">"java.lang.Integer"</span> &gt;</span>
    select 
    <span class="hljs-tag">&lt;<span class="hljs-name">include</span> <span class="hljs-attr">refid</span>=<span class="hljs-string">"Base_Column_List"</span> /&gt;</span>
    from mq_order
    where id = #&#123;id,jdbcType=INTEGER&#125;
  <span class="hljs-tag">&lt;/<span class="hljs-name">select</span>&gt;</span>
  <span class="hljs-comment">&lt;!--根据主键id删除--&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">delete</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"deleteByPrimaryKey"</span> <span class="hljs-attr">parameterType</span>=<span class="hljs-string">"java.lang.Integer"</span> &gt;</span>
    delete from mq_order
    where id = #&#123;id,jdbcType=INTEGER&#125;
  <span class="hljs-tag">&lt;/<span class="hljs-name">delete</span>&gt;</span>
  <span class="hljs-comment">&lt;!--插入记录--&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">insert</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"insert"</span> <span class="hljs-attr">parameterType</span>=<span class="hljs-string">"com.debug.middleware.model.entity.MqOrder"</span> &gt;</span>
    insert into mq_order (id, order_id, business_time, 
      memo)
    values (#&#123;id,jdbcType=INTEGER&#125;, #&#123;orderId,jdbcType=INTEGER&#125;, #&#123;businessTime,jdbcType=TIMESTAMP&#125;, 
      #&#123;memo,jdbcType=VARCHAR&#125;)
  <span class="hljs-tag">&lt;/<span class="hljs-name">insert</span>&gt;</span>
  <span class="hljs-comment">&lt;!--插入记录--&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">insert</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"insertSelective"</span> <span class="hljs-attr">parameterType</span>=<span class="hljs-string">"com.debug.middleware.model.entity.MqOrder"</span> &gt;</span>
    insert into mq_order
    <span class="hljs-tag">&lt;<span class="hljs-name">trim</span> <span class="hljs-attr">prefix</span>=<span class="hljs-string">"("</span> <span class="hljs-attr">suffix</span>=<span class="hljs-string">")"</span> <span class="hljs-attr">suffixOverrides</span>=<span class="hljs-string">","</span> &gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">if</span> <span class="hljs-attr">test</span>=<span class="hljs-string">"id != null"</span> &gt;</span>
        id,
      <span class="hljs-tag">&lt;/<span class="hljs-name">if</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">if</span> <span class="hljs-attr">test</span>=<span class="hljs-string">"orderId != null"</span> &gt;</span>
        order_id,
      <span class="hljs-tag">&lt;/<span class="hljs-name">if</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">if</span> <span class="hljs-attr">test</span>=<span class="hljs-string">"businessTime != null"</span> &gt;</span>
        business_time,
      <span class="hljs-tag">&lt;/<span class="hljs-name">if</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">if</span> <span class="hljs-attr">test</span>=<span class="hljs-string">"memo != null"</span> &gt;</span>
        memo,
      <span class="hljs-tag">&lt;/<span class="hljs-name">if</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">trim</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">trim</span> <span class="hljs-attr">prefix</span>=<span class="hljs-string">"values ("</span> <span class="hljs-attr">suffix</span>=<span class="hljs-string">")"</span> <span class="hljs-attr">suffixOverrides</span>=<span class="hljs-string">","</span> &gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">if</span> <span class="hljs-attr">test</span>=<span class="hljs-string">"id != null"</span> &gt;</span>
        #&#123;id,jdbcType=INTEGER&#125;,
      <span class="hljs-tag">&lt;/<span class="hljs-name">if</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">if</span> <span class="hljs-attr">test</span>=<span class="hljs-string">"orderId != null"</span> &gt;</span>
        #&#123;orderId,jdbcType=INTEGER&#125;,
      <span class="hljs-tag">&lt;/<span class="hljs-name">if</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">if</span> <span class="hljs-attr">test</span>=<span class="hljs-string">"businessTime != null"</span> &gt;</span>
        #&#123;businessTime,jdbcType=TIMESTAMP&#125;,
      <span class="hljs-tag">&lt;/<span class="hljs-name">if</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">if</span> <span class="hljs-attr">test</span>=<span class="hljs-string">"memo != null"</span> &gt;</span>
        #&#123;memo,jdbcType=VARCHAR&#125;,
      <span class="hljs-tag">&lt;/<span class="hljs-name">if</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">trim</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">insert</span>&gt;</span>
  <span class="hljs-comment">&lt;!--更新记录--&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">update</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"updateByPrimaryKeySelective"</span> <span class="hljs-attr">parameterType</span>=<span class="hljs-string">"com.debug.middleware.model.entity.MqOrder"</span> &gt;</span>
    update mq_order
    <span class="hljs-tag">&lt;<span class="hljs-name">set</span> &gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">if</span> <span class="hljs-attr">test</span>=<span class="hljs-string">"orderId != null"</span> &gt;</span>
        order_id = #&#123;orderId,jdbcType=INTEGER&#125;,
      <span class="hljs-tag">&lt;/<span class="hljs-name">if</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">if</span> <span class="hljs-attr">test</span>=<span class="hljs-string">"businessTime != null"</span> &gt;</span>
        business_time = #&#123;businessTime,jdbcType=TIMESTAMP&#125;,
      <span class="hljs-tag">&lt;/<span class="hljs-name">if</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">if</span> <span class="hljs-attr">test</span>=<span class="hljs-string">"memo != null"</span> &gt;</span>
        memo = #&#123;memo,jdbcType=VARCHAR&#125;,
      <span class="hljs-tag">&lt;/<span class="hljs-name">if</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">set</span>&gt;</span>
    where id = #&#123;id,jdbcType=INTEGER&#125;
  <span class="hljs-tag">&lt;/<span class="hljs-name">update</span>&gt;</span>
  <span class="hljs-comment">&lt;!--更新记录--&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">update</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"updateByPrimaryKey"</span> <span class="hljs-attr">parameterType</span>=<span class="hljs-string">"com.debug.middleware.model.entity.MqOrder"</span> &gt;</span>
    update mq_order
    set order_id = #&#123;orderId,jdbcType=INTEGER&#125;,
      business_time = #&#123;businessTime,jdbcType=TIMESTAMP&#125;,
      memo = #&#123;memo,jdbcType=VARCHAR&#125;
    where id = #&#123;id,jdbcType=INTEGER&#125;
  <span class="hljs-tag">&lt;/<span class="hljs-name">update</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">mapper</span>&gt;</span></code></pre></div>

<p>3、UserOrderMapper操作接口和对应的xml配置文件</p>
<div class="hljs"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">interface</span> <span class="hljs-title">UserOrderMapper</span> </span>&#123;
    <span class="hljs-comment">/**根据主键id删除记录*/</span>
    <span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">deleteByPrimaryKey</span><span class="hljs-params">(Integer id)</span></span>;
    <span class="hljs-comment">/**插入记录*/</span>
    <span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">insert</span><span class="hljs-params">(UserOrder record)</span></span>;
    <span class="hljs-comment">/**插入记录*/</span>
    <span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">insertSelective</span><span class="hljs-params">(UserOrder record)</span></span>;
    <span class="hljs-comment">/**根据主键id查询记录*/</span>
    <span class="hljs-function">UserOrder <span class="hljs-title">selectByPrimaryKey</span><span class="hljs-params">(Integer id)</span></span>;
    <span class="hljs-comment">/**更新记录*/</span>
    <span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">updateByPrimaryKeySelective</span><span class="hljs-params">(UserOrder record)</span></span>;
    <span class="hljs-comment">/**更新记录*/</span>
    <span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">updateByPrimaryKey</span><span class="hljs-params">(UserOrder record)</span></span>;
    <span class="hljs-comment">/**根据下单记录Id和支付状态查询*/</span>
    <span class="hljs-function">UserOrder <span class="hljs-title">selectByIdAndStatus</span><span class="hljs-params">(@Param(<span class="hljs-string">"id"</span>)</span> Integer id, @<span class="hljs-title">Param</span><span class="hljs-params">(<span class="hljs-string">"status"</span>)</span> Integer status)</span>;
&#125;</code></pre></div>

<div class="hljs"><pre><code class="hljs xml"><span class="hljs-meta">&lt;?xml version="1.0" encoding="UTF-8" ?&gt;</span>
<span class="hljs-comment">&lt;!--xml文档类型说明--&gt;</span>
<span class="hljs-meta">&lt;!DOCTYPE <span class="hljs-meta-keyword">mapper</span> <span class="hljs-meta-keyword">PUBLIC</span> <span class="hljs-meta-string">"-//mybatis.org//DTD Mapper 3.0//EN"</span> <span class="hljs-meta-string">"http://mybatis.org/dtd/mybatis-3-mapper.dtd"</span> &gt;</span>
<span class="hljs-comment">&lt;!--UserOrderMapper操作接口所在的命名空间定义--&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">mapper</span> <span class="hljs-attr">namespace</span>=<span class="hljs-string">"com.debug.middleware.model.mapper.UserOrderMapper"</span> &gt;</span>
  <span class="hljs-comment">&lt;!--查询得到的结果集映射--&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">resultMap</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"BaseResultMap"</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"com.debug.middleware.model.entity.UserOrder"</span> &gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">id</span> <span class="hljs-attr">column</span>=<span class="hljs-string">"id"</span> <span class="hljs-attr">property</span>=<span class="hljs-string">"id"</span> <span class="hljs-attr">jdbcType</span>=<span class="hljs-string">"INTEGER"</span> /&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">result</span> <span class="hljs-attr">column</span>=<span class="hljs-string">"order_no"</span> <span class="hljs-attr">property</span>=<span class="hljs-string">"orderNo"</span> <span class="hljs-attr">jdbcType</span>=<span class="hljs-string">"VARCHAR"</span> /&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">result</span> <span class="hljs-attr">column</span>=<span class="hljs-string">"user_id"</span> <span class="hljs-attr">property</span>=<span class="hljs-string">"userId"</span> <span class="hljs-attr">jdbcType</span>=<span class="hljs-string">"INTEGER"</span> /&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">result</span> <span class="hljs-attr">column</span>=<span class="hljs-string">"status"</span> <span class="hljs-attr">property</span>=<span class="hljs-string">"status"</span> <span class="hljs-attr">jdbcType</span>=<span class="hljs-string">"INTEGER"</span> /&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">result</span> <span class="hljs-attr">column</span>=<span class="hljs-string">"is_active"</span> <span class="hljs-attr">property</span>=<span class="hljs-string">"isActive"</span> <span class="hljs-attr">jdbcType</span>=<span class="hljs-string">"INTEGER"</span> /&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">result</span> <span class="hljs-attr">column</span>=<span class="hljs-string">"create_time"</span> <span class="hljs-attr">property</span>=<span class="hljs-string">"createTime"</span> <span class="hljs-attr">jdbcType</span>=<span class="hljs-string">"TIMESTAMP"</span> /&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">result</span> <span class="hljs-attr">column</span>=<span class="hljs-string">"update_time"</span> <span class="hljs-attr">property</span>=<span class="hljs-string">"updateTime"</span> <span class="hljs-attr">jdbcType</span>=<span class="hljs-string">"TIMESTAMP"</span> /&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">resultMap</span>&gt;</span>
  <span class="hljs-comment">&lt;!--查询的SQL片段--&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">sql</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"Base_Column_List"</span> &gt;</span>
    id, order_no, user_id, status, is_active, create_time, update_time
  <span class="hljs-tag">&lt;/<span class="hljs-name">sql</span>&gt;</span>
  <span class="hljs-comment">&lt;!--根据下单记录Id查询记录--&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">select</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"selectByPrimaryKey"</span> <span class="hljs-attr">resultMap</span>=<span class="hljs-string">"BaseResultMap"</span> <span class="hljs-attr">parameterType</span>=<span class="hljs-string">"java.lang.Integer"</span> &gt;</span>
    select 
    <span class="hljs-tag">&lt;<span class="hljs-name">include</span> <span class="hljs-attr">refid</span>=<span class="hljs-string">"Base_Column_List"</span> /&gt;</span>
    from user_order
    where id = #&#123;id,jdbcType=INTEGER&#125;
  <span class="hljs-tag">&lt;/<span class="hljs-name">select</span>&gt;</span>
  <span class="hljs-comment">&lt;!--根据主键id删除记录--&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">delete</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"deleteByPrimaryKey"</span> <span class="hljs-attr">parameterType</span>=<span class="hljs-string">"java.lang.Integer"</span> &gt;</span>
    delete from user_order
    where id = #&#123;id,jdbcType=INTEGER&#125;
  <span class="hljs-tag">&lt;/<span class="hljs-name">delete</span>&gt;</span>
  <span class="hljs-comment">&lt;!--插入用户下单记录--&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">insert</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"insert"</span> <span class="hljs-attr">useGeneratedKeys</span>=<span class="hljs-string">"true"</span> <span class="hljs-attr">keyProperty</span>=<span class="hljs-string">"id"</span> <span class="hljs-attr">parameterType</span>=<span class="hljs-string">"com.debug.middleware.model.entity.UserOrder"</span> &gt;</span>
    insert into user_order (id, order_no, user_id, 
      status, is_active, create_time, 
      update_time)
    values (#&#123;id,jdbcType=INTEGER&#125;, #&#123;orderNo,jdbcType=VARCHAR&#125;, #&#123;userId,jdbcType=INTEGER&#125;, 
      #&#123;status,jdbcType=INTEGER&#125;, #&#123;isActive,jdbcType=INTEGER&#125;, #&#123;createTime,jdbcType=TIMESTAMP&#125;, 
      #&#123;updateTime,jdbcType=TIMESTAMP&#125;)
  <span class="hljs-tag">&lt;/<span class="hljs-name">insert</span>&gt;</span>
  <span class="hljs-comment">&lt;!--插入用户下单记录--&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">insert</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"insertSelective"</span> <span class="hljs-attr">useGeneratedKeys</span>=<span class="hljs-string">"true"</span> <span class="hljs-attr">keyProperty</span>=<span class="hljs-string">"id"</span> <span class="hljs-attr">parameterType</span>=<span class="hljs-string">"com.debug.middleware.model.entity.UserOrder"</span> &gt;</span>
    insert into user_order
    <span class="hljs-tag">&lt;<span class="hljs-name">trim</span> <span class="hljs-attr">prefix</span>=<span class="hljs-string">"("</span> <span class="hljs-attr">suffix</span>=<span class="hljs-string">")"</span> <span class="hljs-attr">suffixOverrides</span>=<span class="hljs-string">","</span> &gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">if</span> <span class="hljs-attr">test</span>=<span class="hljs-string">"id != null"</span> &gt;</span>
        id,
      <span class="hljs-tag">&lt;/<span class="hljs-name">if</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">if</span> <span class="hljs-attr">test</span>=<span class="hljs-string">"orderNo != null"</span> &gt;</span>
        order_no,
      <span class="hljs-tag">&lt;/<span class="hljs-name">if</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">if</span> <span class="hljs-attr">test</span>=<span class="hljs-string">"userId != null"</span> &gt;</span>
        user_id,
      <span class="hljs-tag">&lt;/<span class="hljs-name">if</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">if</span> <span class="hljs-attr">test</span>=<span class="hljs-string">"status != null"</span> &gt;</span>
        status,
      <span class="hljs-tag">&lt;/<span class="hljs-name">if</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">if</span> <span class="hljs-attr">test</span>=<span class="hljs-string">"isActive != null"</span> &gt;</span>
        is_active,
      <span class="hljs-tag">&lt;/<span class="hljs-name">if</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">if</span> <span class="hljs-attr">test</span>=<span class="hljs-string">"createTime != null"</span> &gt;</span>
        create_time,
      <span class="hljs-tag">&lt;/<span class="hljs-name">if</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">if</span> <span class="hljs-attr">test</span>=<span class="hljs-string">"updateTime != null"</span> &gt;</span>
        update_time,
      <span class="hljs-tag">&lt;/<span class="hljs-name">if</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">trim</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">trim</span> <span class="hljs-attr">prefix</span>=<span class="hljs-string">"values ("</span> <span class="hljs-attr">suffix</span>=<span class="hljs-string">")"</span> <span class="hljs-attr">suffixOverrides</span>=<span class="hljs-string">","</span> &gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">if</span> <span class="hljs-attr">test</span>=<span class="hljs-string">"id != null"</span> &gt;</span>
        #&#123;id,jdbcType=INTEGER&#125;,
      <span class="hljs-tag">&lt;/<span class="hljs-name">if</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">if</span> <span class="hljs-attr">test</span>=<span class="hljs-string">"orderNo != null"</span> &gt;</span>
        #&#123;orderNo,jdbcType=VARCHAR&#125;,
      <span class="hljs-tag">&lt;/<span class="hljs-name">if</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">if</span> <span class="hljs-attr">test</span>=<span class="hljs-string">"userId != null"</span> &gt;</span>
        #&#123;userId,jdbcType=INTEGER&#125;,
      <span class="hljs-tag">&lt;/<span class="hljs-name">if</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">if</span> <span class="hljs-attr">test</span>=<span class="hljs-string">"status != null"</span> &gt;</span>
        #&#123;status,jdbcType=INTEGER&#125;,
      <span class="hljs-tag">&lt;/<span class="hljs-name">if</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">if</span> <span class="hljs-attr">test</span>=<span class="hljs-string">"isActive != null"</span> &gt;</span>
        #&#123;isActive,jdbcType=INTEGER&#125;,
      <span class="hljs-tag">&lt;/<span class="hljs-name">if</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">if</span> <span class="hljs-attr">test</span>=<span class="hljs-string">"createTime != null"</span> &gt;</span>
        #&#123;createTime,jdbcType=TIMESTAMP&#125;,
      <span class="hljs-tag">&lt;/<span class="hljs-name">if</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">if</span> <span class="hljs-attr">test</span>=<span class="hljs-string">"updateTime != null"</span> &gt;</span>
        #&#123;updateTime,jdbcType=TIMESTAMP&#125;,
      <span class="hljs-tag">&lt;/<span class="hljs-name">if</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">trim</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">insert</span>&gt;</span>
  <span class="hljs-comment">&lt;!--根据下单记录id更新记录--&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">update</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"updateByPrimaryKeySelective"</span> <span class="hljs-attr">parameterType</span>=<span class="hljs-string">"com.debug.middleware.model.entity.UserOrder"</span> &gt;</span>
    update user_order
    <span class="hljs-tag">&lt;<span class="hljs-name">set</span> &gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">if</span> <span class="hljs-attr">test</span>=<span class="hljs-string">"orderNo != null"</span> &gt;</span>
        order_no = #&#123;orderNo,jdbcType=VARCHAR&#125;,
      <span class="hljs-tag">&lt;/<span class="hljs-name">if</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">if</span> <span class="hljs-attr">test</span>=<span class="hljs-string">"userId != null"</span> &gt;</span>
        user_id = #&#123;userId,jdbcType=INTEGER&#125;,
      <span class="hljs-tag">&lt;/<span class="hljs-name">if</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">if</span> <span class="hljs-attr">test</span>=<span class="hljs-string">"status != null"</span> &gt;</span>
        status = #&#123;status,jdbcType=INTEGER&#125;,
      <span class="hljs-tag">&lt;/<span class="hljs-name">if</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">if</span> <span class="hljs-attr">test</span>=<span class="hljs-string">"isActive != null"</span> &gt;</span>
        is_active = #&#123;isActive,jdbcType=INTEGER&#125;,
      <span class="hljs-tag">&lt;/<span class="hljs-name">if</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">if</span> <span class="hljs-attr">test</span>=<span class="hljs-string">"createTime != null"</span> &gt;</span>
        create_time = #&#123;createTime,jdbcType=TIMESTAMP&#125;,
      <span class="hljs-tag">&lt;/<span class="hljs-name">if</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">if</span> <span class="hljs-attr">test</span>=<span class="hljs-string">"updateTime != null"</span> &gt;</span>
        update_time = #&#123;updateTime,jdbcType=TIMESTAMP&#125;,
      <span class="hljs-tag">&lt;/<span class="hljs-name">if</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">set</span>&gt;</span>
    where id = #&#123;id,jdbcType=INTEGER&#125;
  <span class="hljs-tag">&lt;/<span class="hljs-name">update</span>&gt;</span>
  <span class="hljs-comment">&lt;!--根据下单记录id更新记录--&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">update</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"updateByPrimaryKey"</span> <span class="hljs-attr">parameterType</span>=<span class="hljs-string">"com.debug.middleware.model.entity.UserOrder"</span> &gt;</span>
    update user_order
    set order_no = #&#123;orderNo,jdbcType=VARCHAR&#125;,
      user_id = #&#123;userId,jdbcType=INTEGER&#125;,
      status = #&#123;status,jdbcType=INTEGER&#125;,
      is_active = #&#123;isActive,jdbcType=INTEGER&#125;,
      create_time = #&#123;createTime,jdbcType=TIMESTAMP&#125;,
      update_time = #&#123;updateTime,jdbcType=TIMESTAMP&#125;
    where id = #&#123;id,jdbcType=INTEGER&#125;
  <span class="hljs-tag">&lt;/<span class="hljs-name">update</span>&gt;</span>
  <span class="hljs-comment">&lt;!--根据下单记录Id和支付状态查询--&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">select</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"selectByIdAndStatus"</span> <span class="hljs-attr">resultType</span>=<span class="hljs-string">"com.debug.middleware.model.entity.UserOrder"</span>&gt;</span>
    SELECT
        <span class="hljs-tag">&lt;<span class="hljs-name">include</span> <span class="hljs-attr">refid</span>=<span class="hljs-string">"Base_Column_List"</span>/&gt;</span>
    FROM
        user_order
    WHERE
        is_active
    AND `status` = #&#123;status&#125;
    AND id = #&#123;id&#125;
  <span class="hljs-tag">&lt;/<span class="hljs-name">select</span>&gt;</span>

<span class="hljs-tag">&lt;/<span class="hljs-name">mapper</span>&gt;</span></code></pre></div>

<h3 id="6-3-4-构建RabbitMQ死信队列消息模型"><a href="#6-3-4-构建RabbitMQ死信队列消息模型" class="headerlink" title="6.3.4 构建RabbitMQ死信队列消息模型"></a>6.3.4 构建RabbitMQ死信队列消息模型</h3><p>假设用户下单之后超时支付的时间为“10秒”</p>
<p>1、在RabbitmqConfig配置类中构建“用户下单支付超时”对应的死信队列消息模型</p>
<div class="hljs"><pre><code class="hljs java"><span class="hljs-comment">/**用户下单支付超时-RabbitMQ死信队列消息模型构建**/</span>

    <span class="hljs-comment">//创建死信队列</span>
    <span class="hljs-meta">@Bean</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> Queue <span class="hljs-title">orderDeadQueue</span><span class="hljs-params">()</span> </span>&#123;
        Map&lt;String, Object&gt; args = <span class="hljs-keyword">new</span> HashMap();
        args.put(<span class="hljs-string">"x-dead-letter-exchange"</span>, env.getProperty(<span class="hljs-string">"mq.order.dead.exchange.name"</span>));
        args.put(<span class="hljs-string">"x-dead-letter-routing-key"</span>, env.getProperty(<span class="hljs-string">"mq.order.dead.routing.key.name"</span>));

        <span class="hljs-comment">//设定TTL，单位为ms，在这里为了测试方便，设置为10s，当然实际业务场景可能为1h或者更长</span>
        args.put(<span class="hljs-string">"x-message-ttl"</span>, <span class="hljs-number">10000</span>);
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> Queue(env.getProperty(<span class="hljs-string">"mq.order.dead.queue.name"</span>), <span class="hljs-keyword">true</span>, <span class="hljs-keyword">false</span>, <span class="hljs-keyword">false</span>, args);
    &#125;

    <span class="hljs-comment">//创建“基本消息模型”的基本交换机 - 面向生产者</span>
    <span class="hljs-meta">@Bean</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> TopicExchange <span class="hljs-title">orderProducerExchange</span><span class="hljs-params">()</span> </span>&#123;
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> TopicExchange(env.getProperty(<span class="hljs-string">"mq.producer.order.exchange.name"</span>), <span class="hljs-keyword">true</span>, <span class="hljs-keyword">false</span>);
    &#125;

    <span class="hljs-comment">//创建“基本消息模型”的基本绑定-基本交换机+基本路由 - 面向生产者</span>
    <span class="hljs-meta">@Bean</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> Binding <span class="hljs-title">orderProducerBinding</span><span class="hljs-params">()</span> </span>&#123;
        <span class="hljs-keyword">return</span> BindingBuilder.bind(orderDeadQueue()).to(orderProducerExchange())
            .with(env.getProperty(<span class="hljs-string">"mq.producer.order.routing.key.name"</span>));
    &#125;

    <span class="hljs-comment">//创建真正队列 - 面向消费者</span>
    <span class="hljs-meta">@Bean</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> Queue <span class="hljs-title">realOrderConsumerQueue</span><span class="hljs-params">()</span> </span>&#123;
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> Queue(env.getProperty(<span class="hljs-string">"mq.consumer.order.real.queue.name"</span>), <span class="hljs-keyword">true</span>);
    &#125;

    <span class="hljs-comment">//创建死信交换机</span>
    <span class="hljs-meta">@Bean</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> TopicExchange <span class="hljs-title">basicOrderDeadExchange</span><span class="hljs-params">()</span> </span>&#123;
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> TopicExchange(env.getProperty(<span class="hljs-string">"mq.order.dead.exchange.name"</span>), <span class="hljs-keyword">true</span>, <span class="hljs-keyword">false</span>);
    &#125;

    <span class="hljs-comment">//创建死信路由及其绑定</span>
    <span class="hljs-meta">@Bean</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> Binding <span class="hljs-title">basicOrderDeadBinding</span><span class="hljs-params">()</span> </span>&#123;
        <span class="hljs-keyword">return</span> BindingBuilder.bind(realOrderConsumerQueue()).to(basicOrderDeadExchange())
            .with(env.getProperty(<span class="hljs-string">"mq.order.dead.routing.key.name"</span>));
    &#125;</code></pre></div>

<p>读取的变量取值如下：</p>
<div class="hljs"><pre><code class="hljs properties"><span class="hljs-comment">#用户下单支付超时-死信队列消息模型</span>
<span class="hljs-comment">#定义死信队列名称</span>
<span class="hljs-meta">mq.order.dead.queue.name</span>=<span class="hljs-string">$&#123;mq.env&#125;.middleware.order.dead.queue</span>
<span class="hljs-comment">#定义交换机名称</span>
<span class="hljs-meta">mq.order.dead.exchange.name</span>=<span class="hljs-string">$&#123;mq.env&#125;.middleware.order.dead.exchange</span>
<span class="hljs-comment">#定义死信路由名称</span>
<span class="hljs-meta">mq.order.dead.routing.key.name</span>=<span class="hljs-string">$&#123;mq.env&#125;.middleware.order.dead.routing.key</span>
<span class="hljs-comment">#定义基本交换机名称</span>
<span class="hljs-meta">mq.producer.order.exchange.name</span>=<span class="hljs-string">$&#123;mq.env&#125;.middleware.order.basic.exchange</span>
<span class="hljs-comment">#定义基本路由名称</span>
<span class="hljs-meta">mq.producer.order.routing.key.name</span>=<span class="hljs-string">$&#123;mq.env&#125;.middleware.order.basic.routing.key</span>
<span class="hljs-comment">#定义真正队列名称</span>
<span class="hljs-meta">mq.consumer.order.real.queue.name</span>=<span class="hljs-string">$&#123;mq.env&#125;.middleware.consumer.order.real.queue</span></code></pre></div>

<p>2、运行项目，在浏览器地址栏中输入<a href="http://127.0.0.1.15672，查看该消息模型对应的“死信队列”和“真正的队列”信息" target="_blank" rel="noopener">http://127.0.0.1.15672，查看该消息模型对应的“死信队列”和“真正的队列”信息</a></p>
<h3 id="6-3-5-Controller层开发用户下单及订单失效功能"><a href="#6-3-5-Controller层开发用户下单及订单失效功能" class="headerlink" title="6.3.5 Controller层开发用户下单及订单失效功能"></a>6.3.5 Controller层开发用户下单及订单失效功能</h3><p>Controller层指应用系统针对指定的业务模块开发相关的业务逻辑处理代码，包括接收用户前端请求的控制层、处理核心业务逻辑的服务层及提供额外服务的中间件处理层。</p>
<p>1、开发用于接受并处理用户前端请求的控制层UserOrderController，主要用于接收前端用户下单时的相关信息</p>
<div class="hljs"><pre><code class="hljs java"><span class="hljs-meta">@RestController</span>
<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">UserOrderController</span> </span>&#123;
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> Logger log = LoggerFactory.getLogger(UserOrderController<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
    <span class="hljs-comment">//定义请求前缀</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> String prefix = <span class="hljs-string">"user/order"</span>;
    <span class="hljs-comment">/**</span>
<span class="hljs-comment">     * 用户下单处理服务实例</span>
<span class="hljs-comment">     */</span>
    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> DeadUserOrderService deadUserOrderService;
    <span class="hljs-comment">/**</span>
<span class="hljs-comment">     * 用户下单请求的接收和处理</span>
<span class="hljs-comment">     */</span>
    <span class="hljs-meta">@RequestMapping</span>(value = prefix+<span class="hljs-string">"/push"</span>,method = RequestMethod.POST,
    consumes = MediaType.APPLICATION_JSON_UTF8_VALUE)
    <span class="hljs-function"><span class="hljs-keyword">public</span> BaseResponse <span class="hljs-title">login</span><span class="hljs-params">(@RequestBody @Validated UserOrderDto dto, BindingResult result)</span></span>&#123;
        <span class="hljs-comment">//判断请求参数的合法性</span>
        <span class="hljs-keyword">if</span>(result.hasErrors())&#123;
            <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> BaseResponse(StatusCode.InvalidParams);
        &#125;
        <span class="hljs-comment">//定义响应结果实例</span>
        BaseResponse response = <span class="hljs-keyword">new</span> BaseResponse(StatusCode.Success);
        <span class="hljs-keyword">try</span> &#123;
            <span class="hljs-comment">//调用Service层真正处理用户下单的业务逻辑</span>
            deadUserOrderService.pushUserOrder(dto);
        &#125;<span class="hljs-keyword">catch</span> (Exception e)&#123;
            <span class="hljs-comment">//Service层在处理的过程中如果发生异常，</span>
            <span class="hljs-comment">//则抛出异常并被Controller层捕获返回给前端用户</span>
            response = <span class="hljs-keyword">new</span> BaseResponse(StatusCode.Fail.getCode(),e.getMessage());
        &#125;
        <span class="hljs-keyword">return</span> response;
    &#125;
&#125;</code></pre></div>

<p>2、UserOrderDto实体类用于接收前端用户下单时提交的信息。</p>
<div class="hljs"><pre><code class="hljs java"><span class="hljs-meta">@Data</span>
<span class="hljs-meta">@ToString</span>
<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">UserOrderDto</span> </span>&#123;
    <span class="hljs-meta">@NotBlank</span>
    <span class="hljs-keyword">private</span> String orderNo;
    <span class="hljs-meta">@NotNull</span>
    <span class="hljs-keyword">private</span> Integer userId;
&#125;</code></pre></div>

<p>3、DeadUserOrderService类，主要包含两大核心功能，即“用户下单”功能和“更新用户下单记录的状态”功能</p>
<div class="hljs"><pre><code class="hljs java"><span class="hljs-meta">@Service</span>
<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">DeadUserOrderService</span> </span>&#123;
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> Logger log = LoggerFactory.getLogger(DeadUserOrderService<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
    <span class="hljs-comment">/**定义用户下单操作Mapper*/</span>
    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> UserOrderMapper userOrderMapper;
    <span class="hljs-comment">/**定义更新失效用户下单记录状态Mapper*/</span>
    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> MqOrderMapper mqOrderMapper;
    <span class="hljs-comment">/**</span>
<span class="hljs-comment">     * 用户下单-将生成的下单记录id压入死信队列中等待延迟处理</span>
<span class="hljs-comment">     * <span class="hljs-doctag">@param</span> userOrderDto</span>
<span class="hljs-comment">     */</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">pushUserOrder</span><span class="hljs-params">(UserOrderDto userOrderDto)</span></span>&#123;
        <span class="hljs-comment">//创建用户下单实例</span>
        UserOrder userOrder = <span class="hljs-keyword">new</span> UserOrder();
        <span class="hljs-comment">//复制userOrderDto对应的字段取值到新的实例对象userOrder中</span>
        BeanUtils.copyProperties(userOrderDto,userOrder);
        <span class="hljs-comment">//设置支付状态为已保存</span>
        userOrder.setStatus(<span class="hljs-number">1</span>);
        <span class="hljs-comment">//设置下单时间</span>
        userOrder.setCreateTime(<span class="hljs-keyword">new</span> Date());
        <span class="hljs-comment">//插入用户下单记录</span>
        userOrderMapper.insertSelective(userOrder);
        log.info(<span class="hljs-string">"用户成功下单，下单信息为“&#123;&#125;"</span>,userOrder);
    &#125;

    <span class="hljs-comment">/**</span>
<span class="hljs-comment">     * 更新用户下单记录的状态</span>
<span class="hljs-comment">     */</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">updateUserOrderRecord</span><span class="hljs-params">(UserOrder userOrder)</span></span>&#123;
        <span class="hljs-keyword">try</span> &#123;
            <span class="hljs-comment">//判断用户下单记录实体是否为null</span>
            <span class="hljs-keyword">if</span>(userOrder != <span class="hljs-keyword">null</span>)&#123;
                <span class="hljs-comment">//更新失效用户下单记录</span>
                userOrder.setIsActive(<span class="hljs-number">0</span>);
                <span class="hljs-comment">//设置失效时进行更新的时间</span>
                userOrder.setUpdateTime(<span class="hljs-keyword">new</span> Date());
                <span class="hljs-comment">//更新下单记录实体信息</span>
                userOrderMapper.updateByPrimaryKeySelective(userOrder);
                
                <span class="hljs-comment">//记录“失效用户下单记录”的历史</span>
                <span class="hljs-comment">//定义Rabbitmq死信队列历史失效记录实例</span>
                MqOrder mqOrder = <span class="hljs-keyword">new</span> MqOrder();;
                <span class="hljs-comment">//设置失效时间</span>
                mqOrder.setBusinessTime(<span class="hljs-keyword">new</span> Date());
                <span class="hljs-comment">//设置备注信息</span>
                mqOrder.setMemo(<span class="hljs-string">"更新失效当前用户下单记录Id,orderId="</span>+userOrder.getId());
                <span class="hljs-comment">//设置下单记录id</span>
                mqOrder.setOrderId(userOrder.getId());
                <span class="hljs-comment">//插入失效记录</span>
                mqOrderMapper.insertSelective(mqOrder);
            &#125;
        &#125;<span class="hljs-keyword">catch</span> (Exception e)&#123;
            log.error(<span class="hljs-string">"用户下单支付超时-处理服务-更新用户下单记录的状态发生异常："</span>,e.fillInStackTrace());
        &#125;
    &#125;
&#125;</code></pre></div>

<p>4、运行项目，打开Postman，在地址栏中输入“访问用户下单”的请求链接<a href="http://127.0.0.1:8087/middleware/user/order/push，请求方式为Post，并选择请求体的数据格式为JSON，请求体的数据如下：" target="_blank" rel="noopener">http://127.0.0.1:8087/middleware/user/order/push，请求方式为Post，并选择请求体的数据格式为JSON，请求体的数据如下：</a></p>
<div class="hljs"><pre><code class="hljs json">&#123;
	<span class="hljs-attr">"orderNo"</span>:<span class="hljs-number">201190411001</span>,
	<span class="hljs-attr">"userId"</span>:<span class="hljs-number">10010</span>
&#125;</code></pre></div>

<p>此时Postman得到了“成功”的响应结果，并且用户下单记录已经成功存储至数据表中。</p>
<h3 id="6-3-6-“用户下单支付超时”延迟发送接收实战"><a href="#6-3-6-“用户下单支付超时”延迟发送接收实战" class="headerlink" title="6.3.6 “用户下单支付超时”延迟发送接收实战"></a>6.3.6 “用户下单支付超时”延迟发送接收实战</h3><p>1、开发生产者</p>
<div class="hljs"><pre><code class="hljs java"><span class="hljs-meta">@Component</span>
<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">DeadOrderPublisher</span> </span>&#123;
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> Logger log = LoggerFactory.getLogger(DeadOrderPublisher<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
    <span class="hljs-comment">/**定义读取环境变量实例*/</span>
    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> Environment env;
    <span class="hljs-comment">/**定义RabbitMQ操作组件*/</span>
    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> RabbitTemplate rabbitTemplate;
    <span class="hljs-comment">/**定义JSON序列化和反序列化组件实例*/</span>
    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> ObjectMapper objectMapper;
    <span class="hljs-comment">/**</span>
<span class="hljs-comment">     * 将用户下单记录id充当消息发送给死信队列</span>
<span class="hljs-comment">     */</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">sendMsg</span><span class="hljs-params">(Integer orderId)</span></span>&#123;
        <span class="hljs-keyword">try</span> &#123;
            <span class="hljs-comment">//设置消息的传输格式-JSON</span>
            rabbitTemplate.setMessageConverter(<span class="hljs-keyword">new</span> Jackson2JsonMessageConverter());
            <span class="hljs-comment">//设置基本交换机</span>
            rabbitTemplate.setExchange(env.getProperty(<span class="hljs-string">"mq.producer.order.exchange.name"</span>));
            <span class="hljs-comment">//设置基本路由</span>
            rabbitTemplate.setRoutingKey(env.getProperty(<span class="hljs-string">"mq.producer.order.routing.key.name"</span>));
            <span class="hljs-comment">//发送对象类型的消息</span>
            rabbitTemplate.convertAndSend(orderId, <span class="hljs-keyword">new</span> MessagePostProcessor() &#123;
                <span class="hljs-meta">@Override</span>
                <span class="hljs-function"><span class="hljs-keyword">public</span> Message <span class="hljs-title">postProcessMessage</span><span class="hljs-params">(Message message)</span> <span class="hljs-keyword">throws</span> AmqpException </span>&#123;
                    <span class="hljs-comment">//获取消息属性对象</span>
                    MessageProperties messageProperties = message.getMessageProperties();
                    <span class="hljs-comment">//设置消息的持久化策略</span>
                    messageProperties.setDeliveryMode(MessageDeliveryMode.PERSISTENT);
                    <span class="hljs-comment">//设置消息头，即直接指定发送的消息所属的对象类型</span>
                    messageProperties.setHeader(AbstractJavaTypeMapper.DEFAULT_CONTENT_CLASSID_FIELD_NAME,Integer<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
                    <span class="hljs-comment">//返回消息实例</span>
                    <span class="hljs-keyword">return</span> message;
                &#125;
            &#125;);
            <span class="hljs-comment">//打印日志</span>
            log.info(<span class="hljs-string">"用户下单支付超时-发送用户下单记录id的消息入死信队列-内容为:orderId=&#123;&#125; "</span>,orderId);
        &#125;<span class="hljs-keyword">catch</span> (Exception e)&#123;
            log.error(<span class="hljs-string">"用户下单支付超时-发送用户下单记录id的消息入死信队列-发生异常：orderId=&#123;&#125; "</span>,orderId,e.fillInStackTrace());
        &#125;
    &#125;
&#125;</code></pre></div>

<p>2、开发消费者</p>
<div class="hljs"><pre><code class="hljs java"><span class="hljs-meta">@Component</span>
<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">DeadOrderConsumer</span> </span>&#123;
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> Logger log = LoggerFactory.getLogger(DeadOrderConsumer<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
    <span class="hljs-comment">/**定义JSON序列化和反序列化组件*/</span>
    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> ObjectMapper objectMapper;
    <span class="hljs-comment">/**定义用户下单操作Mapper*/</span>
    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> UserOrderMapper userOrderMapper;
    <span class="hljs-comment">/**用户下单支付超时-处理服务实例*/</span>
    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> DeadUserOrderService deadUserOrderService;
    <span class="hljs-comment">/**用户下单支付超时消息模型-监听真正的队列*/</span>
    <span class="hljs-meta">@RabbitListener</span>(queues = <span class="hljs-string">"$&#123;mq.consumer.order.real.queue.name&#125;"</span>,containerFactory = <span class="hljs-string">"singleListenerContainer"</span>)
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">consumeMsg</span><span class="hljs-params">(@Payload Integer orderId)</span></span>&#123;
        <span class="hljs-keyword">try</span> &#123;
            log.info(<span class="hljs-string">"用户下单支付超时消息模型-监听真正的队列-监听到消息内容为：orderId=&#123;&#125;"</span>,orderId);
            <span class="hljs-comment">//<span class="hljs-doctag">TODO:</span>接下来是执行核心的业务逻辑</span>
            <span class="hljs-comment">//查询该用户下单记录id对应的支付状态是否为“已保存”</span>
            UserOrder userOrder = userOrderMapper.selectByIdAndStatus(orderId,<span class="hljs-number">1</span>);
            <span class="hljs-keyword">if</span>(userOrder != <span class="hljs-keyword">null</span>)&#123;
                <span class="hljs-comment">//不等于null，则代表该用户下单记录仍然为“已保存”状态，即该用户已经超时，</span>
                <span class="hljs-comment">// 没支付该笔订单，因而需要失效该笔下单价记录</span>
                deadUserOrderService.updateUserOrderRecord(userOrder);
            &#125;
        &#125;<span class="hljs-keyword">catch</span> (Exception e)&#123;
            log.error(<span class="hljs-string">"用户下单支付超时消息模型-监听真正队列-发生异常：orderId=&#123;&#125;"</span>
                    ,orderId,e.fillInStackTrace());
        &#125;
    &#125;
&#125;</code></pre></div>

<p>3、在用户下单服务DeadUserOrderService类的pushUserOrder方法中，加入死信队列生产者“发送订单记录id”的方法调用</p>
<div class="hljs"><pre><code class="hljs java"><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">pushUserOrder</span><span class="hljs-params">(UserOrderDto userOrderDto)</span></span>&#123;
        <span class="hljs-comment">//创建用户下单实例</span>
        UserOrder userOrder = <span class="hljs-keyword">new</span> UserOrder();
        <span class="hljs-comment">//复制userOrderDto对应的字段取值到新的实例对象userOrder中</span>
        BeanUtils.copyProperties(userOrderDto,userOrder);
        <span class="hljs-comment">//设置支付状态为已保存</span>
        userOrder.setStatus(<span class="hljs-number">1</span>);
        <span class="hljs-comment">//设置下单时间</span>
        userOrder.setCreateTime(<span class="hljs-keyword">new</span> Date());
        <span class="hljs-comment">//插入用户下单记录</span>
        userOrderMapper.insertSelective(userOrder);
        log.info(<span class="hljs-string">"用户成功下单，下单信息为“&#123;&#125;"</span>,userOrder);
        
        <span class="hljs-comment">//生成用户下单记录id</span>
        Integer orderId = userOrder.getId();
        <span class="hljs-comment">//将生成的用户下单记录id压入死信队列中等待延迟处理</span>
        deadOrderPublisher.sendMsg(orderId);
    &#125;</code></pre></div>

<h3 id="6-3-7-“用户下单支付超时”整体功能自测"><a href="#6-3-7-“用户下单支付超时”整体功能自测" class="headerlink" title="6.3.7 “用户下单支付超时”整体功能自测"></a>6.3.7 “用户下单支付超时”整体功能自测</h3><p>1、打开postman，在地址栏中输入“访问用户下单”的请求链接<a href="http://127.0.0.1:8087/middleware/user/order/push，请求方式为Post，并选择请求体的数据格式为JSON，请求体的数据如下：" target="_blank" rel="noopener">http://127.0.0.1:8087/middleware/user/order/push，请求方式为Post，并选择请求体的数据格式为JSON，请求体的数据如下：</a></p>
<div class="hljs"><pre><code class="hljs json">&#123;
	<span class="hljs-attr">"orderNo"</span>:<span class="hljs-number">201190412001</span>,
	<span class="hljs-attr">"userId"</span>:<span class="hljs-number">10011</span>
&#125;</code></pre></div>

<p>表示当前用户id为10011，购物车对应的订单编号为20190412001，单击Send按钮。</p>
<h1 id="第7章-分布式锁实战"><a href="#第7章-分布式锁实战" class="headerlink" title="第7章 分布式锁实战"></a>第7章 分布式锁实战</h1><h2 id="7-1-分布式锁概念"><a href="#7-1-分布式锁概念" class="headerlink" title="7.1 分布式锁概念"></a>7.1 分布式锁概念</h2><p>集群、分布式部署的服务实例一般是部署在不同机器上，此种资源共享将不再是传统的线程共享，而是跨JVM进程之间资源的共享。</p>
<h3 id="7-1-1-锁机制"><a href="#7-1-1-锁机制" class="headerlink" title="7.1.1 锁机制"></a>7.1.1 锁机制</h3><p>共享资源：指可以被多个线程、进程同时访问并进行操作的数据或者代码块。</p>
<div class="hljs"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">LockOne</span> </span>&#123;
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> Logger log = LoggerFactory.getLogger(LockOne<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> </span>&#123;
        <span class="hljs-comment">//创建存钱线程实例</span>
        Thread tAdd = <span class="hljs-keyword">new</span> Thread(<span class="hljs-keyword">new</span> LockThread(<span class="hljs-number">100</span>));
        <span class="hljs-comment">//创建取钱线程实例</span>
        Thread tSub = <span class="hljs-keyword">new</span> Thread(<span class="hljs-keyword">new</span> LockThread(-<span class="hljs-number">100</span>));
        <span class="hljs-comment">//开启存钱线程的操作</span>
        tAdd.start();
        <span class="hljs-comment">//开启取钱线程的操作</span>
        tSub.start();
    &#125;
&#125;
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">LockThread</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">Runnable</span></span>&#123;
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> Logger log = LoggerFactory.getLogger(LockThread<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
    <span class="hljs-comment">/**定义成员变量-用于接收线程初始化时提供的金额-代表取/存的金额*/</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">int</span> count;

    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">LockThread</span><span class="hljs-params">(<span class="hljs-keyword">int</span> count)</span> </span>&#123;
        <span class="hljs-keyword">this</span>.count = count;
    &#125;

    <span class="hljs-meta">@Override</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">run</span><span class="hljs-params">()</span> </span>&#123;
        <span class="hljs-keyword">try</span> &#123;
            <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">10</span>; i++) &#123;
                <span class="hljs-comment">//通过传进来的金额（可正、可负）执行叠加操作</span>
                SysConstant.amount = SysConstant.amount + count;
                log.info(<span class="hljs-string">"此时账户余额为：&#123;&#125;"</span>,SysConstant.amount);
            &#125;
        &#125;<span class="hljs-keyword">catch</span> (Exception e)&#123;
            e.printStackTrace();
        &#125;
    &#125;
&#125;</code></pre></div>

<p>其中，SysConstant为存放共享变量的系统常量类</p>
<div class="hljs"><pre><code class="hljs angelscript"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-symbol">SysConstant</span> &#123;
    <span class="hljs-keyword">public</span> static Integer amount = <span class="hljs-number">500</span>;
&#125;</code></pre></div>



<p>未完…待定~</p>

            </article>
            <hr>
            <div>
              <div class="post-metas mb-3">
                
                  <div class="post-meta mr-3">
                    <i class="iconfont icon-category"></i>
                    
                      <a class="hover-with-bg" href="/categories/%E5%BE%AE%E6%9C%8D%E5%8A%A1%E5%88%86%E5%B8%83%E5%BC%8F%E6%9E%B6%E6%9E%84/">微服务分布式架构</a>
                    
                  </div>
                
                
                  <div class="post-meta">
                    <i class="iconfont icon-tags"></i>
                    
                      <a class="hover-with-bg" href="/tags/%E4%B8%AD%E9%97%B4%E4%BB%B6/">中间件</a>
                    
                  </div>
                
              </div>
              
                <p class="note note-warning">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-sa/4.0/deed.zh" target="_blank" rel="nofollow noopener noopener">CC BY-SA 4.0 协议</a> ，转载请注明出处！</p>
              
              
                <div class="post-prevnext row">
                  <div class="post-prev col-6">
                    
                    
                      <a href="/2021/05/30/%E5%88%86%E5%B8%83%E5%BC%8F%E4%B8%AD%E9%97%B4%E4%BB%B6%E6%8A%80%E6%9C%AF%E5%AE%9E%E6%88%98/">
                        <i class="iconfont icon-arrowleft"></i>
                        <span class="hidden-mobile">分布式中间件技术实战</span>
                        <span class="visible-mobile">上一篇</span>
                      </a>
                    
                  </div>
                  <div class="post-next col-6">
                    
                    
                      <a href="/2021/05/30/%E7%A8%8B%E5%BA%8F%E5%91%98%E9%AB%98%E6%95%88%E5%BC%80%E5%8F%91%E6%89%8B%E5%86%8C/">
                        <span class="hidden-mobile">程序员高效开发手册</span>
                        <span class="visible-mobile">下一篇</span>
                        <i class="iconfont icon-arrowright"></i>
                      </a>
                    
                  </div>
                </div>
              
            </div>

            
              <!-- Comments -->
              <div class="comments" id="comments">
                
                
  <script defer src="https://utteranc.es/client.js"
          repo="gavin-yyj/commit-utterance"
          issue-term="pathname"
  
          theme="github-light"
          crossorigin="anonymous"
  >
  </script>


              </div>
            
          </div>
        </div>
      </div>
    </div>
    
      <div class="d-none d-lg-block col-lg-2 toc-container" id="toc-ctn">
        <div id="toc">
  <p class="toc-header"><i class="iconfont icon-list"></i>&nbsp;目录</p>
  <div id="tocbot"></div>
</div>

      </div>
    
  </div>
</div>

<!-- Custom -->


    
  </main>

  
    <a id="scroll-top-button" href="#" role="button">
      <i class="iconfont icon-arrowup" aria-hidden="true"></i>
    </a>
  

  
    <div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel"
     aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header text-center">
        <h4 class="modal-title w-100 font-weight-bold">搜索</h4>
        <button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body mx-3">
        <div class="md-form mb-5">
          <input type="text" id="local-search-input" class="form-control validate">
          <label data-error="x" data-success="v"
                 for="local-search-input">关键词</label>
        </div>
        <div class="list-group" id="local-search-result"></div>
      </div>
    </div>
  </div>
</div>
  

  

  

  <footer class="mt-5">
  <div class="text-center py-3">
    <div>
      <a href="https://hexo.io" target="_blank" rel="nofollow noopener"><span>Hexo</span></a>
      <i class="iconfont icon-love"></i>
      <a href="https://github.com/fluid-dev/hexo-theme-fluid" target="_blank" rel="nofollow noopener">
        <span>Fluid</span></a>
    </div>
    

    

    
  </div>
</footer>

<!-- SCRIPTS -->
<script  src="https://cdn.staticfile.org/jquery/3.4.1/jquery.min.js" ></script>
<script  src="https://cdn.staticfile.org/twitter-bootstrap/4.4.1/js/bootstrap.min.js" ></script>
<script  src="/js/debouncer.js" ></script>
<script  src="/js/main.js" ></script>

<!-- Plugins -->


  
    <script  src="/js/lazyload.js" ></script>
  



  <script defer src="https://cdn.staticfile.org/clipboard.js/2.0.6/clipboard.min.js" ></script>
  <script  src="/js/clipboard-use.js" ></script>







  <script  src="https://cdn.staticfile.org/tocbot/4.11.1/tocbot.min.js" ></script>
  <script>
    $(document).ready(function () {
      var boardCtn = $('#board-ctn');
      var boardTop = boardCtn.offset().top;

      tocbot.init({
        tocSelector: '#tocbot',
        contentSelector: '.post-content',
        headingSelector: 'h1,h2,h3,h4,h5,h6',
        linkClass: 'tocbot-link',
        activeLinkClass: 'tocbot-active-link',
        listClass: 'tocbot-list',
        isCollapsedClass: 'tocbot-is-collapsed',
        collapsibleClass: 'tocbot-is-collapsible',
        collapseDepth: 0,
        scrollSmooth: true,
        headingsOffset: -boardTop
      });
      if ($('.toc-list-item').length > 0) {
        $('#toc').css('visibility', 'visible');
      }
    });
  </script>



  <script  src="https://cdn.staticfile.org/typed.js/2.0.11/typed.min.js" ></script>
  <script>
    var typed = new Typed('#subtitle', {
      strings: [
        '  ',
        "分布式中间件技术实战篇&nbsp;",
      ],
      cursorChar: "_",
      typeSpeed: 70,
      loop: false,
    });
    typed.stop();
    $(document).ready(function () {
      $(".typed-cursor").addClass("h2");
      typed.start();
    });
  </script>



  <script  src="https://cdn.staticfile.org/anchor-js/4.2.2/anchor.min.js" ></script>
  <script>
    anchors.options = {
      placement: "right",
      visible: "hover",
      
    };
    var el = "h1,h2,h3,h4,h5,h6".split(",");
    var res = [];
    for (item of el) {
      res.push(".markdown-body > " + item)
    }
    anchors.add(res.join(", "))
  </script>



  <script  src="/js/local-search.js" ></script>
  <script>
    var path = "/local-search.xml";
    var inputArea = document.querySelector("#local-search-input");
    inputArea.onclick = function () {
      searchFunc(path, 'local-search-input', 'local-search-result');
      this.onclick = null
    }
  </script>



  <script  src="https://cdn.staticfile.org/fancybox/3.5.7/jquery.fancybox.min.js" ></script>
  <link  rel="stylesheet" href="https://cdn.staticfile.org/fancybox/3.5.7/jquery.fancybox.min.css" />

  <script>
    $('#post img:not(.no-zoom img, img[no-zoom]), img[zoom]').each(
      function () {
        var element = document.createElement('a');
        $(element).attr('data-fancybox', 'images');
        $(element).attr('href', $(this).attr('src'));
        $(this).wrap(element);
      }
    );
  </script>







  
  
    <script type="text/javascript">
      //定义获取词语下标
      var a_idx = 0;
      jQuery(document).ready(function ($) {
        //点击body时触发事件
        $("body").click(function (e) {
          //需要显示的词语
          var a = new Array("富强", "民主", "文明", "和谐", "自由", "平等", "公正", "法治", "爱国", "敬业", "诚信", "友善");
          //设置词语给span标签
          var $i = $("<span/>").text(a[a_idx]);
          //下标等于原来下标+1  余 词语总数
          a_idx = (a_idx + 1) % a.length;
          //获取鼠标指针的位置，分别相对于文档的左和右边缘。
          //获取x和y的指针坐标
          var x = e.pageX, y = e.pageY;
          //在鼠标的指针的位置给$i定义的span标签添加css样式
          $i.css({
            "z-index": 999,
            "top": y - 20,
            "left": x,
            "position": "absolute",
            "font-weight": "bold",
            "color": rand_color()
          });
          // 随机颜色
          function rand_color() {
            return "rgb(" + ~~(255 * Math.random()) + "," + ~~(255 * Math.random()) + "," + ~~(255 * Math.random()) + ")"
          }
          //在body添加这个标签
          $("body").append($i);
          //animate() 方法执行 CSS 属性集的自定义动画。
          //该方法通过CSS样式将元素从一个状态改变为另一个状态。CSS属性值是逐渐改变的，这样就可以创建动画效果。
          //详情请看http://www.w3school.com.cn/jquery/effect_animate.asp
          $i.animate({
            //将原来的位置向上移动180
            "top": y - 180,
            "opacity": 0
            //1500动画的速度
          }, 1500, function () {
            //时间到了自动删除
            $i.remove();
          });
        });
      })
      ;
    </script>
  














</body>
</html>
